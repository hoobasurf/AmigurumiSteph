<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// ====== INIT SUPABASE ======
const supabase = createClient(
  "https://jyhbamdcxmpveujjqjla.supabase.co",
  "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa"
);

// ====== ELEMENTS ======
const ownerImg = document.getElementById('ownerPhoto');
const container = document.getElementById('visitor-list-container');
const addModal = document.getElementById('addModal');
const deleteModal = document.getElementById('deleteModal');
const zoomModal = document.getElementById('zoomModal');
const mainZoom = document.getElementById('mainZoom');
const thumbs = document.getElementById('thumbs');
const likeCount = document.getElementById('likeCount');
const commentCount = document.getElementById('commentCount');

const likeModal = document.getElementById('likeModal');
const likeBubbles = document.getElementById('likeBubbles');
const confirmLike = document.getElementById('confirmLike');
const likeNameInput = document.getElementById('likeName');

const commentModal = document.getElementById('commentModal');
const confirmComment = document.getElementById('confirmComment');
const commentBubbles = document.getElementById('commentBubbles');

const sidebar = document.getElementById('sidebar');
const addBtn = document.getElementById('addBtn');
const expandBtn = document.getElementById('expandComment');
const commentBox = document.querySelector('.comment-box');

let creations = [];
let currentZoom = null;
let currentDelete = null;

// ====== UTILISATEUR CONNECTÉ ======
let currentUser = {
  prenom: localStorage.getItem('prenom') || '',
  photo: localStorage.getItem('photo') || ''
};

// ====== AFFICHAGE PHOTO DE LA PAGE D'ACCUEIL ======
document.addEventListener('DOMContentLoaded', () => {
  if(currentUser.photo){
    ownerImg.src = currentUser.photo;
    ownerImg.style.display = 'block';
  }
});

// ====== RENDER DES CRÉATIONS ======
function render() {
  container.innerHTML = '';
  let page = null;
  creations.forEach((c, i) => {
    if (i % 6 === 0) {
      page = document.createElement('div');
      page.className = 'page';
      container.appendChild(page);
    }

    const d = document.createElement('div');
    d.className = 'visitor-item';
    d.innerHTML = `
      <div class="placeholder">?</div>
      <div class="delete-btn">×</div>
      <p>${c.name}</p>
      <img src="${c.imgUrl || ''}">
    `;

    const img = d.querySelector('img');
    img.onload = () => d.querySelector('.placeholder').style.display = 'none';
    img.onerror = () => img.style.display = 'none';
    img.onclick = () => openZoom(c);

    d.querySelector('.delete-btn').onclick = () => openDeleteModal(c);

    page.appendChild(d);
  });
}

// ====== ZOOM ======
function openZoom(c){
  currentZoom = c;
  mainZoom.src = c.imgUrl;
  thumbs.innerHTML = '';
  if(!c.zoomGroup || c.zoomGroup.length===0) c.zoomGroup=[c.imgUrl];
  c.zoomGroup.forEach(u=>{
    const t=document.createElement('img');
    t.src=u;
    t.onclick=()=>mainZoom.src=u;
    thumbs.appendChild(t);
  });
  updateActions();
  zoomModal.style.display='flex';
}
function updateActions(){
  likeCount.textContent = currentZoom.likes?.length||0;
  commentCount.textContent = currentZoom.comments?.length||0;
}

// ====== LIKE ======
document.querySelector('.like-btn').onclick = () => {
  if (!currentZoom) return;
  likeBubbles.innerHTML = '';
  (currentZoom.likes || []).forEach(like => {
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    if (like.photo) {
      bubble.innerHTML = `<img src="${like.photo}" style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;"> ${like.name}`;
    } else {
      bubble.textContent = like.name;
    }
    likeBubbles.appendChild(bubble);
  });

  likeNameInput.value = currentUser.prenom || '';
  if(currentUser.prenom) likeNameInput.disabled = true;

  likeModal.style.display='flex';
};

confirmLike.onclick = async () => {
  if (!currentZoom) return;
  let name = currentUser.prenom || likeNameInput.value.trim();
  if(!name) return;
  if(!currentZoom.likes) currentZoom.likes=[];
  currentZoom.likes.push({name, photo: currentUser.photo || ''});
  try {
    await supabase.from('creations').update({likes: currentZoom.likes}).eq('id', currentZoom.id);
  } catch(err){ console.error(err); }
  renderLikeBubbles();
  likeModal.style.display='none';
};

function renderLikeBubbles(){
  likeBubbles.innerHTML='';
  currentZoom.likes.forEach(like=>{
    const bubble=document.createElement('div');
    bubble.className='bubble';
    bubble.innerHTML = like.photo ? `<img src="${like.photo}" style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;">${like.name}` : like.name;
    likeBubbles.appendChild(bubble);
  });
  updateActions();
}

// ====== COMMENT ======
document.querySelector('.comment-btn').onclick = () => {
  const commentNameInput = document.getElementById('commentName');
  commentNameInput.value = currentUser.prenom || '';
  if(currentUser.prenom) commentNameInput.disabled = true;
  if(!currentZoom) return;
  renderCommentList();
  document.getElementById('commentText').value='';
  commentModal.style.display='flex';
};

function renderCommentList(){
  commentBubbles.innerHTML='';
  (currentZoom.comments || []).forEach(c=>{
    const item = document.createElement('div');
    item.className='comment-item';
    const text = document.createElement('span');
    if(c.name===currentUser.prenom && currentUser.photo){
      text.innerHTML = `<img src="${currentUser.photo}" style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;"> <strong>${c.name}</strong>: <span>${c.text}</span>`;
    } else {
      text.innerHTML = `<strong>${c.name}</strong>: <span>${c.text}</span>`;
    }
    item.appendChild(text);
    commentBubbles.appendChild(item);
  });
  commentCount.textContent = currentZoom.comments?.length||0;
}

confirmComment.onclick = async () => {
  if(!currentZoom) return;
  const name = currentUser.prenom || document.getElementById('commentName').value.trim();
  const text = document.getElementById('commentText').value.trim();
  if(!name || !text) return;
  if(!currentZoom.comments) currentZoom.comments=[];
  currentZoom.comments.push({name, text, photo: currentUser.photo||''});
  await supabase.from('creations').update({comments: currentZoom.comments}).eq('id', currentZoom.id);
  renderCommentList();
  document.getElementById('commentText').value='';
};

// ====== DELETE ======
function openDeleteModal(project){ currentDelete=project; deleteModal.style.display='flex'; }
document.getElementById('cancelDelete').onclick = () => { currentDelete=null; deleteModal.style.display='none'; };
document.getElementById('confirmDelete').onclick = async () => {
  if(!currentDelete?.id) return;
  const {error} = await supabase.from('creations').delete().eq('id', currentDelete.id);
  if(error){ console.error(error); return; }
  await refreshCreations();
  deleteModal.style.display='none';
  currentDelete=null;
};

// ====== AJOUT ======
addBtn.onclick = () => { addModal.style.display='flex'; };
addModal.addEventListener('click', e=>{if(e.target===addModal)addModal.style.display='none';});
document.getElementById('confirmAdd').onclick = async (e) => {
  e.stopPropagation();
  const name = document.getElementById('photoName').value.trim();
  const files = document.getElementById('multiPhoto').files;
  if(!name || !files.length){ alert("Veuillez mettre un nom et sélectionner au moins une photo"); return; }
  const paths = [], urls = [];
  for(let file of files){
    const path = `${Date.now()}_${file.name}`;
    const {error:uploadError} = await supabase.storage.from('images').upload(path,file);
    if(uploadError){ console.error(uploadError); continue; }
    const {data:pubData} = supabase.storage.from('images').getPublicUrl(path);
    if(!pubData?.publicUrl) continue;
    urls.push(pubData.publicUrl); paths.push(path);
  }
  if(urls.length===0) return;
  const {data,error} = await supabase.from('creations').insert([{name,image_path:paths[0],images:paths,likes:[],comments:[]}]).select();
  if(error){ console.error(error); return; }
  addModal.style.display='none';
  document.getElementById('photoName').value='';
  document.getElementById('multiPhoto').value='';
  await refreshCreations();
};

// ====== REFRESH ======
async function refreshCreations(){
  const {data,error} = await supabase.from('creations').select('*').order('created_at',{ascending:false});
  if(error){ console.error(error); return; }
  creations = data.map(c=>{
    const zoomGroup = (c.images&&c.images.length)?c.images.map(p=>supabase.storage.from('images').getPublicUrl(p).data.publicUrl):[supabase.storage.from('images').getPublicUrl(c.image_path).data.publicUrl];
    return {id:c.id,name:c.name,imgUrl:zoomGroup[0],zoomGroup,likes:c.likes||[],comments:c.comments||[]};
  });
  render();
}

// ====== SIDEBAR ======
document.getElementById('toggleSidebar').onclick = () => sidebar.classList.toggle('sidebar-open');

// ====== MODAL COMMENT FULLSCREEN ======
expandBtn.onclick = (e) => {
  e.stopPropagation();
  commentBox.classList.toggle('fullscreen');
  expandBtn.textContent = commentBox.classList.contains('fullscreen') ? '⤡' : '⤢';
};

// ====== CLOSE MODALS ======
document.querySelector('.closeZoom').onclick = ()=> zoomModal.style.display='none';
zoomModal.onclick = e=>{ if(e.target===zoomModal) zoomModal.style.display='none'; };
likeModal.onclick = e=>{ if(e.target===likeModal) likeModal.style.display='none'; };
commentModal.onclick = e=>{ if(e.target===commentModal) commentModal.style.display='none'; };
deleteModal.onclick = e=>{ if(e.target===deleteModal) deleteModal.style.display='none'; currentDelete=null; };

// ====== START ======
document.addEventListener('DOMContentLoaded', async () => {
  await refreshCreations();
});
</script>
