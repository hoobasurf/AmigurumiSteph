<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="icon-152.png">
<meta name="theme-color" content="#f2b7c9">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
* { box-sizing:border-box;margin:0;padding:0;font-family:'Comic Sans MS',cursive; }
html,body{height:100%;overflow-x:hidden;}
body::before{
  content:"";position:fixed;top:0;left:0;width:100vw;height:100vh;
  background-image:url('Photoroom_20251223_114401.jpeg');
  background-size:cover;background-position:center center;background-repeat:no-repeat;z-index:-1;
}
.center-zone{display:flex;justify-content:center;align-items:flex-start;padding-top:3.5cm;overflow:hidden;height:auto;}
#visitor-list-container{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling: touch;justify-content:center;padding-left:1cm;}
.page{display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(3,1fr);column-gap:3mm;row-gap:4mm;flex:0 0 auto;width:calc(2*200px+3mm);height:calc(3*200px+8mm);scroll-snap-align:center;padding:4mm;justify-content:center;margin-top:0;}
.visitor-item{position:relative;width:200px;height:200px;border-radius:12px;overflow:hidden;border:3px solid #fff;box-shadow:0 0 0 3px #f6c2d1,0 6px 14px rgba(0,0,0,0.25),inset 0 0 0 1px rgba(255,255,255,0.4);background:#ffe6f0;}
.visitor-item .placeholder{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;font-size:24px;color:#b84c6f;font-weight:bold;}
.visitor-item img{width:100%;height:100%;object-fit:cover;border-radius:12px;cursor:pointer;display:block;filter:brightness(1.05) contrast(1.05) saturate(0.95);transition:filter 0.3s, transform 0.3s;position:relative;z-index:2;}
.visitor-item img:hover{transform:scale(1.03);}
.visitor-item::after{content:"";position:absolute;inset:0;background:rgba(255,230,240,0.12);pointer-events:none;z-index:1;}
.visitor-item p{position:absolute;bottom:2px;width:100%;font-size:14px;color:#b84c6f;font-weight:bold;text-align:center;text-shadow:1px 1px 2px rgba(255,255,255,0.8);z-index:3;}
.delete-btn{position:absolute;top:2px;right:2px;width:20px;height:20px;background:#ffb6c1;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;cursor:pointer;z-index:5;font-size:14px;transition: background 0.2s;}
.delete-btn:hover{background:#e94f9a;}

#sidebar{position:fixed;top:0;left:-220px;width:220px;height:100vh;background:rgba(255,230,240,0.2);border-right:2px solid #b67385;padding:20px;transition:left .3s;z-index:10;}
#sidebar.sidebar-open{left:0;}
#toggleSidebar{position:absolute;top:50%;right:-30px;width:30px;height:60px;background:#ffb6c1;border-radius:0 12px 12px 0;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;}
#sidebar button{width:auto;padding:8px 16px;border-radius:16px;border:none;background:#ffb6c1;color:#fff;cursor:pointer;font-weight:bold;display:block;margin-top:10px;}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:10001;}
.modal .modal-box{background:#ffe6f0;padding:16px 24px;border-radius:20px;border:3px solid #b67385;display:flex;flex-direction:column;gap:10px;align-items:center;min-width:200px;font-family:'Comic Sans MS',cursive;}
.modal input{padding:6px 12px;border-radius:10px;border:2px solid #b67385;width:100%;}
.modal button{padding:6px 14px;border:none;background:#ffb6c1;color:#fff;border-radius:12px;cursor:pointer;font-weight:bold;width:100%;}

#zoomModal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:10000;}
#zoomModal img{max-width:80%;max-height:60vh;border:4px solid #b67385;border-radius:24px;margin-bottom:10px;filter:none;}
#zoomModal .thumbs{display:flex;gap:8px;max-width:80%;overflow-x:auto;}
#zoomModal .thumbs img{width:50px;height:50px;object-fit:cover;border-radius:12px;border:2px solid #b67385;cursor:pointer;}
.closeZoom{position:absolute;top:12px;right:12px;width:28px;height:28px;background:#ffb6c1;color:#fff;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;}

#ownerPhoto{width:32px;height:32px;border-radius:50%;position:fixed;top:10px;right:10px;z-index:10000;background:#ffe6f0;border:2px solid #b84c6f;}
@media(max-width:480px){.page{grid-template-columns:repeat(2,120px);grid-template-rows:repeat(3,120px);}.visitor-item{width:120px;height:120px;}.modal .modal-box{min-width:180px;}}

.icon-btn svg {
  cursor: pointer;
  transition: transform 0.2s;
}
.icon-btn:hover svg {
  transform: scale(1.2);
}
.icon-btn span {
  font-weight: bold;
  color: #b84c6f;
  font-size: 14px;
}
</style>
</head>
<body>

<img id="ownerPhoto" alt="Owner">

<div class="center-zone">
  <div id="visitor-list-container"></div>
</div>

<div id="sidebar">
  <div id="toggleSidebar">‚ò∞</div>
  <button id="addBtn">Ajouter</button>
  <button id="pelotesBtn">Pelotes</button>
  <button id="videoBtn">Vid√©o</button>
  <button id="notesBtn">Notes</button>
  <button id="messagerieBtn">Messagerie</button>
  <button id="manageBtn" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:40px;height:40px;padding:0;border-radius:50%;display:flex;align-items:center;justify-content:center;">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="#ffb6c1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings">
    <circle cx="12" cy="12" r="3"/>
    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l0 0a2 2 0 1 1-2.83 2.83l0 0a1.65 1.65 0 0 0-1.82.33l0 0a1.65 1.65 0 0 0-.5 1.51l0 0a2 2 0 1 1-3.18 0l0 0a1.65 1.65 0 0 0-1.51-.5l0 0a1.65 1.65 0 0 0-.33-1.82l0 0a2 2 0 1 1 0-2.83l0 0a1.65 1.65 0 0 0 .33-1.82l0 0a1.65 1.65 0 0 0-1.51-.5l0 0a2 2 0 1 1 0-3.18l0 0a1.65 1.65 0 0 0 .5-1.51l0 0a1.65 1.65 0 0 0 1.82-.33l0 0a2 2 0 1 1 2.83 0l0 0a1.65 1.65 0 0 0 1.82.33l0 0a1.65 1.65 0 0 0 .5 1.51l0 0a2 2 0 1 1 3.18 0l0 0a1.65 1.65 0 0 0 1.51.5l0 0a1.65 1.65 0 0 0 .33 1.82l0 0a2 2 0 1 1 0 2.83l0 0a1.65 1.65 0 0 0-.33 1.82l0 0a1.65 1.65 0 0 0 1.51.5z"/>
  </svg>
</button>
</div>

<!-- Modals -->
<div id="addModal" class="modal">
  <div class="modal-box">
    <h2>Ajouter des photos</h2>
    <input id="photoName" placeholder="Nom du projet">
    <input type="file" id="multiPhoto" multiple>
    <button id="confirmAdd">Valider</button>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-box">
    <p>Supprimer d√©finitivement ce projet ?</p>
    <button id="confirmDelete">Oui</button>
    <button id="cancelDelete">Annuler</button>
  </div>
</div>

<!-- ====== LIKE MODAL ====== -->
<div id="likeModal" class="modal">
  <div class="modal-box">
    <h3>Like ‚ù§Ô∏è</h3>
    <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
      <img id="likeAvatar" src="" alt="Avatar" style="width:24px; height:24px; border-radius:50%; border:2px solid #b67385;">
      <input type="text" id="likeName" readonly style="flex:1; padding:4px 8px; border:2px solid #b67385; border-radius:8px; background:#ffe6f0;">
    </div>
    <button id="confirmLike">Valider</button>
    <div class="bubble-container" id="likeBubbles" style="margin-top:12px; max-height:120px; overflow-y:auto;"></div>
  </div>
</div>

<!-- ====== COMMENT MODAL ====== -->
<div id="commentModal" class="modal">
  <div class="modal-box comment-box">
    <div class="expand-btn" id="expandComment">‚§¢</div>
    <h3>Commentaire üí¨</h3>
    <div class="comment-list" id="commentBubbles" style="max-height:160px; overflow-y:auto; margin-bottom:8px;"></div>
    <div style="display:flex; flex-direction:column; gap:6px;">
      <input type="text" id="commentName" readonly style="flex:1; padding:4px 8px; border:2px solid #b67385; border-radius:8px; background:#ffe6f0; margin-bottom:8px;">
      <input type="text" id="commentText" placeholder="Votre commentaire" style="padding:4px 8px; border:2px solid #b67385; border-radius:8px;">
      <button id="confirmComment">Envoyer</button>
    </div>
  </div>
</div>

<div id="zoomModal">
  <div class="closeZoom">√ó</div>
  <img id="mainZoom">
  <div class="thumbs" id="thumbs"></div>
  <div class="actions">
    <div class="actions" style="display:flex; gap:12px; align-items:center; margin-top:8px;">
  <div class="icon-btn" id="likeBtn" style="display:flex; align-items:center; cursor:pointer; gap:4px;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#b84c6f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 21C12 21 4 13.5 4 8.5C4 5.5 6.5 3 9.5 3C11 3 12 4 12 4C12 4 13 3 14.5 3C17.5 3 20 5.5 20 8.5C20 13.5 12 21 12 21Z"></path>
    </svg>
    <span id="likeCount">0</span>
  </div>

  <div class="icon-btn" id="commentBtn" style="display:flex; align-items:center; cursor:pointer; gap:4px;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#b84c6f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span id="commentCount">0</span>
  </div>
</div>
  </div>
</div>

<!-- Modal Gestion -->
<div id="manageModal" class="modal">
  <div class="modal-box">
    <h2>Gestion Likes, Commentaires</h2>
    <button id="manageLikesBtn">Likes</button>
    <button id="manageCommentsBtn">Commentaires</button>
  </div>
</div>

<!-- Modal Likes -->
<div id="likesModal" class="modal">
  <div class="modal-box" style="max-height:80vh; overflow-y:auto;">
    <h2>Likes</h2>
    <button id="chooseLikeBtn">Choisir individuellement</button>
    <button id="clearLikesBtn">Tout effacer</button>
    <div id="likesList"></div>
  </div>
</div>

<!-- Modal Commentaires -->
<div id="commentsModal" class="modal">
  <div class="modal-box" style="max-height:80vh; overflow-y:auto;">
    <h2>Commentaires</h2>
    <button id="chooseCommentBtn">Choisir individuellement</button>
    <button id="clearCommentsBtn">Tout effacer</button>
    <div id="commentsList"></div>
  </div>
</div>

<!-- Modal suppression individuelle -->
<div id="deleteIndivModal" class="modal">
  <div class="modal-box">
    <p>Supprimer d√©finitivement ce Like/Commentaire ?</p>
    <button id="confirmDeleteIndiv">Oui</button>
    <button id="cancelDeleteIndiv">Annuler</button>
  </div>
</div>

<button id="manageBtn" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:36px;height:36px;border:none;background:none;cursor:pointer;">
  <svg viewBox="0 0 24 24" fill="none" stroke="#ff6eb1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="3"></circle>
    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 12 5.6V5a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
  </svg>
</button>
<!-- ================= SCRIPT ================= -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://jyhbamdcxmpveujjqjla.supabase.co",
  "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa"
);

const ownerPhoto=document.getElementById('ownerPhoto');
const prenom=localStorage.getItem('prenom')||'Steph';

async function loadOwnerPhoto(){
  const {data}=await supabase.from('profiles').select('photo_url').eq('prenom',prenom).single();
  if(data?.photo_url) ownerPhoto.src=data.photo_url;
}
loadOwnerPhoto();

/* ===== LOAD CREATIONS ===== */
let creations=[];
let currentZoom=null;

async function loadCreations(){
  const {data}=await supabase.from('creations').select('*').order('created_at',{ascending:false});
  creations=data||[];
  renderGrid();
}
loadCreations();

function renderGrid(){
  const main=document.getElementById('main');
  main.innerHTML='';
  for(let i=0;i<creations.length;i+=6){
    const page=document.createElement('div');
    page.className='page';
    creations.slice(i,i+6).forEach(c=>{
      const card=document.createElement('div');
      card.className='card';
      const img=document.createElement('img');
      img.src=supabase.storage.from('images').getPublicUrl(c.image_path).data.publicUrl;
      card.appendChild(img);

      const actions=document.createElement('div');
      actions.className='actions';

      const likeBtn=document.createElement('div');
      likeBtn.className='action-btn';
      likeBtn.id='likeBtn';
      likeBtn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M12 21s-6-4.35-9-8.5A5.5 5.5 0 0112 5a5.5 5.5 0 019 7.5C18 16.65 12 21 12 21z"/></svg><span>${c.likes?.length||0}</span>`;
      likeBtn.onclick=()=>openLike(c);

      const commentBtn=document.createElement('div');
      commentBtn.className='action-btn';
      commentBtn.id='commentBtn';
      commentBtn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg><span>${c.comments?.length||0}</span>`;
      commentBtn.onclick=()=>openComment(c);

      actions.append(likeBtn,commentBtn);
      card.appendChild(actions);
      page.appendChild(card);
    });
    main.appendChild(page);
  }
}

/* ===== LIKE ===== */
const likeModal=document.getElementById('likeModal');
const likeBubbles=document.getElementById('likeBubbles');

function openLike(c){
  currentZoom=c;
  likeBubbles.innerHTML='';
  (c.likes||[]).forEach(l=>{
    const b=document.createElement('div');
    b.className='bubble';
    b.textContent=l.name;
    likeBubbles.appendChild(b);
  });
  likeModal.style.display='flex';
}

document.getElementById('confirmLike').onclick=async()=>{
  if(!currentZoom.likes) currentZoom.likes=[];
  currentZoom.likes.push({name:prenom});
  await supabase.from('creations').update({likes:currentZoom.likes}).eq('id',currentZoom.id);
  likeModal.style.display='none';
  loadCreations();
};

/* ===== COMMENT ===== */
const commentModal=document.getElementById('commentModal');
const commentBubbles=document.getElementById('commentBubbles');

function openComment(c){
  currentZoom=c;
  renderComments();
  commentModal.style.display='flex';
}

function renderComments(){
  commentBubbles.innerHTML='';
  (currentZoom.comments||[]).forEach(c=>{
    const d=document.createElement('div');
    d.className='comment-item';
    d.innerHTML=`<strong>${c.name}</strong> : ${c.text}`;
    commentBubbles.appendChild(d);
  });
}

document.getElementById('confirmComment').onclick=async()=>{
  const text=document.getElementById('commentText').value.trim();
  if(!text) return;
  if(!currentZoom.comments) currentZoom.comments=[];
  currentZoom.comments.push({name:prenom,text});
  await supabase.from('creations').update({comments:currentZoom.comments}).eq('id',currentZoom.id);
  document.getElementById('commentText').value='';
  renderComments();
  loadCreations();
};

/* ===== GESTION ===== */
const manageModal=document.getElementById('manageModal');
document.getElementById('manageBtn').onclick=()=>manageModal.style.display='flex';
document.getElementById('manageLikesBtn').onclick = () => {
  manageMode = 'likes';
  openManageCreations();
};

document.getElementById('manageCommentsBtn').onclick = () => {
  manageMode = 'comments';
  openManageCreations();
};

/* fermer modals */
document.querySelectorAll('.modal').forEach(m=>{
  m.onclick=e=>{if(e.target===m)m.style.display='none'}
});

  const manageItemsModal = document.getElementById('manageItemsModal');
const manageItemsList = document.getElementById('manageItemsList');
const manageItemsTitle = document.getElementById('manageItemsTitle');

const manageDetailModal = document.getElementById('manageDetailModal');
const manageDetailTitle = document.getElementById('manageDetailTitle');
const manageDetailList = document.getElementById('manageDetailList');

const confirmDeleteModal = document.getElementById('confirmDeleteModal');

let manageMode = null; // 'likes' ou 'comments'
let selectedCreation = null;
let selectedIndex = null;

function openManageCreations(){
  manageModal.style.display='none';
  manageItemsModal.style.display='flex';
  manageItemsTitle.textContent =
    manageMode === 'likes' ? 'Choisir une cr√©ation (Likes)' : 'Choisir une cr√©ation (Commentaires)';

  manageItemsList.innerHTML='';

  creations.forEach(c=>{
    const item=document.createElement('div');
    item.className='manage-item';

    const img=document.createElement('img');
    img.src = supabase.storage.from('images')
      .getPublicUrl(c.image_path).data.publicUrl;

    const name=document.createElement('span');
    name.textContent=c.name;

    item.append(img,name);

    item.onclick=()=>{
      selectedCreation=c;
      openManageDetails();
    };

    manageItemsList.appendChild(item);
  });
}

  function openManageDetails(){
  manageItemsModal.style.display='none';
  manageDetailModal.style.display='flex';

  manageDetailList.innerHTML='';
  manageDetailTitle.textContent =
    manageMode === 'likes' ? 'Likes' : 'Commentaires';

  const list = manageMode === 'likes'
    ? (selectedCreation.likes || [])
    : (selectedCreation.comments || []);

  list.forEach((item,index)=>{
    const div=document.createElement('div');
    div.className='bubble';
    div.textContent = manageMode === 'likes'
      ? item.name
      : `${item.name} : ${item.text}`;

    div.onclick=()=>{
      selectedIndex=index;
      confirmDeleteModal.style.display='flex';
    };

    manageDetailList.appendChild(div);
  });
}

  document.getElementById('confirmDeleteYes').onclick = async () => {
  if(manageMode === 'likes'){
    selectedCreation.likes.splice(selectedIndex,1);
    await supabase.from('creations')
      .update({likes:selectedCreation.likes})
      .eq('id',selectedCreation.id);
  }

  if(manageMode === 'comments'){
    selectedCreation.comments.splice(selectedIndex,1);
    await supabase.from('creations')
      .update({comments:selectedCreation.comments})
      .eq('id',selectedCreation.id);
  }

  confirmDeleteModal.style.display='none';
  manageDetailModal.style.display='none';
  loadCreations();
};

document.getElementById('confirmDeleteNo').onclick = () => {
  confirmDeleteModal.style.display='none';
};

  document.getElementById('clearAllLikes').onclick = async () => {
  for(const c of creations){
    await supabase.from('creations').update({likes:[]}).eq('id',c.id);
  }
  loadCreations();
};

document.getElementById('clearAllComments').onclick = async () => {
  for(const c of creations){
    await supabase.from('creations').update({comments:[]}).eq('id',c.id);
  }
  loadCreations();
};
  
</script>
<!-- ===== MODAL LISTE CREATIONS ===== -->
<div class="modal" id="manageItemsModal">
  <div class="modal-box">
    <h2 id="manageItemsTitle"></h2>
    <div class="manage-list" id="manageItemsList"></div>
  </div>
</div>

<!-- ===== MODAL DETAILS LIKE / COMMENT ===== -->
<div class="modal" id="manageDetailModal">
  <div class="modal-box">
    <h2 id="manageDetailTitle"></h2>
    <div id="manageDetailList"></div>
  </div>
</div>

<!-- ===== CONFIRM SUPPRESSION ===== -->
<div class="modal" id="confirmDeleteModal">
  <div class="modal-box">
    <p>Supprimer d√©finitivement ?</p>
    <button class="confirm" id="confirmDeleteYes">Oui</button>
    <button class="confirm" id="confirmDeleteNo">Annuler</button>
  </div>
</div>
</body>
</html>
