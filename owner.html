<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Mes créations</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f7f7f7;
  padding:20px;
}

#owner-list{
  display:flex;
  flex-wrap:wrap;
  gap:20px;
}

.owner-item{
  width:220px;
  padding:10px;
  background:white;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
  text-align:center;
}

.owner-item img{
  width:100%;
  height:200px;
  object-fit:contain;
}
</style>
</head>

<body>

<h2>Ajouter une création</h2>

<input id="name" placeholder="Nom"><br><br>
<input id="photo" type="file" accept="image/*"><br><br>
<button id="add">Ajouter</button>

<hr><br>

<div id="owner-list"></div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================= SUPABASE ================= */
const supabaseUrl = 'https://tzrwnyserlflrirvhafb.supabase.co';
const supabaseKey = 'sb_publishable__7MMGWAcD78fCtWFz1nUhA_O-rJMbl-';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ================= TON CODE (INTOUCHÉ) ================= */
const nameInput = document.getElementById('name');
const photoInput = document.getElementById('photo');
const addBtn = document.getElementById('add');
const list = document.getElementById('owner-list');

addBtn.onclick = async () => {
  const name = nameInput.value.trim();
  const file = photoInput.files[0];

  if (!name || !file) {
    alert("Merci de remplir le nom et choisir une photo !");
    return;
  }

  const reader = new FileReader();
  reader.onload = async (e) => {
    const imgUrl = e.target.result;

    /* AFFICHAGE IMMEDIAT (COMME AVANT) */
    const div = document.createElement('div');
    div.className = 'owner-item';
    div.innerHTML = `
      <p>${name}</p>
      <img src="${imgUrl}">
    `;
    list.prepend(div);

    /* ===== SUPABASE SAUVEGARDE ===== */
    const filePath = `${Date.now()}-${file.name}`;

    const { error: uploadError } = await supabase
      .storage
      .from('photos')
      .upload(filePath, file);

    if(uploadError){
      alert("Erreur upload Supabase");
      console.error(uploadError);
      return;
    }

    const { data } = supabase
      .storage
      .from('photos')
      .getPublicUrl(filePath);

    await supabase.from('creations').insert([
      { name: name, image_url: data.publicUrl }
    ]);

    nameInput.value = '';
    photoInput.value = '';
  };

  reader.readAsDataURL(file);
};

/* ================= CHARGEMENT AU REFRESH ================= */
async function loadCreations(){
  const { data, error } = await supabase
    .from('creations')
    .select('*')
    .order('created_at', { ascending: false });

  if(error){
    console.error(error);
    return;
  }

  data.forEach(c => {
    const div = document.createElement('div');
    div.className = 'owner-item';
    div.innerHTML = `
      <p>${c.name}</p>
      <img src="${c.image_url}">
    `;
    list.appendChild(div);
  });
}

loadCreations();
</script>

</body>
</html>
