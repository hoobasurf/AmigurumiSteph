<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Galerie</title>

<style>
/* === CSS IDENTIQUE À TON CODE QUI MARCHE === */
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:'Comic Sans MS',cursive;overflow-x:hidden;}
body::before{
  content:"";
  position:fixed;inset:0;
  background:url('Photoroom_20251223_114401.jpeg') center/cover no-repeat;
  z-index:-1;
}
.center-zone{display:flex;justify-content:center;padding-top:3.5cm}
#visitor-list-container{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;padding-left:1cm}
.page{display:grid;grid-template-columns:repeat(2,200px);grid-template-rows:repeat(3,200px);gap:4mm;padding:4mm;scroll-snap-align:center}
.visitor-item{position:relative;border-radius:12px;overflow:hidden;border:3px solid #fff;background:#ffe6f0}
.visitor-item img{width:100%;height:100%;object-fit:cover;cursor:pointer}
.delete-btn{position:absolute;top:4px;right:4px;background:#ffb6c1;color:#fff;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:5}
.visitor-item p{position:absolute;bottom:2px;width:100%;text-align:center;font-size:14px;font-weight:bold;color:#b84c6f}
.actions{position:absolute;bottom:26px;width:100%;display:flex;justify-content:center;gap:16px}
.like-btn,.comment-btn{background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:6px;color:#b84c6f}
.like-btn svg,.comment-btn svg{width:16px;height:16px;stroke:#ffb6c1;fill:none}

/* SIDEBAR */
#sidebar{position:fixed;left:-220px;top:0;width:220px;height:100%;background:rgba(255,230,240,.25);padding:20px;transition:.3s;z-index:10}
#sidebar.sidebar-open{left:0}
#toggleSidebar{position:absolute;right:-30px;top:50%;width:30px;height:60px;background:#ffb6c1;display:flex;align-items:center;justify-content:center;border-radius:0 12px 12px 0;cursor:pointer}
#sidebar button{padding:8px 16px;border:none;border-radius:16px;background:#ffb6c1;color:#fff;font-weight:bold}

/* MODALS */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:10001}
.modal-box{background:#ffe6f0;padding:16px;border-radius:20px;border:3px solid #b67385;display:flex;flex-direction:column;gap:10px;min-width:220px}
.modal input{padding:6px;border-radius:10px;border:2px solid #b67385}
.modal button{padding:6px;border:none;border-radius:12px;background:#ffb6c1;color:#fff;font-weight:bold}

/* ZOOM */
#zoomModal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:10000}
#zoomModal img{max-width:80%;max-height:60vh;border-radius:20px;border:4px solid #b67385}
.closeZoom{position:absolute;top:12px;right:12px;width:28px;height:28px;background:#ffb6c1;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer}

.bubble-container{display:flex;gap:8px;overflow-x:auto}
.bubble{background:rgba(255,182,193,.3);padding:4px 8px;border-radius:16px;font-size:12px}
</style>
</head>

<body>

<div class="center-zone">
  <div id="visitor-list-container"></div>
</div>

<div id="sidebar">
  <div id="toggleSidebar">☰</div>
  <button id="addBtn">Ajouter</button>
</div>

<!-- MODALS -->
<div id="addModal" class="modal"><div class="modal-box">
  <input id="photoName" placeholder="Nom">
  <input type="file" id="multiPhoto" multiple>
  <button id="confirmAdd">Valider</button>
</div></div>

<div id="deleteModal" class="modal"><div class="modal-box">
  <p>Supprimer ?</p>
  <button id="confirmDelete">Oui</button>
  <button id="cancelDelete">Annuler</button>
</div></div>

<div id="likeModal" class="modal"><div class="modal-box">
  <input id="likeName" placeholder="Prénom">
  <button id="confirmLike">Valider</button>
  <div id="likeBubbles" class="bubble-container"></div>
</div></div>

<div id="commentModal" class="modal"><div class="modal-box">
  <input id="commentName" placeholder="Prénom">
  <input id="commentText" placeholder="Commentaire">
  <button id="confirmComment">Valider</button>
  <div id="commentBubbles" class="bubble-container"></div>
</div></div>

<div id="zoomModal">
  <div class="closeZoom">×</div>
  <img id="mainZoom">
  <div class="actions">
    <button class="like-btn">
      <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5"/></svg>
      <span id="likeCount">0</span>
    </button>
    <button class="comment-btn">
      <svg viewBox="0 0 24 24"><path d="M21 6h-18v12h18z"/></svg>
      <span id="commentCount">0</span>
    </button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
 "https://jyhbamdcxmpveujjqjla.supabase.co",
 "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa"
);

let creations=[], currentZoom=null, currentDelete=null;
const container=document.getElementById('visitor-list-container');

function render(){
 container.innerHTML='';
 let page;
 creations.forEach((c,i)=>{
  if(i%6===0){page=document.createElement('div');page.className='page';container.appendChild(page);}
  const d=document.createElement('div');
  d.className='visitor-item';
  d.innerHTML=`
   <div class="delete-btn">×</div>
   <img src="${c.imgUrl}">
   <p>${c.name}</p>
   <div class="actions">
     <button class="like-btn">${document.querySelector('.like-btn')?.innerHTML||''}</button>
     <button class="comment-btn">${document.querySelector('.comment-btn')?.innerHTML||''}</button>
   </div>`;
  d.querySelector('img').onclick=()=>openZoom(c);
  d.querySelector('.delete-btn').onclick=()=>{currentDelete=c;deleteModal.style.display='flex'};
  page.appendChild(d);
 });
}

function openZoom(c){
 currentZoom=c;
 mainZoom.src=c.imgUrl;
 likeCount.textContent=c.likes.length;
 commentCount.textContent=c.comments.length;
 zoomModal.style.display='flex';
}

zoomModal.onclick=e=>{if(e.target===zoomModal)zoomModal.style.display='none'}
document.querySelector('.closeZoom').onclick=()=>zoomModal.style.display='none';

document.querySelector('#zoomModal .like-btn').onclick=e=>{
 e.stopPropagation();
 likeModal.style.display='flex';
 likeBubbles.innerHTML='';
 currentZoom.likes.forEach(n=>{
  const b=document.createElement('div');
  b.className='bubble';b.textContent=n;
  likeBubbles.appendChild(b);
 });
};

document.querySelector('#zoomModal .comment-btn').onclick=e=>{
 e.stopPropagation();
 commentModal.style.display='flex';
 commentBubbles.innerHTML='';
 currentZoom.comments.forEach(c=>{
  const b=document.createElement('div');
  b.className='bubble';b.textContent=`${c.name}: ${c.text}`;
  commentBubbles.appendChild(b);
 });
};

confirmLike.onclick=async()=>{
 const name=likeName.value.trim();
 if(!name)return;
 currentZoom.likes.push(name);
 await supabase.from('creations').update({likes:currentZoom.likes}).eq('id',currentZoom.id);
 likeCount.textContent=currentZoom.likes.length;
 likeBubbles.innerHTML+=`<div class="bubble">${name}</div>`;
 likeName.value='';
};

confirmComment.onclick=async()=>{
 const n=commentName.value.trim(), t=commentText.value.trim();
 if(!n||!t)return;
 currentZoom.comments.push({name:n,text:t});
 await supabase.from('creations').update({comments:currentZoom.comments}).eq('id',currentZoom.id);
 commentCount.textContent=currentZoom.comments.length;
 commentBubbles.innerHTML+=`<div class="bubble">${n}: ${t}</div>`;
 commentName.value='';commentText.value='';
};

toggleSidebar.onclick=()=>sidebar.classList.toggle('sidebar-open');

async function load(){
 const {data}=await supabase.from('creations').select('*').order('created_at',{ascending:false});
 creations=data.map(c=>({
  id:c.id,
  name:c.name,
  imgUrl:supabase.storage.from('images').getPublicUrl(c.image_path).data.publicUrl,
  likes:c.likes||[],
  comments:c.comments||[]
 }));
 render();
}
load();
</script>

</body>
</html>
