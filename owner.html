<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="icon-152.png">
<meta name="theme-color" content="#f2b7c9">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
* { box-sizing:border-box;margin:0;padding:0;font-family:'Comic Sans MS',cursive; }
html,body{height:100%;overflow-x:hidden;}
body::before{
  content:"";position:fixed;top:0;left:0;width:100vw;height:100vh;
  background-image:url('Photoroom_20251223_114401.jpeg');
  background-size:cover;background-position:center center;background-repeat:no-repeat;z-index:-1;
}
.center-zone{display:flex;justify-content:center;align-items:flex-start;padding-top:3.5cm;overflow:hidden;height:auto;}
#visitor-list-container{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling: touch;justify-content:center;padding-left:1cm;}
.page{display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(3,1fr);column-gap:3mm;row-gap:4mm;flex:0 0 auto;width:calc(2*200px+3mm);height:calc(3*200px+8mm);scroll-snap-align:center;padding:4mm;justify-content:center;margin-top:0;}
.visitor-item{position:relative;width:200px;height:200px;border-radius:12px;overflow:hidden;border:3px solid #fff;box-shadow:0 0 0 3px #f6c2d1,0 6px 14px rgba(0,0,0,0.25),inset 0 0 0 1px rgba(255,255,255,0.4);background:#ffe6f0;}
.visitor-item .placeholder{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;font-size:24px;color:#b84c6f;font-weight:bold;}
.visitor-item img{width:100%;height:100%;object-fit:cover;border-radius:12px;cursor:pointer;display:block;filter:brightness(1.05) contrast(1.05) saturate(0.95);transition:filter 0.3s, transform 0.3s;position:relative;z-index:2;}
.visitor-item img:hover{transform:scale(1.03);}
.visitor-item::after{content:"";position:absolute;inset:0;background:rgba(255,230,240,0.12);pointer-events:none;z-index:1;}
.visitor-item p{position:absolute;bottom:2px;width:100%;font-size:14px;color:#b84c6f;font-weight:bold;text-align:center;text-shadow:1px 1px 2px rgba(255,255,255,0.8);z-index:3;}
.delete-btn{position:absolute;top:2px;right:2px;width:20px;height:20px;background:#ffb6c1;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;cursor:pointer;z-index:5;font-size:14px;transition: background 0.2s;}
.delete-btn:hover{background:#e94f9a;}

#sidebar{position:fixed;top:0;left:-220px;width:220px;height:100vh;background:rgba(255,230,240,0.2);border-right:2px solid #b67385;padding:20px;transition:left .3s;z-index:10;}
#sidebar.sidebar-open{left:0;}
#toggleSidebar{position:absolute;top:50%;right:-30px;width:30px;height:60px;background:#ffb6c1;border-radius:0 12px 12px 0;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;}
#sidebar button{width:auto;padding:8px 16px;border-radius:16px;border:none;background:#ffb6c1;color:#fff;cursor:pointer;font-weight:bold;display:block;margin-top:10px;}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:10001;}
.modal .modal-box{background:#ffe6f0;padding:16px 24px;border-radius:20px;border:3px solid #b67385;display:flex;flex-direction:column;gap:10px;align-items:center;min-width:200px;font-family:'Comic Sans MS',cursive;}
.modal input{padding:6px 12px;border-radius:10px;border:2px solid #b67385;width:100%;}
.modal button{padding:6px 14px;border:none;background:#ffb6c1;color:#fff;border-radius:12px;cursor:pointer;font-weight:bold;width:100%;}

#zoomModal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:10000;}
#zoomModal img{max-width:80%;max-height:60vh;border:4px solid #b67385;border-radius:24px;margin-bottom:10px;filter:none;}
#zoomModal .thumbs{display:flex;gap:8px;max-width:80%;overflow-x:auto;}
#zoomModal .thumbs img{width:50px;height:50px;object-fit:cover;border-radius:12px;border:2px solid #b67385;cursor:pointer;}
.closeZoom{position:absolute;top:12px;right:12px;width:28px;height:28px;background:#ffb6c1;color:#fff;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;}

#ownerPhoto{width:32px;height:32px;border-radius:50%;position:fixed;top:10px;right:10px;z-index:10000;background:#ffe6f0;border:2px solid #b84c6f;}
@media(max-width:480px){.page{grid-template-columns:repeat(2,120px);grid-template-rows:repeat(3,120px);}.visitor-item{width:120px;height:120px;}.modal .modal-box{min-width:180px;}}

.icon-btn svg { cursor:pointer; transition: transform 0.2s;}
.icon-btn:hover svg { transform: scale(1.2);}
.icon-btn span { font-weight: bold; color: #b84c6f; font-size: 14px;}
</style>
</head>
<body>

<img id="ownerPhoto" alt="Owner">

<div class="center-zone">
  <div id="visitor-list-container"></div>
</div>

<div id="sidebar">
  <div id="toggleSidebar">☰</div>
  <button id="addBtn">Ajouter</button>
  <button id="pelotesBtn">Pelotes</button>
  <button id="videoBtn">Vidéo</button>
  <button id="notesBtn">Notes</button>
  <button id="messagerieBtn">Messagerie</button>
  <button id="manageBtn" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);width:36px;height:36px;border:none;background:none;cursor:pointer;">
    <svg viewBox="0 0 24 24" fill="none" stroke="#ffb6c1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="3"></circle>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 12 5.6V5a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
    </svg>
  </button>
</div>

<script type="module">

// ====== SUPABASE ======
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient("https://jyhbamdcxmpveujjqjla.supabase.co","sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa");

// ====== VARIABLES ======
const ownerPhoto=document.getElementById('ownerPhoto');
const prenom=localStorage.getItem('prenom');
let creations=[],currentZoom=null,currentDelete=null;

// Containers
const container=document.getElementById('visitor-list-container');
const addModal=document.getElementById('addModal');
const deleteModal=document.getElementById('deleteModal');
const zoomModal=document.getElementById('zoomModal');
const likeModal=document.getElementById('likeModal');
const commentModal=document.getElementById('commentModal');
const likeBubbles=document.getElementById('likeBubbles');
const commentBubbles=document.getElementById('commentBubbles');
const likeNameInput=document.getElementById('likeName');
const commentNameInput=document.getElementById('commentName');
const confirmLike=document.getElementById('confirmLike');
const confirmComment=document.getElementById('confirmComment');
const mainZoom=document.getElementById('mainZoom');
const thumbs=document.getElementById('thumbs');
const likeCount=document.getElementById('likeCount');
const commentCount=document.getElementById('commentCount');

// ====== FILL OWNER INFO ======
function fillUserInfo(){
  likeNameInput.value=prenom||'';
  commentNameInput.value=prenom||'';
}
if(prenom) fillUserInfo();

// ====== REFRESH CREATIONS ======
async function refreshCreations(){
  const {data,error}=await supabase.from('creations').select('*').order('created_at',{ascending:false});
  if(error){console.error(error);return;}
  creations=data.map(c=>{
    let zoomGroup=[];
    if(c.images?.length) zoomGroup=c.images.map(p=>supabase.storage.from('images').getPublicUrl(p).data?.publicUrl||'');
    else if(c.image_path) zoomGroup=[supabase.storage.from('images').getPublicUrl(c.image_path).data?.publicUrl||''];
    return {id:c.id,name:c.name,imgUrl:zoomGroup[0],zoomGroup,likes:c.likes||[],comments:c.comments||[]};
  });
  render();
}

// ====== RENDER ======
function render(){
  container.innerHTML='';
  let page=null;
  creations.forEach((c,i)=>{
    if(i%6===0){page=document.createElement('div');page.className='page';container.appendChild(page);}
    const d=document.createElement('div');d.className='visitor-item';
    d.innerHTML=`<div class="placeholder">?</div><div class="delete-btn">×</div><p>${c.name}</p><img src="${c.imgUrl||''}">`;
    const img=d.querySelector('img');
    img.onload=()=>d.querySelector('.placeholder').style.display='none';
    img.onclick=()=>openZoom(c);
    d.querySelector('.delete-btn').onclick=()=>openDeleteModal(c);
    page.appendChild(d);
  });
}

// ====== ZOOM ======
function openZoom(c){
  currentZoom=c;
  mainZoom.src=c.imgUrl;
  thumbs.innerHTML='';
  if(!c.zoomGroup || c.zoomGroup.length===0)c.zoomGroup=[c.imgUrl];
  c.zoomGroup.forEach(u=>{const t=document.createElement('img');t.src=u;t.onclick=()=>mainZoom.src=u;thumbs.appendChild(t);});
  likeCount.textContent=c.likes.length;
  commentCount.textContent=c.comments.length;
  zoomModal.style.display='flex';
}

// Fermeture zoom modal
document.querySelector('.closeZoom').onclick=()=>zoomModal.style.display='none';
zoomModal.onclick=e=>{if(e.target===zoomModal)zoomModal.style.display='none';};
likeModal.onclick=e=>{if(e.target===likeModal)likeModal.style.display='none';};
commentModal.onclick=e=>{if(e.target===commentModal)commentModal.style.display='none';};
deleteModal.onclick=e=>{if(e.target===deleteModal){deleteModal.style.display='none';currentDelete=null;}};

// ====== LIKE ======
document.getElementById('likeBtn').onclick=()=>{
  if(!currentZoom)return;
  likeBubbles.innerHTML='';
  currentZoom.likes.forEach(l=>{const b=document.createElement('div');b.textContent=l.name;likeBubbles.appendChild(b);});
  likeNameInput.value=prenom||'';
  likeModal.style.display='flex';
};
confirmLike.onclick=async()=>{
  if(!currentZoom)return;
  const name=likeNameInput.value.trim();if(!name)return;
  if(!currentZoom.likes)currentZoom.likes=[];
  if(!currentZoom.likes.some(l=>l.name===name))currentZoom.likes.push({name,photo:ownerPhoto.src||''});
  await supabase.from('creations').update({likes:currentZoom.likes}).eq('id',currentZoom.id);
  likeBubbles.innerHTML='';currentZoom.likes.forEach(l=>{const b=document.createElement('div');b.textContent=l.name;likeBubbles.appendChild(b);});
  likeCount.textContent=currentZoom.likes.length;
  likeModal.style.display='none';
};

// ====== COMMENT ======
document.getElementById('commentBtn').onclick=()=>{
  if(!currentZoom)return;
  renderCommentList();
  commentNameInput.value=prenom||'';
  document.getElementById('commentText').value='';
  commentModal.style.display='flex';
};
function renderCommentList(){
  commentBubbles.innerHTML='';
  currentZoom.comments.forEach(c=>{const div=document.createElement('div');div.textContent=c.name+': '+c.text;commentBubbles.appendChild(div);});
  commentCount.textContent=currentZoom.comments.length;
}
confirmComment.onclick=async()=>{
  if(!currentZoom)return;
  const text=document.getElementById('commentText').value.trim();if(!text)return;
  if(!currentZoom.comments)currentZoom.comments=[];
  currentZoom.comments.push({name:prenom||'',text,photo:ownerPhoto.src||''});
  await supabase.from('creations').update({comments:currentZoom.comments}).eq('id',currentZoom.id);
  renderCommentList();
  document.getElementById('commentText').value='';
};

// ====== DELETE ======
function openDeleteModal(c){currentDelete=c;deleteModal.style.display='flex';}
document.getElementById('confirmDelete').onclick=async()=>{
  if(!currentDelete?.id)return;
  await supabase.from('creations').delete().eq('id',currentDelete.id);
  currentDelete=null;deleteModal.style.display='none';
  await refreshCreations();
};
document.getElementById('cancelDelete').onclick=()=>{currentDelete=null;deleteModal.style.display='none';};

// ====== SIDEBAR ======
document.getElementById('toggleSidebar').onclick=()=>document.getElementById('sidebar').classList.toggle('sidebar-open');
document.getElementById('pelotesBtn').onclick=()=>window.location.href='pelotes.html';
document.getElementById('videoBtn').onclick=()=>window.location.href='video.html';
document.getElementById('notesBtn').onclick=()=>window.location.href='notes.html';
document.getElementById('messagerieBtn').onclick=()=>window.location.href='messagerie.html';

// ====== INITIAL ======
refreshCreations();
</script>
</body>
</html>
