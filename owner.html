<script type="module">

// R√©cup√®re le pr√©nom et la photo envoy√©s depuis l'accueil
// Si vide, laisse comme cha√Æne vide
// ======== CURRENT USER ========
let currentUser = {
  prenom: localStorage.getItem('prenom') || '',
  photo: localStorage.getItem('photo') || ''  // R√©cup√®re directement la photo stock√©e
};

// Affiche la mini photo si elle existe
if (currentUser.photo) {
  document.getElementById('ownerPhoto').src = currentUser.photo;
}
  
let creations = [];
let currentZoom = null;
let currentDelete = null;

const container = document.getElementById('visitor-list-container');
const addModal = document.getElementById('addModal');
const deleteModal = document.getElementById('deleteModal');
const zoomModal = document.getElementById('zoomModal');
const sidebar = document.getElementById('sidebar');
const mainZoom = document.getElementById('mainZoom');
const thumbs = document.getElementById('thumbs');
const likeCount = document.getElementById('likeCount');
const commentCount = document.getElementById('commentCount');

const likeModal = document.getElementById('likeModal');
const likeBubbles = document.getElementById('likeBubbles');
const confirmLike = document.getElementById('confirmLike');
const likeNameInput = document.getElementById('likeName');

const commentModal = document.getElementById('commentModal');
const confirmComment = document.getElementById('confirmComment');
const commentBubbles = document.getElementById('commentBubbles');

// ================== RENDER ==================
function render() {
  container.innerHTML = '';
  let page = null;

  creations.forEach((c, i) => {
    if (i % 6 === 0) {
      page = document.createElement('div');
      page.className = 'page';
      container.appendChild(page);
    }

    const d = document.createElement('div');
    d.className = 'visitor-item';
    d.innerHTML = `
      <div class="placeholder">?</div>
      <div class="delete-btn">√ó</div>
      <p>${c.name}</p>
      <img src="${c.imgUrl || ''}">
    `;

    const img = d.querySelector('img');
    img.onload = () => d.querySelector('.placeholder').style.display = 'none';
    img.onerror = () => img.style.display = 'none';
    img.onclick = () => openZoom(c);

    d.querySelector('.delete-btn').onclick = () => openDeleteModal(c);

    page.appendChild(d);
  });
}

// ================== ZOOM ==================
function openZoom(c){
  currentZoom = c;
  mainZoom.src = c.imgUrl;
  thumbs.innerHTML = '';

  if (!c.zoomGroup || c.zoomGroup.length === 0) c.zoomGroup = [c.imgUrl];

  c.zoomGroup.forEach(u => {
    const t = document.createElement('img');
    t.src = u;
    t.onclick = () => mainZoom.src = u;
    thumbs.appendChild(t);
  });

  updateActions();
  zoomModal.style.display = 'flex';
}

function updateActions(){
  likeCount.textContent = currentZoom.likes?.length || 0;
  commentCount.textContent = currentZoom.comments?.length || 0;
}

// ================== LIKE ==================
document.querySelector('.like-btn').onclick = () => {
    if (!currentZoom) return;

    likeBubbles.innerHTML = '';

    currentZoom.likes?.forEach(like => {
    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    if (like.photo) {
        bubble.innerHTML = `
          <img src="${like.photo}"
               style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;">
          ${like.name}
        `;
    } else {
        bubble.textContent = like.name;
    }

    likeBubbles.appendChild(bubble);
});

    // Pr√©-remplir automatiquement le pr√©nom du user
    likeNameInput.value = currentUser.prenom || '';

    likeModal.style.display = 'flex';
};

confirmLike.onclick = async () => {
    const name = likeNameInput.value.trim();
    if (!name || !currentZoom) return;

    if (!currentZoom.likes) currentZoom.likes = [];

    // üîí AJOUT PHOTO AU LIKE
    const likeObj = {
      name: name,
      photo: currentUser.photo || ''
    };

    currentZoom.likes.push(likeObj);

    const { error } = await supabase.from('creations')
        .update({ likes: currentZoom.likes })
        .eq('id', currentZoom.id);

    if (error) console.error(error);

    // üîπ RENDER DES BULLES AVEC PHOTO
    likeBubbles.innerHTML = '';
    currentZoom.likes.forEach(like => {
        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        if (like.photo) {
            bubble.innerHTML = `
              <img src="${like.photo}"
                   style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;">
              ${like.name}
            `;
        } else {
            bubble.textContent = like.name;
        }

        likeBubbles.appendChild(bubble);
    });

    updateActions();
    likeModal.style.display = 'none';
};

// ================== COMMENT ==================
document.querySelector('.comment-btn').onclick = () => {
    if (!currentZoom) return;

    renderCommentList();

    // Pr√©-remplir automatiquement le pr√©nom
    document.getElementById('commentName').value = currentUser.prenom || '';
    document.getElementById('commentText').value = '';

    commentModal.style.display = 'flex';
};

function renderCommentList() {
    commentBubbles.innerHTML = '';
    (currentZoom.comments || []).forEach(c => {
        const item = document.createElement('div');
        item.className = 'comment-item';

        const text = document.createElement('span');

        // ‚Üê Ici on met la photo si elle existe
        text.innerHTML = `
          ${c.photo ? `<img src="${c.photo}" style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;">` : ''}
          <strong>${c.name}</strong> : ${c.text}
        `;

        item.appendChild(text);
        commentBubbles.appendChild(item);
    });

    // Mise √† jour compteur
    commentCount.textContent = currentZoom.comments?.length || 0;
}
  
// ================== CONFIRM COMMENT ==================

  confirmComment.onclick = async () => {
  const name = document.getElementById('commentName').value.trim();
  const text = document.getElementById('commentText').value.trim();

  if (!name || !text || !currentZoom) return;

  if (!currentZoom.comments) currentZoom.comments = [];

  currentZoom.comments.push({
    name,
    text,
    photo: currentUser.photo || '',
    likes: []
  });

  await supabase
    .from('creations')
    .update({ comments: currentZoom.comments })
    .eq('id', currentZoom.id);

  renderCommentList();

  document.getElementById('commentText').value = '';
};

// ================== MINI-MODAL LIKE COMMENT ==================
function openCommentLikeModal(comment){
  let modal = document.getElementById('commentLikeModal');
  if(!modal){
    modal = document.createElement('div');
    modal.id = 'commentLikeModal';
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-box">
        <h3>Like ‚ù§Ô∏è</h3>
        <input id="commentLikeName" placeholder="Pr√©nom">
        <button id="confirmCommentLike">Valider</button>
        <div class="bubble-container" id="commentLikeList"></div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if(e.target === modal) modal.style.display='none'; };
  }

  const list = modal.querySelector('#commentLikeList');
  list.innerHTML = '';
  (comment.likes || []).forEach(name => {
    const div = document.createElement('div');
    div.className = 'bubble';
    div.textContent = name;
    list.appendChild(div);
  });

  const input = modal.querySelector('#commentLikeName');
  input.value = '';

  const confirmBtn = modal.querySelector('#confirmCommentLike');
  confirmBtn.onclick = async () => {
    const name = input.value.trim();
    if(!name) return;
    if(!comment.likes) comment.likes = [];
    comment.likes.push(name);

    const { error } = await supabase.from('creations')
      .update({ comments: currentZoom.comments })
      .eq('id', currentZoom.id);
    if(error) console.error(error);

    list.innerHTML = '';
    comment.likes.forEach(n => {
      const div = document.createElement('div');
      div.className = 'bubble';
      div.textContent = n;
      list.appendChild(div);
    });

    modal.style.display='none';
    render(); 
  };

  modal.style.display='flex';
};

// ================== DELETE ==================
function openDeleteModal(project){
  currentDelete = project;
  deleteModal.style.display = 'flex';
}

document.getElementById('cancelDelete').onclick = () => {
  currentDelete = null;
  deleteModal.style.display = 'none';
};

document.getElementById('confirmDelete').onclick = async () => {
  if (!currentDelete?.id) return;

  const { error } = await supabase.from('creations').delete().eq('id', currentDelete.id);
  if (error) { console.error(error); return; }

  await refreshCreations();
  deleteModal.style.display = 'none';
  currentDelete = null;
};

// ================== AJOUT ==================
document.getElementById('addBtn').onclick = () => { addModal.style.display = 'flex'; };

addModal.addEventListener('click', e => { if (e.target === addModal) addModal.style.display = 'none'; });

document.getElementById('confirmAdd').onclick = async (e) => {
  e.stopPropagation();

  const name = document.getElementById('photoName').value.trim();
  const files = document.getElementById('multiPhoto').files;
  if (!name || !files.length) { alert("Veuillez mettre un nom et s√©lectionner au moins une photo"); return; }

  const paths = [];
  const urls = [];

  for (let file of files) {
    const path = `${Date.now()}_${file.name}`;
    const { error: uploadError } = await supabase.storage.from('images').upload(path, file);
    if (uploadError) { console.error(uploadError); continue; }
    const { data: pubData } = supabase.storage.from('images').getPublicUrl(path);
    if (!pubData || !pubData.publicUrl) continue;
    urls.push(pubData.publicUrl);
    paths.push(path);
  }

  if (urls.length === 0) return;

  const { data, error } = await supabase.from('creations').insert([{
    name,
    image_path: paths[0],
    images: paths,
    likes: [],
    comments: []
  }]).select();

  if (error) { console.error(error); return; }

  addModal.style.display = 'none';
  document.getElementById('photoName').value = '';
  document.getElementById('multiPhoto').value = '';

  await refreshCreations();
};

// ================== REFRESH ==================
async function refreshCreations() {
  const { data, error } = await supabase.from('creations').select('*').order('created_at', { ascending: false });
  if (error) { console.error(error); return; }

  creations = data.map(c => {
  const zoomGroup = (c.images && c.images.length) ?
    c.images.map(p => supabase.storage.from('images').getPublicUrl(p).data.publicUrl)
    : [supabase.storage.from('images').getPublicUrl(c.image_path).data.publicUrl];

  return {
    id: c.id,
    name: c.name,
    imgUrl: zoomGroup[0],
    zoomGroup,
    likes: c.likes || [],
    comments: c.comments || []
  };
});

  render();
}

// ================== BOUTONS SIDEBAR ==================
const addBtn = document.getElementById('addBtn');

// --- Bouton Pelotes ---
const pelotesBtn = document.createElement('button');
pelotesBtn.textContent = "Pelotes";
pelotesBtn.style.marginTop = "10px";

addBtn.insertAdjacentElement('afterend', pelotesBtn);

pelotesBtn.onclick = () => {
  document.body.style.transition = 'opacity 0.5s';
  document.body.style.opacity = '0';
  setTimeout(() => {
    window.location.href = 'pelotes.html';
  }, 500);
};

// --- Bouton Vid√©o ---
const videoBtn = document.createElement('button');
videoBtn.textContent = "Vid√©o";
videoBtn.style.marginTop = "10px";

pelotesBtn.insertAdjacentElement('afterend', videoBtn);

videoBtn.onclick = () => {
  document.body.style.transition = 'opacity 0.5s';
  document.body.style.opacity = '0';
  setTimeout(() => {
    window.location.href = 'video.html'; // ‚Üê change si besoin
  }, 500);
};

// --- Bouton Notes ---
const notesBtn = document.createElement('button');
notesBtn.textContent = "Notes";
notesBtn.style.marginTop = "10px";

videoBtn.insertAdjacentElement('afterend', notesBtn);

notesBtn.onclick = () => {
  document.body.style.transition = 'opacity 0.5s';
  document.body.style.opacity = '0';
  setTimeout(() => {
    window.location.href = 'notes.html'; // ‚Üê change le lien si n√©cessaire
  }, 500);
};

// --- Bouton Messagerie ---
const messagerieBtn = document.createElement('button');
messagerieBtn.textContent = "Messagerie";
messagerieBtn.style.marginTop = "10px";

notesBtn.insertAdjacentElement('afterend', messagerieBtn);

messagerieBtn.onclick = () => {
  document.body.style.transition = 'opacity 0.5s';
  document.body.style.opacity = '0';
  setTimeout(() => {
    window.location.href = 'messagerie.html';
  }, 500);
};
  
  // ================== EVENTS ==================
document.querySelector('.closeZoom').onclick = () => zoomModal.style.display = 'none';
zoomModal.onclick = e => { if(e.target === zoomModal) zoomModal.style.display = 'none'; };
likeModal.onclick = e => { if(e.target === likeModal) likeModal.style.display = 'none'; };
commentModal.onclick = e => { if(e.target === commentModal) commentModal.style.display = 'none'; };
deleteModal.onclick = e => { if(e.target === deleteModal) deleteModal.style.display = 'none'; currentDelete=null; };
document.getElementById('toggleSidebar').onclick = () => sidebar.classList.toggle('sidebar-open');

// ===== AGRANDISSEMENT MODAL COMMENT =====
const expandBtn = document.getElementById('expandComment');
const commentBox = document.querySelector('.comment-box');
expandBtn.onclick = (e) => {
  e.stopPropagation();
  commentBox.classList.toggle('fullscreen');
  expandBtn.textContent = commentBox.classList.contains('fullscreen') ? '‚§°' : '‚§¢';
};

// ================== START ==================
refreshCreations();
</script>
