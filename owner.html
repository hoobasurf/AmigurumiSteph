<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Galerie</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="favicon.ico">
<link rel="apple-touch-icon" href="icon-152.png">
<meta name="theme-color" content="#f2b7c9">

<style>
/* ===== RESET ===== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
  font-family: 'Comic Sans MS', cursive;
  overflow-x: hidden;
}

/* ===== BACKGROUND ===== */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: url('Photoroom_20251223_114401.jpeg') center / cover no-repeat;
  z-index: -1;
}

/* ===== AVATAR UTILISATEUR ===== */
#ownerPhoto {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  object-fit: cover;
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 10000;
  border: 2px solid #fff;
  background: #ffd6e6;
}

/* ===== ZONE CENTRALE ===== */
.center-zone {
  display: flex;
  justify-content: center;
  padding-top: 3.5cm;
}

#visitor-list-container {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  padding-left: 1cm;
}

/* ===== PAGE (6 PHOTOS) ===== */
.page {
  display: grid;
  grid-template-columns: repeat(2, 200px);
  grid-template-rows: repeat(3, 200px);
  gap: 6px;
  padding: 10px;
  scroll-snap-align: center;
}

/* ===== ITEM PHOTO ===== */
.visitor-item {
  position: relative;
  width: 200px;
  height: 200px;
  border-radius: 14px;
  overflow: hidden;
  background: #ffe6f0;
  border: 3px solid #fff;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.visitor-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  cursor: pointer;
  transition: transform 0.3s ease;
}

.visitor-item img:hover {
  transform: scale(1.05);
}

/* ===== NOM PROJET ===== */
.visitor-item p {
  position: absolute;
  bottom: 0;
  width: 100%;
  text-align: center;
  font-size: 14px;
  color: #b84c6f;
  font-weight: bold;
  background: rgba(255,230,240,0.8);
  padding: 2px 0;
}

/* ===== BOUTON SUPPRESSION ===== */
.delete-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: #ffb6c1;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  cursor: pointer;
  z-index: 10;
}

/* ===== SIDEBAR ===== */
#sidebar {
  position: fixed;
  top: 0;
  left: -240px;
  width: 240px;
  height: 100vh;
  background: rgba(255,230,240,0.95);
  padding: 20px;
  transition: left 0.3s ease;
  z-index: 9000;
}

#sidebar.sidebar-open {
  left: 0;
}

#toggleSidebar {
  position: absolute;
  right: -30px;
  top: 50%;
  transform: translateY(-50%);
  width: 30px;
  height: 60px;
  background: #ffb6c1;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border-radius: 0 8px 8px 0;
}

/* ===== BOUTONS SIDEBAR ===== */
.sidebar-btn {
  display: block;
  width: 100%;
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 12px;
  border: none;
  background: #ffb6c1;
  color: #fff;
  font-size: 15px;
  cursor: pointer;
}

/* ===== MODALS (GLOBAL) ===== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

.modal-box {
  background: #ffe6f0;
  border-radius: 20px;
  padding: 20px;
  min-width: 260px;
  max-width: 90%;
}

/* ===== ZOOM ===== */
#zoomModal img {
  max-width: 80vw;
  max-height: 60vh;
  border-radius: 20px;
  display: block;
  margin: auto;
}

/* ===== THUMBNAILS ===== */
.thumb-row {
  display: flex;
  justify-content: center;
  margin-top: 10px;
  gap: 6px;
}

.thumb-row img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: 8px;
  cursor: pointer;
  border: 2px solid transparent;
}

.thumb-row img.active {
  border-color: #ff6fa1;
}

/* ===== LIKE / COMMENT ===== */
.action-row {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 10px;
}

.action-btn {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

/* ===== COMMENTAIRES ===== */
.comment {
  display: flex;
  align-items: flex-start;
  margin-top: 8px;
}

.comment img {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  margin-right: 6px;
}

.comment-content {
  background: #fff;
  border-radius: 12px;
  padding: 6px 10px;
  font-size: 14px;
}

/* ===== ANIMATION √âTOILE ===== */
.star {
  position: absolute;
  font-size: 18px;
  animation: fly 1s ease forwards;
}

@keyframes fly {
  from { transform: translateY(0); opacity: 1; }
  to { transform: translateY(-40px); opacity: 0; }
}
</style>

</head>
<body>

<!-- AVATAR UTILISATEUR -->
<img id="ownerPhoto" alt="Avatar utilisateur">

<!-- ZONE CENTRALE -->
<div class="center-zone">
  <div id="visitor-list-container"></div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div id="toggleSidebar">‚ò∞</div>

  <button class="sidebar-btn" id="addBtn">‚ûï Ajouter</button>
  <button class="sidebar-btn" id="btnPelotes">üß∂ Pelotes</button>
  <button class="sidebar-btn" id="btnVideo">üé• Vid√©o</button>
  <button class="sidebar-btn" id="btnNotes">üìù Notes</button>
  <button class="sidebar-btn" id="btnMessages">üí¨ Messagerie</button>
</div>

<!-- ===== MODAL AJOUT ===== -->
<div id="addModal" class="modal">
  <div class="modal-box">
    <h3>Ajouter un projet</h3><br>

    <input id="photoName" placeholder="Nom du projet" style="width:100%;padding:8px;border-radius:10px;border:none;"><br><br>

    <input type="file" id="multiPhoto" multiple><br><br>

    <button id="confirmAdd" class="sidebar-btn">Valider</button>
  </div>
</div>

<!-- ===== MODAL SUPPRESSION ===== -->
<div id="deleteModal" class="modal">
  <div class="modal-box">
    <p>Supprimer ce projet ?</p><br>
    <button id="confirmDelete" class="sidebar-btn">Oui</button>
    <button id="cancelDelete" class="sidebar-btn">Non</button>
  </div>
</div>

<!-- ===== MODAL ZOOM ===== -->
<div id="zoomModal" class="modal">
  <div class="modal-box">

    <!-- IMAGE PRINCIPALE -->
    <img id="mainZoom" alt="Zoom">

    <!-- THUMBNAILS -->
    <div class="thumb-row" id="thumbRow"></div>

    <!-- ACTIONS -->
    <div class="action-row">
      <button class="action-btn" id="likeBtn">‚ù§Ô∏è <span id="likeCount">0</span></button>
      <button class="action-btn" id="commentBtn">üí¨ <span id="commentCount">0</span></button>
    </div>

    <!-- COMMENTAIRES -->
    <div id="commentSection" style="margin-top:10px;max-height:200px;overflow-y:auto;"></div>

    <!-- AJOUT COMMENTAIRE -->
    <div style="display:flex;margin-top:10px;gap:6px;">
      <input id="commentInput" placeholder="√âcrire un commentaire..."
             style="flex:1;padding:8px;border-radius:10px;border:none;">
      <button id="sendComment" class="sidebar-btn">Envoyer</button>
    </div>

  </div>
</div>

<!-- ===== MODAL LISTE DES LIKES ===== -->
<div id="likesModal" class="modal">
  <div class="modal-box">
    <h3>Likes</h3>
    <div id="likesList" style="margin-top:10px;"></div>
  </div>
</div>

<!-- ===== MODAL COMMENTAIRES PLEIN √âCRAN ===== -->
<div id="fullCommentModal" class="modal">
  <div class="modal-box">
    <h3>Commentaires</h3>
    <div id="fullCommentList" style="margin-top:10px;"></div>
  </div>
</div>
<script type="module">
/* ================= SUPABASE ================= */
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://jyhbamdcxmpveujjqjla.supabase.co",
  "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa"
);

/* ================= USER ================= */
const currentUser = {
  prenom: localStorage.getItem("prenom") || "Anonyme",
  photo: localStorage.getItem("photo") || ""
};

const ownerPhoto = document.getElementById("ownerPhoto");
if (currentUser.photo) ownerPhoto.src = currentUser.photo;

/* ================= GLOBAL ================= */
let creations = [];
let currentCreation = null;
let currentImageIndex = 0;
let creationToDelete = null;

/* ================= ELEMENTS ================= */
const container = document.getElementById("visitor-list-container");
const zoomModal = document.getElementById("zoomModal");
const mainZoom = document.getElementById("mainZoom");
const thumbRow = document.getElementById("thumbRow");
const likeCount = document.getElementById("likeCount");
const commentCount = document.getElementById("commentCount");
const commentSection = document.getElementById("commentSection");

/* ================= RENDER ================= */
function render() {
  container.innerHTML = "";
  let page;

  creations.forEach((c, i) => {
    if (i % 6 === 0) {
      page = document.createElement("div");
      page.className = "page";
      container.appendChild(page);
    }

    const d = document.createElement("div");
    d.className = "visitor-item";
    d.innerHTML = `
      <div class="delete-btn">√ó</div>
      <img src="${c.images[0]}">
      <p>${c.name}</p>
    `;

    d.querySelector("img").onclick = () => openZoom(c, 0);
    d.querySelector(".delete-btn").onclick = () => openDelete(c);

    page.appendChild(d);
  });
}

/* ================= ZOOM ================= */
function openZoom(creation, index) {
  currentCreation = creation;
  currentImageIndex = index;

  mainZoom.src = creation.images[index];
  zoomModal.style.display = "flex";

  renderThumbs();
  updateCounts();
  renderComments();
}

function renderThumbs() {
  thumbRow.innerHTML = "";
  currentCreation.images.forEach((img, i) => {
    const t = document.createElement("img");
    t.src = img;
    if (i === currentImageIndex) t.classList.add("active");
    t.onclick = () => openZoom(currentCreation, i);
    thumbRow.appendChild(t);
  });
}

/* ================= LIKES ================= */
document.getElementById("likeBtn").onclick = async () => {
  const likes = currentCreation.likes || [];
  const existing = likes.find(l => l.prenom === currentUser.prenom);

  if (existing) {
    currentCreation.likes = likes.filter(l => l.prenom !== currentUser.prenom);
  } else {
    currentCreation.likes.push({
      prenom: currentUser.prenom,
      photo: currentUser.photo
    });
    spawnStar();
  }

  await saveCreation();
  updateCounts();
};

function updateCounts() {
  likeCount.textContent = currentCreation.likes.length;
  commentCount.textContent = currentCreation.comments.length;
}

/* ================= COMMENTAIRES ================= */
function renderComments() {
  commentSection.innerHTML = "";
  currentCreation.comments.forEach(c => {
    const d = document.createElement("div");
    d.className = "comment";
    d.innerHTML = `
      <img src="${c.photo || ''}">
      <div class="comment-content">
        <strong>${c.prenom}</strong><br>${c.text}
      </div>
    `;
    commentSection.appendChild(d);
  });
}

document.getElementById("sendComment").onclick = async () => {
  const input = document.getElementById("commentInput");
  if (!input.value) return;

  currentCreation.comments.push({
    prenom: currentUser.prenom,
    photo: currentUser.photo,
    text: input.value,
    likes: []
  });

  input.value = "";
  await saveCreation();
  renderComments();
  updateCounts();
};

/* ================= DELETE ================= */
function openDelete(c) {
  creationToDelete = c;
  document.getElementById("deleteModal").style.display = "flex";
}

document.getElementById("confirmDelete").onclick = async () => {
  await supabase.from("creations").delete().eq("id", creationToDelete.id);
  document.getElementById("deleteModal").style.display = "none";
  refreshCreations();
};

document.getElementById("cancelDelete").onclick = () => {
  document.getElementById("deleteModal").style.display = "none";
};

/* ================= ADD ================= */
document.getElementById("addBtn").onclick = () => {
  document.getElementById("addModal").style.display = "flex";
};

document.getElementById("confirmAdd").onclick = async () => {
  const name = photoName.value;
  const files = multiPhoto.files;
  if (!name || !files.length) return;

  let urls = [];

  for (const file of files) {
    const path = Date.now() + "_" + file.name;
    await supabase.storage.from("images").upload(path, file);
    const url = supabase.storage.from("images").getPublicUrl(path).data.publicUrl;
    urls.push(url);
  }

  await supabase.from("creations").insert([{
    name,
    images: urls,
    likes: [],
    comments: []
  }]);

  addModal.style.display = "none";
  refreshCreations();
};

/* ================= SAVE ================= */
async function saveCreation() {
  await supabase
    .from("creations")
    .update({
      likes: currentCreation.likes,
      comments: currentCreation.comments
    })
    .eq("id", currentCreation.id);
}

/* ================= SIDEBAR ================= */
document.getElementById("toggleSidebar").onclick = () => {
  sidebar.classList.toggle("sidebar-open");
};

/* ================= MODALS CLOSE ================= */
[zoomModal, addModal, deleteModal].forEach(m => {
  m.onclick = e => { if (e.target === m) m.style.display = "none"; };
});

/* ================= STAR ================= */
function spawnStar() {
  const s = document.createElement("div");
  s.className = "star";
  s.textContent = "‚≠ê";
  s.style.left = "50%";
  s.style.top = "50%";
  document.body.appendChild(s);
  setTimeout(() => s.remove(), 1000);
}

/* ================= LOAD ================= */
async function refreshCreations() {
  const { data } = await supabase.from("creations").select("*").order("id");
  creations = data || [];
  render();
}

refreshCreations();
</script>
</body>
</html>
