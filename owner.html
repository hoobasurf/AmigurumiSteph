<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner</title>

<link rel="icon" href="favicon.ico">
<link rel="apple-touch-icon" href="icon-152.png">
<meta name="theme-color" content="#f2b7c9">

<style>
/* ================= BASE ================= */
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
body{margin:0;background:#fff;color:#333;overflow:hidden}

/* ================= SIDEBAR ================= */
.sidebar{
  position:fixed;left:0;top:0;bottom:0;
  width:70px;
  background:#ffe6f0;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:12px 0;
  z-index:50;
}
.sidebar button{
  width:44px;height:44px;
  border:none;
  background:#fff;
  border-radius:12px;
  margin:8px 0;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.sidebar button svg{
  width:22px;height:22px;
  stroke:#f2a3bd;
  fill:none;
  stroke-width:2;
}
.sidebar .spacer{flex:1}

/* ⚙️ bouton gestion */
#manageBtn{
  width:36px;height:36px;
  background:#fff;
  border-radius:10px;
}

/* ================= HEADER ================= */
.header{
  position:fixed;left:70px;right:0;top:0;
  height:56px;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  padding-right:16px;
  z-index:40;
  border-bottom:1px solid #eee;
}

/* mini circle photo */
#ownerPhoto{
  width:36px;height:36px;
  border-radius:50%;
  object-fit:cover;
  background:#f8c9da;
}

/* ================= GRID ================= */
.main{
  position:absolute;
  left:70px;right:0;
  top:56px;bottom:0;
  overflow-x:auto;
  overflow-y:hidden;
  display:flex;
  scroll-snap-type:x mandatory;
}
.page{
  width:100vw;
  flex-shrink:0;
  padding:16px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  grid-template-rows:repeat(2,1fr);
  gap:12px;
  scroll-snap-align:start;
}
.card{
  background:#f7f7f7;
  border-radius:14px;
  overflow:hidden;
  position:relative;
}
.card img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* ================= ACTIONS ================= */
.actions{
  position:absolute;
  bottom:8px;right:8px;
  display:flex;
  gap:8px;
}
.action-btn{
  display:flex;
  align-items:center;
  gap:4px;
  background:rgba(255,255,255,0.9);
  padding:4px 8px;
  border-radius:999px;
  font-size:13px;
  cursor:pointer;
}
.action-btn svg{
  width:16px;height:16px;
  stroke:#f2a3bd;
  fill:none;
  stroke-width:2;
}

/* ================= MODALS ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}
.modal-box{
  background:#fff;
  border-radius:16px;
  width:90%;
  max-width:420px;
  max-height:80%;
  overflow:auto;
  padding:16px;
}
.modal h2{margin-top:0}

/* bubbles */
.bubble{
  padding:6px 10px;
  background:#ffe6f0;
  border-radius:999px;
  margin:4px 0;
  font-size:14px;
}

/* commentaires */
.comment-item{
  margin-bottom:6px;
  font-size:14px;
}

/* ================= FORMS ================= */
input,textarea{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ddd;
  margin-bottom:8px;
}
button.confirm{
  background:#f2a3bd;
  color:#fff;
  border:none;
  padding:10px;
  width:100%;
  border-radius:10px;
}

/* ================= GESTION ================= */
.manage-list{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.manage-item{
  display:flex;
  gap:10px;
  align-items:center;
  cursor:pointer;
}
.manage-item img{
  width:50px;height:50px;
  border-radius:8px;
  object-fit:cover;
}
</style>
</head>

<body>

<!-- ================= SIDEBAR ================= -->
<div class="sidebar">
  <button id="addBtn">+</button>
  <div class="spacer"></div>

  <!-- ⚙️ -->
  <button id="manageBtn">
    <svg viewBox="0 0 24 24">
      <path d="M12 8a4 4 0 100 8 4 4 0 000-8z"/>
      <path d="M2 12h2m16 0h2M12 2v2m0 16v2
      M4.9 4.9l1.4 1.4m11.4 11.4l1.4 1.4
      M19.1 4.9l-1.4 1.4M6.3 17.7l-1.4 1.4"/>
    </svg>
  </button>
</div>

<!-- ================= HEADER ================= -->
<div class="header">
  <img id="ownerPhoto">
</div>

<!-- ================= MAIN ================= -->
<div class="main" id="main"></div>

<!-- ================= LIKE MODAL ================= -->
<div class="modal" id="likeModal">
  <div class="modal-box">
    <h2>Likes</h2>
    <div id="likeBubbles"></div>
    <button class="confirm" id="confirmLike">J’aime</button>
  </div>
</div>

<!-- ================= COMMENT MODAL ================= -->
<div class="modal" id="commentModal">
  <div class="modal-box">
    <h2>Commentaires</h2>
    <div id="commentBubbles"></div>
    <textarea id="commentText" placeholder="Écrire un commentaire"></textarea>
    <button class="confirm" id="confirmComment">Envoyer</button>
  </div>
</div>

<!-- ================= GESTION MODALS ================= -->
<div class="modal" id="manageModal">
  <div class="modal-box">
    <h2>Gestion Likes & Commentaires</h2>
    <button class="confirm" id="manageLikesBtn">Likes</button>
    <button class="confirm" id="manageCommentsBtn">Commentaires</button>
  </div>
</div>

<div class="modal" id="likesModal">
  <div class="modal-box">
    <h2>Gestion Likes</h2>
    <button class="confirm" id="clearAllLikes">Tout effacer</button>
    <div class="manage-list" id="likesList"></div>
  </div>
</div>

<div class="modal" id="commentsModal">
  <div class="modal-box">
    <h2>Gestion Commentaires</h2>
    <button class="confirm" id="clearAllComments">Tout effacer</button>
    <div class="manage-list" id="commentsList"></div>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://jyhbamdcxmpveujjqjla.supabase.co",
  "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa"
);

const ownerPhoto=document.getElementById('ownerPhoto');
const prenom=localStorage.getItem('prenom')||'Steph';

async function loadOwnerPhoto(){
  const {data}=await supabase.from('profiles').select('photo_url').eq('prenom',prenom).single();
  if(data?.photo_url) ownerPhoto.src=data.photo_url;
}
loadOwnerPhoto();

/* ===== LOAD CREATIONS ===== */
let creations=[];
let currentZoom=null;

async function loadCreations(){
  const {data}=await supabase.from('creations').select('*').order('created_at',{ascending:false});
  creations=data||[];
  renderGrid();
}
loadCreations();

function renderGrid(){
  const main=document.getElementById('main');
  main.innerHTML='';
  for(let i=0;i<creations.length;i+=6){
    const page=document.createElement('div');
    page.className='page';
    creations.slice(i,i+6).forEach(c=>{
      const card=document.createElement('div');
      card.className='card';
      const img=document.createElement('img');
      img.src=supabase.storage.from('images').getPublicUrl(c.image_path).data.publicUrl;
      card.appendChild(img);

      const actions=document.createElement('div');
      actions.className='actions';

      const likeBtn=document.createElement('div');
      likeBtn.className='action-btn';
      likeBtn.id='likeBtn';
      likeBtn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M12 21s-6-4.35-9-8.5A5.5 5.5 0 0112 5a5.5 5.5 0 019 7.5C18 16.65 12 21 12 21z"/></svg><span>${c.likes?.length||0}</span>`;
      likeBtn.onclick=()=>openLike(c);

      const commentBtn=document.createElement('div');
      commentBtn.className='action-btn';
      commentBtn.id='commentBtn';
      commentBtn.innerHTML=`<svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg><span>${c.comments?.length||0}</span>`;
      commentBtn.onclick=()=>openComment(c);

      actions.append(likeBtn,commentBtn);
      card.appendChild(actions);
      page.appendChild(card);
    });
    main.appendChild(page);
  }
}

/* ===== LIKE ===== */
const likeModal=document.getElementById('likeModal');
const likeBubbles=document.getElementById('likeBubbles');

function openLike(c){
  currentZoom=c;
  likeBubbles.innerHTML='';
  (c.likes||[]).forEach(l=>{
    const b=document.createElement('div');
    b.className='bubble';
    b.textContent=l.name;
    likeBubbles.appendChild(b);
  });
  likeModal.style.display='flex';
}

document.getElementById('confirmLike').onclick=async()=>{
  if(!currentZoom.likes) currentZoom.likes=[];
  currentZoom.likes.push({name:prenom});
  await supabase.from('creations').update({likes:currentZoom.likes}).eq('id',currentZoom.id);
  likeModal.style.display='none';
  loadCreations();
};

/* ===== COMMENT ===== */
const commentModal=document.getElementById('commentModal');
const commentBubbles=document.getElementById('commentBubbles');

function openComment(c){
  currentZoom=c;
  renderComments();
  commentModal.style.display='flex';
}

function renderComments(){
  commentBubbles.innerHTML='';
  (currentZoom.comments||[]).forEach(c=>{
    const d=document.createElement('div');
    d.className='comment-item';
    d.innerHTML=`<strong>${c.name}</strong> : ${c.text}`;
    commentBubbles.appendChild(d);
  });
}

document.getElementById('confirmComment').onclick=async()=>{
  const text=document.getElementById('commentText').value.trim();
  if(!text) return;
  if(!currentZoom.comments) currentZoom.comments=[];
  currentZoom.comments.push({name:prenom,text});
  await supabase.from('creations').update({comments:currentZoom.comments}).eq('id',currentZoom.id);
  document.getElementById('commentText').value='';
  renderComments();
  loadCreations();
};

/* ===== GESTION ===== */
const manageModal=document.getElementById('manageModal');
document.getElementById('manageBtn').onclick=()=>manageModal.style.display='flex';
document.getElementById('manageLikesBtn').onclick = () => {
  manageMode = 'likes';
  openManageCreations();
};

document.getElementById('manageCommentsBtn').onclick = () => {
  manageMode = 'comments';
  openManageCreations();
};

/* fermer modals */
document.querySelectorAll('.modal').forEach(m=>{
  m.onclick=e=>{if(e.target===m)m.style.display='none'}
});

  const manageItemsModal = document.getElementById('manageItemsModal');
const manageItemsList = document.getElementById('manageItemsList');
const manageItemsTitle = document.getElementById('manageItemsTitle');

const manageDetailModal = document.getElementById('manageDetailModal');
const manageDetailTitle = document.getElementById('manageDetailTitle');
const manageDetailList = document.getElementById('manageDetailList');

const confirmDeleteModal = document.getElementById('confirmDeleteModal');

let manageMode = null; // 'likes' ou 'comments'
let selectedCreation = null;
let selectedIndex = null;

function openManageCreations(){
  manageModal.style.display='none';
  manageItemsModal.style.display='flex';
  manageItemsTitle.textContent =
    manageMode === 'likes' ? 'Choisir une création (Likes)' : 'Choisir une création (Commentaires)';

  manageItemsList.innerHTML='';

  creations.forEach(c=>{
    const item=document.createElement('div');
    item.className='manage-item';

    const img=document.createElement('img');
    img.src = supabase.storage.from('images')
      .getPublicUrl(c.image_path).data.publicUrl;

    const name=document.createElement('span');
    name.textContent=c.name;

    item.append(img,name);

    item.onclick=()=>{
      selectedCreation=c;
      openManageDetails();
    };

    manageItemsList.appendChild(item);
  });
}

  function openManageDetails(){
  manageItemsModal.style.display='none';
  manageDetailModal.style.display='flex';

  manageDetailList.innerHTML='';
  manageDetailTitle.textContent =
    manageMode === 'likes' ? 'Likes' : 'Commentaires';

  const list = manageMode === 'likes'
    ? (selectedCreation.likes || [])
    : (selectedCreation.comments || []);

  list.forEach((item,index)=>{
    const div=document.createElement('div');
    div.className='bubble';
    div.textContent = manageMode === 'likes'
      ? item.name
      : `${item.name} : ${item.text}`;

    div.onclick=()=>{
      selectedIndex=index;
      confirmDeleteModal.style.display='flex';
    };

    manageDetailList.appendChild(div);
  });
}

  document.getElementById('confirmDeleteYes').onclick = async () => {
  if(manageMode === 'likes'){
    selectedCreation.likes.splice(selectedIndex,1);
    await supabase.from('creations')
      .update({likes:selectedCreation.likes})
      .eq('id',selectedCreation.id);
  }

  if(manageMode === 'comments'){
    selectedCreation.comments.splice(selectedIndex,1);
    await supabase.from('creations')
      .update({comments:selectedCreation.comments})
      .eq('id',selectedCreation.id);
  }

  confirmDeleteModal.style.display='none';
  manageDetailModal.style.display='none';
  loadCreations();
};

document.getElementById('confirmDeleteNo').onclick = () => {
  confirmDeleteModal.style.display='none';
};

  document.getElementById('clearAllLikes').onclick = async () => {
  for(const c of creations){
    await supabase.from('creations').update({likes:[]}).eq('id',c.id);
  }
  loadCreations();
};

document.getElementById('clearAllComments').onclick = async () => {
  for(const c of creations){
    await supabase.from('creations').update({comments:[]}).eq('id',c.id);
  }
  loadCreations();
};
  
</script>
<!-- ===== MODAL LISTE CREATIONS ===== -->
<div class="modal" id="manageItemsModal">
  <div class="modal-box">
    <h2 id="manageItemsTitle"></h2>
    <div class="manage-list" id="manageItemsList"></div>
  </div>
</div>

<!-- ===== MODAL DETAILS LIKE / COMMENT ===== -->
<div class="modal" id="manageDetailModal">
  <div class="modal-box">
    <h2 id="manageDetailTitle"></h2>
    <div id="manageDetailList"></div>
  </div>
</div>

<!-- ===== CONFIRM SUPPRESSION ===== -->
<div class="modal" id="confirmDeleteModal">
  <div class="modal-box">
    <p>Supprimer définitivement ?</p>
    <button class="confirm" id="confirmDeleteYes">Oui</button>
    <button class="confirm" id="confirmDeleteNo">Annuler</button>
  </div>
</div>
</body>
</html>
