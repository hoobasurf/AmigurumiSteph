<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="icon-152.png">
  <meta name="theme-color" content="#f2b7c9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    /* ===== Styles similaires à ton code original ===== */
    *{box-sizing:border-box;margin:0;padding:0;}
    html,body{height:100%;font-family:'Comic Sans MS',cursive;overflow-x:hidden;}

    body::before {
      content:"";
      position:fixed;
      top:0;left:0;width:100vw;height:100vh;
      background-image: url('Photoroom_20251223_114401.jpeg');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      z-index:-1;
    }

    .center-zone{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding-top:3.5cm;
      height:auto;
      overflow:hidden;
    }

    #visitor-list-container{
      display:flex;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
      justify-content:center;
      padding-left:1cm; 
    }

    .page{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(3, 1fr);
      column-gap:3mm;
      row-gap:4mm;
      flex:0 0 auto;
      width: calc(2 * 200px + 3mm);
      height: calc(3 * 200px + 8mm);
      scroll-snap-align:center;
      padding:4mm;
      justify-content:center;
      margin-top:0;
    }

    .visitor-item{
      position:relative;
      width:200px;
      height:200px;
      border-radius:12px;
      overflow:hidden;
      border:3px solid #fff;
      box-shadow:0 0 0 3px #f6c2d1, 0 6px 14px rgba(0,0,0,0.25), inset 0 0 0 1px rgba(255,255,255,0.4);
      background:#ffe6f0;
    }

    .visitor-item .placeholder{
      position:absolute;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:24px;
      color:#b84c6f;
      font-weight:bold;
    }

    .visitor-item img {
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:12px;
      cursor:pointer;
      display:block;
      filter: brightness(1.05) contrast(1.05) saturate(0.95);
      transition: filter 0.3s, transform 0.3s;
      position: relative;
      z-index: 2;
    }
    .visitor-item img:hover { transform: scale(1.03); }

    .visitor-item::after{
      content:"";
      position:absolute;
      inset:0;
      background:rgba(255,230,240,0.12);
      pointer-events:none;
      z-index:1;
    }

    .visitor-item p{
      position:absolute;
      bottom:2px;
      width:100%;
      font-size:14px;
      color:#b84c6f;
      font-weight:bold;
      text-align:center;
      text-shadow:1px 1px 2px rgba(255,255,255,0.8);
      z-index:3;
    }

    .delete-btn{
      position:absolute;
      top:2px;
      right:2px;
      width:20px;
      height:20px;
      background:#ffb6c1;
      color:#fff;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      cursor:pointer;
      z-index:5;
      font-size:14px;
      transition: background 0.2s;
    }
    .delete-btn:hover{background:#e94f9a;}

    #sidebar{
      position:fixed;
      top:0;left:-220px;
      width:220px;
      height:100vh;
      background:rgba(255,230,240,0.2);
      border-right:2px solid #b67385;
      padding:20px;
      transition:left .3s;
      z-index:10;
    }
    #sidebar.sidebar-open{left:0}
    #toggleSidebar{
      position:absolute;
      top:50%;
      right:-30px;
      width:30px;
      height:60px;
      background:#ffb6c1;
      border-radius:0 12px 12px 0;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-weight:bold;
    }
    #sidebar button{
      width:auto;
      padding:8px 16px;
      border-radius:16px;
      border:none;
      background:#ffb6c1;
      color:#fff;
      cursor:pointer;
      font-weight:bold;
    }

    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.6);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:10001;
    }
    .modal .modal-box{
      background:#ffe6f0;
      padding:16px 24px;
      border-radius:20px;
      border:3px solid #b67385;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      min-width:200px;
      font-family:'Comic Sans MS',cursive;
    }
    .modal input{
      padding:6px 12px;
      border-radius:10px;
      border:2px solid #b67385;
      width:100%;
    }
    .modal button{
      padding:6px 14px;
      border:none;
      background:#ffb6c1;
      color:#fff;
      border-radius:12px;
      cursor:pointer;
      font-weight:bold;
      width:100%;
    }

    #zoomModal{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.7);
      display:none;
      justify-content:center;
      align-items:center;
      flex-direction:column;
      z-index:10000;
    }
    #zoomModal img{
      max-width:80%;
      max-height:60vh;
      border:4px solid #b67385;
      border-radius:24px;
      margin-bottom:10px;
      filter:none;
    }
    #zoomModal .thumbs{
      display:flex;
      gap:8px;
      max-width:80%;
      overflow-x:auto;
    }
    #zoomModal .thumbs img{
      width:50px;
      height:50px;
      object-fit:cover;
      border-radius:12px;
      border:2px solid #b67385;
      cursor:pointer;
    }
    .closeZoom{
      position:absolute;
      top:12px;
      right:12px;
      width:28px;
      height:28px;
      background:#ffb6c1;
      color:#fff;
      border-radius:50%;
      display:flex;
      justify-content:center;
      align-items:center;
      cursor:pointer;
    }
    .actions{
      display:flex;
      gap:16px;
      margin-top:6px;
      justify-content:center;
    }
    .like-btn,.comment-btn{
      display:flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:12px;
      border:none;
      cursor:pointer;
      font-weight:bold;
      background:transparent;
      color:#b84c6f;
      font-size:14px;
    }
    .like-btn svg,.comment-btn svg{
      width:16px;
      height:16px;
      stroke:#ffb6c1;
      fill:none;
    }

    /* autres styles similaires */
  </style>
</head>
<body>

<img id="ownerPhoto" style="width:32px;height:32px;border-radius:50%;position:fixed;top:10px;right:10px;z-index:10000;" alt="Owner">

<div class="center-zone">
  <div id="visitor-list-container"></div>
</div>

<div id="sidebar">
  <div id="toggleSidebar">☰</div>
  <button id="addBtn">Ajouter</button>
</div>

<!-- MODALS (Add/Delete/Like/Comment/Zoom) -->
<!-- Copie exactement tes modals existants ici -->
<div id="addModal" class="modal">...</div>
<div id="deleteModal" class="modal">...</div>
<div id="likeModal" class="modal">...</div>
<div id="commentModal" class="modal">...</div>
<div id="zoomModal">
  <div class="closeZoom">×</div>
  <img id="mainZoom">
  <div class="thumbs" id="thumbs"></div>
  <div class="actions">
    <button class="like-btn"><svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg> <span id="likeCount">0</span></button>
    <button class="comment-btn"><svg viewBox="0 0 24 24"><path d="M21 6h-18v12h18v-12zm0-2c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2h-18c-1.1 0-2-.9-2-2v-12c0-1.1.9-2 2-2h18z"></path></svg> <span id="commentCount">0</span></button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://jyhbamdcxmpveujjqjla.supabase.co",
  "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa"
);

let currentUser = {
  prenom: localStorage.getItem('prenom') || '',
  photo: localStorage.getItem('photo') || ''
};

if (currentUser.photo) document.getElementById('ownerPhoto').src = currentUser.photo;

let creations = [];
let currentZoom = null;
let currentDelete = null;

const container = document.getElementById('visitor-list-container');
const zoomModal = document.getElementById('zoomModal');
const mainZoom = document.getElementById('mainZoom');
const thumbs = document.getElementById('thumbs');
const likeCount = document.getElementById('likeCount');
const commentCount = document.getElementById('commentCount');
const likeModal = document.getElementById('likeModal');
const likeBubbles = document.getElementById('likeBubbles');
const likeNameInput = document.getElementById('likeName');
const confirmLike = document.getElementById('confirmLike');
const commentModal = document.getElementById('commentModal');
const commentBubbles = document.getElementById('commentBubbles');
const confirmComment = document.getElementById('confirmComment');

// ================== RENDER ==================
function render(){
  container.innerHTML = '';
  let page = null;
  creations.forEach((c,i)=>{
    if(i%6===0){page=document.createElement('div');page.className='page';container.appendChild(page);}
    const d=document.createElement('div');
    d.className='visitor-item';
    d.innerHTML=`<div class="placeholder">?</div><div class="delete-btn">×</div><p>${c.name}</p><img src="${c.imgUrl||''}">`;
    const img=d.querySelector('img');
    img.onload=()=>d.querySelector('.placeholder').style.display='none';
    img.onerror=()=>img.style.display='none';
    img.onclick=()=>openZoom(c);
    d.querySelector('.delete-btn').onclick=()=>openDeleteModal(c);
    page.appendChild(d);
  });
}

// ================== ZOOM ==================
function openZoom(c){
  currentZoom=c;
  mainZoom.src=c.imgUrl;
  thumbs.innerHTML='';

  if(!c.zoomGroup||c.zoomGroup.length===0) c.zoomGroup=[c.imgUrl];
  c.zoomGroup.forEach(u=>{
    const t=document.createElement('img');
    t.src=u;
    t.onclick=()=>mainZoom.src=u;
    thumbs.appendChild(t);
  });

  updateActions();
  zoomModal.style.display='flex';

  // ✅ Listeners corrects
  document.querySelector('.like-btn').onclick=()=>{ if(currentZoom) openLikeModal(currentZoom); };
  document.querySelector('.comment-btn').onclick=()=>{ if(currentZoom) openCommentModal(currentZoom); };
}

function updateActions(){
  likeCount.textContent=currentZoom.likes?.length||0;
  commentCount.textContent=currentZoom.comments?.length||0;
}

// ================== LIKE ==================
function openLikeModal(c){
  likeBubbles.innerHTML='';
  (c.likes||[]).forEach(like=>{
    const b=document.createElement('div');
    b.className='bubble';
    if(like.photo) b.innerHTML=`<img src="${like.photo}" style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;">${like.name}`;
    else b.textContent=like.name;
    likeBubbles.appendChild(b);
  });
  likeNameInput.value=currentUser.prenom||'';
  likeModal.style.display='flex';
}

confirmLike.onclick=async ()=>{
  const name=likeNameInput.value.trim();
  if(!name||!currentZoom) return;
  if(!currentZoom.likes) currentZoom.likes=[];
  currentZoom.likes.push({name, photo:currentUser.photo||''});
  await supabase.from('creations').update({likes:currentZoom.likes}).eq('id',currentZoom.id);
  openLikeModal(currentZoom);
  updateActions();
  likeModal.style.display='none';
}

// ================== COMMENT ==================
function openCommentModal(c){
  renderCommentList();
  document.getElementById('commentName').value=currentUser.prenom||'';
  document.getElementById('commentText').value='';
  commentModal.style.display='flex';
}

function renderCommentList(){
  commentBubbles.innerHTML='';
  (currentZoom.comments||[]).forEach(c=>{
    const item=document.createElement('div');
    item.className='comment-item';
    const text=document.createElement('span');
    text.innerHTML=`${c.photo?`<img src="${c.photo}" style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;">`:''}<strong>${c.name}</strong> : ${c.text}`;
    item.appendChild(text);
    commentBubbles.appendChild(item);
  });
  commentCount.textContent=currentZoom.comments?.length||0;
}

confirmComment.onclick=async ()=>{
  const name=document.getElementById('commentName').value.trim();
  const text=document.getElementById('commentText').value.trim();
  if(!name||!text||!currentZoom) return;
  if(!currentZoom.comments) currentZoom.comments=[];
  currentZoom.comments.push({name,text,photo:currentUser.photo||'',likes:[]});
  await supabase.from('creations').update({comments:currentZoom.comments}).eq('id',currentZoom.id);
  renderCommentList();
  document.getElementById('commentText').value='';
}

// ================== DELETE / AJOUT / REFRESH ==================
function openDeleteModal(c){currentDelete=c;document.getElementById('deleteModal').style.display='flex';}
document.getElementById('cancelDelete').onclick=()=>{currentDelete=null;document.getElementById('deleteModal').style.display='none';};
document.getElementById('confirmDelete').onclick=async()=>{
  if(!currentDelete?.id) return;
  await supabase.from('creations').delete().eq('id',currentDelete.id);
  currentDelete=null;
  document.getElementById('deleteModal').style.display='none';
  refreshCreations();
};

document.getElementById('addBtn').onclick=()=>document.getElementById('addModal').style.display='flex';
document.getElementById('addModal').addEventListener('click',e=>{if(e.target===document.getElementById('addModal')) document.getElementById('addModal').style.display='none';});

async function refreshCreations(){
  const {data,error}=await supabase.from('creations').select('*').order('created_at',{ascending:false});
  if(error){console.error(error);return;}
  creations=data.map(c=>{
    const zoomGroup=(c.images&&c.images.length)?c.images.map(p=>supabase.storage.from('images').getPublicUrl(p).data.publicUrl):[supabase.storage.from('images').getPublicUrl(c.image_path).data.publicUrl];
    return {id:c.id,name:c.name,imgUrl:zoomGroup[0],zoomGroup,likes:c.likes||[],comments:c.comments||[]};
  });
  render();
}

// ================== START ==================
refreshCreations();

// ===== CLOSE MODALS =====
document.querySelector('.closeZoom').onclick=()=>zoomModal.style.display='none';
</script>

</body>
</html>
