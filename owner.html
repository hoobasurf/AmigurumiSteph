<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="icon-152.png">
<meta name="theme-color" content="#f2b7c9">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
/* =================== RESET & FOND =================== */
* { box-sizing:border-box;margin:0;padding:0;font-family:'Comic Sans MS',cursive; }
html,body{height:100%;overflow-x:hidden;}
body::before{
  content:"";position:fixed;top:0;left:0;width:100vw;height:100vh;
  background-image:url('Photoroom_20251223_114401.jpeg');
  background-size:cover;background-position:center center;background-repeat:no-repeat;z-index:-1;
}

/* =================== ZONE CENTRALE =================== */
.center-zone{
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding-top:3.5cm;
  overflow:hidden;
  height:auto;
}

/* =================== CONTENEUR DES PAGES (SCROLL HORIZONTAL) =================== */
#visitor-list-container{
  display:flex;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling: touch;
  justify-content:center;
  padding-left:1cm;
}

/* =================== PAGE 3x2 CARTES =================== */
.page{
  display:grid;
  grid-template-columns:repeat(2, 120px);
  grid-template-rows:repeat(3, 120px);
  column-gap:8px;
  row-gap:8px;
  flex:0 0 auto;
  scroll-snap-align:start;
  padding:4px;
}

/* =================== CARTE CREATION =================== */
.creation{
  position:relative;
  width:120px;
  height:120px;
  border-radius:12px;
  overflow:hidden;
  border:3px solid #fff;
  background:#ffe6f0;
  box-shadow:
    0 0 0 3px #f6c2d1,
    0 6px 14px rgba(0,0,0,0.25),
    inset 0 0 0 1px rgba(255,255,255,0.4);
  cursor:pointer;
}
.creation img{
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:12px;
  transition:transform 0.3s;
  position:relative;
  z-index:2;
}
.creation img:hover{ transform:scale(1.03); }
.creation::after{
  content:"";
  position:absolute;
  inset:0;
  background:rgba(255,230,240,0.12);
  pointer-events:none;
  z-index:1;
}
.creation p{
  position:absolute;
  bottom:2px;
  width:100%;
  text-align:center;
  font-size:14px;
  font-weight:bold;
  color:#b84c6f;
  z-index:3;
  -webkit-text-stroke:0.6px #000;
  text-shadow:1px 1px 0 #000,-1px 1px 0 #000,1px -1px 0 #000,-1px -1px 0 #000;
}

/* =================== SIDEBAR =================== */
#sidebar{position:fixed;top:0;left:-220px;width:220px;height:100vh;background:rgba(255,230,240,0.2);border-right:2px solid #b67385;padding:20px;transition:left .3s;z-index:10;}
#sidebar.sidebar-open{left:0;}
#toggleSidebar{position:absolute;top:50%;right:-30px;width:30px;height:60px;background:#ffb6c1;border-radius:0 12px 12px 0;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;}
#sidebar button{width:auto;padding:8px 16px;border-radius:16px;border:none;background:#ffb6c1;color:#fff;cursor:pointer;font-weight:bold;display:block;margin-top:10px;}

/* =================== MODALS =================== */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:10001;}
.modal .modal-box{
  background:#ffe6f0;padding:16px 24px;border-radius:20px;border:3px solid #b67385;
  display:flex;flex-direction:column;gap:10px;align-items:center;min-width:200px;font-family:'Comic Sans MS',cursive;
}
.modal input{padding:6px 12px;border-radius:10px;border:2px solid #b67385;width:100%;}
.modal button{padding:6px 14px;border:none;background:#ffb6c1;color:#fff;border-radius:12px;cursor:pointer;font-weight:bold;width:100%;}

/* =================== ZOOM MODAL =================== */
#zoomModal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:10000;}
#zoomModal img{max-width:80%;max-height:60vh;border:4px solid #b67385;border-radius:24px;margin-bottom:10px;}
#zoomModal .thumbs{display:flex;gap:8px;max-width:80%;overflow-x:auto;}
#zoomModal .thumbs img{width:50px;height:50px;object-fit:cover;border-radius:12px;border:2px solid #b67385;cursor:pointer;}
.closeZoom{position:absolute;top:12px;right:12px;width:28px;height:28px;background:#ffb6c1;color:#fff;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;}

/* =================== OWNER PHOTO =================== */
#ownerPhoto{width:32px;height:32px;border-radius:50%;position:fixed;top:10px;right:10px;z-index:10000;background:#ffe6f0;border:2px solid #b84c6f;}

/* =================== CHAT =================== */
.chat-overlay{position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 20000;}
.chat-window{width:360px;height:230px;background:#ffe6f0;border-radius:20px;border:2px solid #b67385;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 12px 24px rgba(0,0,0,0.25);position:relative;transition:width 0.3s,height 0.3s;}
.chat-header{height:40px;background:linear-gradient(#ffd6e6,#ffb6c1);display:flex;align-items:center;justify-content:space-between;padding:0 10px;font-weight:bold;color:#b84c6f;flex-shrink:0;position:sticky;top:0;z-index:10;font-size:14px;}
.chat-body{flex:1;display:flex;min-height:0;}
.chat-sidebar{width:120px;background:#fff5fa;border-right:2px solid #f3b3c8;overflow-y:auto;}
.chat-user{display:flex;align-items:center;gap:6px;padding:4px;cursor:pointer;transition:background 0.2s;font-size:12px;}
.chat-user.active{background:#ffd6e6;}
.chat-user img{border-radius:50%;width:28px;height:28px;object-fit:cover;}
.chat-content{flex:1;display:flex;flex-direction:column;min-height:0;}
.chat-messages{flex:1;padding:6px;overflow-y:auto;background:#fffafa;font-size:12px;}
.msg{max-width:70%;padding:4px 8px;margin-bottom:4px;border-radius:12px;}
.msg-me{background:#ffb6c1;align-self:flex-end;}
.msg-them{background:#ffffff;border:1px solid #f3b3c8;}
.chat-input{display:flex;padding:4px;gap:4px;}
.chat-input input{flex:1;border-radius:10px;border:2px solid #b67385;padding:4px 6px;font-size:12px;}
.chat-icon-btn{background:transparent;border:none;cursor:pointer;padding:2px;display:flex;align-items:center;}
.expanded .chat-window{width:720px;height:460px;border-radius:24px;}

/* =================== RESPONSIVE =================== */
@media(max-width:480px){
  .page{grid-template-columns:repeat(2,120px);grid-template-rows:repeat(3,120px);width:calc(2*120px+8px);height:calc(3*120px+16px);}
  .creation{width:120px;height:120px;}
  .modal .modal-box{min-width:180px;}
}
    </style>
</head>
<body>

<img id="ownerPhoto" alt="Owner">

<div class="center-zone">
  <div id="page"></div>
</div>

<div id="sidebar">
  <div id="toggleSidebar">‚ò∞</div>
  <button id="addBtn">Ajouter</button>
  <button id="pelotesBtn">Pelotes</button>
  <button id="videoBtn">Vid√©o</button>
  <button id="notesBtn">Notes</button>
  <button id="messagerieBtn">Messagerie</button>
  
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="#ffb6c1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings">
    <circle cx="12" cy="12" r="3"/>
    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l0 0a2 2 0 1 1-2.83 2.83l0 0a1.65 1.65 0 0 0-1.82.33l0 0a1.65 1.65 0 0 0-.5 1.51l0 0a2 2 0 1 1-3.18 0l0 0a1.65 1.65 0 0 0-1.51-.5l0 0a1.65 1.65 0 0 0-.33-1.82l0 0a2 2 0 1 1 0-2.83l0 0a1.65 1.65 0 0 0 .33-1.82l0 0a1.65 1.65 0 0 0-1.51-.5l0 0a2 2 0 1 1 0-3.18l0 0a1.65 1.65 0 0 0 .5-1.51l0 0a1.65 1.65 0 0 0 1.82-.33l0 0a2 2 0 1 1 2.83 0l0 0a1.65 1.65 0 0 0 1.82.33l0 0a1.65 1.65 0 0 0 .5 1.51l0 0a2 2 0 1 1 3.18 0l0 0a1.65 1.65 0 0 0 1.51.5l0 0a1.65 1.65 0 0 0 .33 1.82l0 0a2 2 0 1 1 0 2.83l0 0a1.65 1.65 0 0 0-.33 1.82l0 0a1.65 1.65 0 0 0 1.51.5z"/>
  </svg>
</button>
</div>

<!-- Modals -->
<div id="addModal" class="modal">
  <div class="modal-box">
    <h2>Ajouter des photos</h2>
    <input id="photoName" placeholder="Nom du projet">

<!-- L√âGENDE -->
<input id="photoLegend" placeholder="L√©gende (optionnel)">

<!-- INPUT FILE CACH√â -->
<input type="file" id="multiPhoto" multiple hidden>

<!-- BOUTON PASTEL ROSE -->
<button id="fileBtn" class="pink-file-btn">Choisir des photos</button>

<span id="fileInfo" style="font-size:12px;color:#b84c6f;"></span>

<button id="confirmAdd">Valider</button>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-box">
    <p>Supprimer d√©finitivement ce projet ?</p>
    <button id="confirmDelete">Oui</button>
    <button id="cancelDelete">Annuler</button>
  </div>
</div>

<!-- ====== LIKE MODAL ====== -->
<div id="likeModal" class="modal">
  <div class="modal-box">
    <h3>Like ‚ù§Ô∏è</h3>
    <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
      <input type="text" id="likeName" readonly style="flex:1; padding:4px 8px; border:2px solid #b67385; border-radius:8px; background:#ffe6f0;">
    </div>
    <button id="confirmLike">Valider</button>
    <div class="bubble-container" id="likeBubbles" style="margin-top:12px; max-height:120px; overflow-y:auto;"></div>
  </div>
</div>

<!-- ====== COMMENT MODAL ====== -->
<div id="commentModal" class="modal">
  <div class="modal-box comment-box">
    <div class="expand-btn" id="expandComment">‚§¢</div>
    <h3>Commentaire üí¨</h3>
    <div class="comment-list" id="commentBubbles" style="max-height:160px; overflow-y:auto; margin-bottom:8px;"></div>
    <div style="display:flex; flex-direction:column; gap:6px;">
      <input type="text" id="commentName" readonly style="flex:1; padding:4px 8px; border:2px solid #b67385; border-radius:8px; background:#ffe6f0; margin-bottom:8px;">
      <input type="text" id="commentText" placeholder="Votre commentaire" style="padding:4px 8px; border:2px solid #b67385; border-radius:8px;">
      <button id="confirmComment">Envoyer</button>
    </div>
  </div>
</div>

<div id="zoomModal">
  <div class="closeZoom">√ó</div>
  <img id="mainZoom">
  <div id="zoomLegend" style="
  max-width: 260px;
  padding: 10px;
  color: #b84c6f;
  font-size: 14px;
  background: transparent;
  align-self: flex-start;
"></div>
  <div class="thumbs" id="thumbs"></div>
  <div class="actions">
    <div class="actions" style="display:flex; gap:12px; align-items:center; margin-top:8px;">
  <div class="icon-btn" id="likeBtn" style="display:flex; align-items:center; cursor:pointer; gap:4px;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#b84c6f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 21C12 21 4 13.5 4 8.5C4 5.5 6.5 3 9.5 3C11 3 12 4 12 4C12 4 13 3 14.5 3C17.5 3 20 5.5 20 8.5C20 13.5 12 21 12 21Z"></path>
    </svg>
    <span id="likeCount">0</span>
  </div>

  <div class="icon-btn" id="commentBtn" style="display:flex; align-items:center; cursor:pointer; gap:4px;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#b84c6f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span id="commentCount">0</span>
  </div>
</div>
  </div>
</div>

<!-- Modal Gestion -->
<div id="manageModal" class="modal">
  <div class="modal-box">
    <h2>Gestion Likes, Commentaires</h2>
    <button id="manageLikesBtn">Likes</button>
    <button id="manageCommentsBtn">Commentaires</button>
  </div>
</div>

<!-- Modal Likes -->
<div id="likesModal" class="modal">
  <div class="modal-box" style="max-height:80vh; overflow-y:auto;">
    <h2>Likes</h2>
    <button id="chooseLikeBtn">Choisir individuellement</button>
    <button id="clearLikesBtn">Tout effacer</button>
    <div id="likesList"></div>
  </div>
</div>

<!-- Modal Commentaires -->
<div id="commentsModal" class="modal">
  <div class="modal-box" style="max-height:80vh; overflow-y:auto;">
    <h2>Commentaires</h2>
    <button id="chooseCommentBtn">Choisir individuellement</button>
    <button id="clearCommentsBtn">Tout effacer</button>
    <div id="commentsList"></div>
  </div>
</div>

<!-- Modal suppression individuelle -->
<div id="deleteIndivModal" class="modal">
  <div class="modal-box">
    <p>Supprimer d√©finitivement ce Like/Commentaire ?</p>
    <button id="confirmDeleteIndiv">Oui</button>
    <button id="cancelDeleteIndiv">Annuler</button>
  </div>
</div>

<!-- Modal Supprimer Like -->
<div id="deleteLikeModal" class="modal">
  <div class="modal-box">
    <h3>Supprimer Like</h3>
    <button id="chooseLikesBtn">Choisir</button>
  </div>
</div>

<!-- Modal Supprimer Commentaire -->
<div id="deleteCommentModal" class="modal">
  <div class="modal-box">
    <h3>Supprimer Commentaire</h3>
    <button id="chooseCommentsBtn">Choisir</button>
  </div>
</div>

<!-- Modal S√©lection Cr√©ations -->
<div id="selectCreationModal" class="modal">
  <div class="modal-box">
    <h3>S√©lectionner les cr√©ations</h3>
    <div id="selectCreationList" style="max-height:60vh;overflow-y:auto;display:flex;flex-direction:column;gap:6px;"></div>
    <button id="clearSelectedBtn">Tout effacer</button>
  </div>
</div>

<!-- ====== MESSAGERIE ====== -->
<div id="chatModal" class="chat-overlay">
  <div class="chat-window">

    <!-- HEADER -->
    <div class="chat-header">
      <span class="chat-title">Messagerie</span>

      <button id="toggleChatSize" class="chat-icon-btn" aria-label="Agrandir / R√©duire">
        <svg id="chatResizeIcon" width="20" height="20" viewBox="0 0 24 24"
          fill="none" stroke="#b84c6f" stroke-width="2" stroke-linecap="round">
          <path d="M4 9V4h5M20 15v5h-5M15 4h5v5M9 20H4v-5"/>
        </svg>
      </button>
    </div>

    <!-- BODY -->
    <div class="chat-body">

      <!-- CONTACTS -->
      <div class="chat-sidebar" id="chatUserList">
        <!-- Liste vide par d√©faut -->
      </div>

      <!-- CONVERSATION -->
      <div class="chat-content">
        <div class="chat-messages" id="chatMessages">
          <!-- Messages dynamiques -->
        </div>

        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="√âcrire un message‚Ä¶">
          <button id="sendMsgBtn">‚û§</button>
        </div>
      </div>

    </div>
  </div>
</div>

  <script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://jyhbamdcxmpveujjqjla.supabase.co",
  "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa"
);

// ====== VARIABLES GLOBALES ======
const ownerPhoto = document.getElementById('ownerPhoto');
const prenom = localStorage.getItem('prenom');
const chatUserList = document.getElementById('chatUserList');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendMsgBtn = document.getElementById('sendMsgBtn');
const container = document.getElementById('visitor-list-container');
const addModal = document.getElementById('addModal');
const deleteModal = document.getElementById('deleteModal');
const zoomModal = document.getElementById('zoomModal');
const sidebar = document.getElementById('sidebar');
const mainZoom = document.getElementById('mainZoom');
const thumbs = document.getElementById('thumbs');
const likeCount = document.getElementById('likeCount');
const commentCount = document.getElementById('commentCount');
const likeModal = document.getElementById('likeModal');
const likeBubbles = document.getElementById('likeBubbles');
const confirmLike = document.getElementById('confirmLike');
const likeNameInput = document.getElementById('likeName');
const commentModal = document.getElementById('commentModal');
const confirmComment = document.getElementById('confirmComment');
const commentBubbles = document.getElementById('commentBubbles');
const commentNameInput = document.getElementById('commentName');
const commentTextInput = document.getElementById('commentText');
const chatModal = document.getElementById('chatModal');
const toggleChatSize = document.getElementById('toggleChatSize');
const icon = document.getElementById('chatResizeIcon');
const fileBtn = document.getElementById('fileBtn');
const fileInput = document.getElementById('multiPhoto');
const fileInfo = document.getElementById('fileInfo');

fileBtn.onclick = () => fileInput.click();

fileInput.onchange = () => {
  fileInfo.textContent = fileInput.files.length
    ? `${fileInput.files.length} photo(s) s√©lectionn√©e(s)`
    : '';
};

    
let creations = [];
let currentZoom = null;
let currentDelete = null;
const myPrenom = localStorage.getItem('prenom');
let currentChatUser = localStorage.getItem('currentChatUser') || null;
let userPhotos = {};

// ====== OWNER PHOTO ======
async function loadOwnerPhoto() {
  if (!prenom) return;
  const { data, error } = await supabase.from('profiles').select('photo_url').eq('prenom', prenom).single();
  if (!error && data?.photo_url) ownerPhoto.src = data.photo_url;
  ownerPhoto.style.opacity = data?.photo_url ? '1' : '0.3';
}

document.addEventListener('DOMContentLoaded', loadOwnerPhoto);
window.addEventListener('pageshow', loadOwnerPhoto);

// ====== MESSAGERIE ======
async function loadMessages() {
  if (!currentChatUser) return;

  const { data, error } = await supabase
    .from('messages')
    .select('*')
    .or(
      `and(sender.eq.${myPrenom},receiver.eq.${currentChatUser}),
       and(sender.eq.${currentChatUser},receiver.eq.${myPrenom})`
    )
    .order('created_at', { ascending: true });

  if (error) return console.error(error);

  chatMessages.innerHTML = '';

  data.forEach(msg => {
    const div = document.createElement('div');
    div.className = 'msg ' + (msg.sender === myPrenom ? 'msg-me' : 'msg-them');

    const circle = document.createElement('img');
    circle.style.width = '24px';
    circle.style.height = '24px';
    circle.style.borderRadius = '50%';
    circle.style.marginRight = '6px';
    circle.style.verticalAlign = 'middle';
    circle.src = msg.sender === myPrenom ? ownerPhoto.src || 'icon-152.png' : userPhotos[msg.sender] || 'icon-152.png';

    const p = document.createElement('p');
    p.style.display = 'inline-block';
    p.style.margin = 0;
    p.textContent = msg.content;

    div.appendChild(circle);
    div.appendChild(p);

    chatMessages.appendChild(div);
  });

  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Envoi message
sendMsgBtn.onclick = async () => {
  const text = chatInput.value.trim();
  if (!text || !currentChatUser) return;
  await supabase.from('messages').insert({ sender: myPrenom, receiver: currentChatUser, content: text });
  chatInput.value = '';
  loadMessages();
};

// Temps r√©el messagerie
supabase.channel('public:messages').on(
  'postgres_changes',
  { event: '*', schema: 'public', table: 'messages' },
  payload => {
    const msg = payload.new;
    if (!msg) return;

    if (msg.receiver === prenom) {
      if (msg.sender !== currentChatUser) showInAppNotification(msg.sender, msg.content);
      if (msg.sender === currentChatUser) loadMessages();
    }
  }
).subscribe();

    
// ====== LOAD USERS ======
async function loadChatUsers() {
  try {
    const { data: users, error } = await supabase.from('profiles').select('prenom, photo_url').neq('prenom', myPrenom);
    if (error) throw error;
    chatUserList.innerHTML = '';
    users.forEach(u => {
      userPhotos[u.prenom] = u.photo_url || 'icon-152.png';
      const div = document.createElement('div');
      div.className = 'chat-user';
      const img = document.createElement('img');
      img.src = u.photo_url || 'icon-152.png';
      img.alt = u.prenom;
      const span = document.createElement('span');
      span.textContent = u.prenom;
      div.appendChild(img);
      div.appendChild(span);
      div.onclick = () => {
        currentChatUser = u.prenom;
        localStorage.setItem('currentChatUser', u.prenom);
        loadMessages();
        document.querySelectorAll('.chat-user').forEach(el => el.classList.remove('active'));
        div.classList.add('active');
      };
      chatUserList.appendChild(div);
    });

    // Restore active user
    if (currentChatUser) {
      setTimeout(() => {
        document.querySelectorAll('.chat-user').forEach(el => {
          if (el.textContent.includes(currentChatUser)) el.classList.add('active');
        });
      }, 500);
      loadMessages();
    }

  } catch (err) { console.error(err); }
}

// ====== NOTIFICATIONS ======
function showInAppNotification(sender, message) {
  if (document.hidden) {
    if (Notification.permission === 'granted') {
      new Notification(sender, { body: message, icon: userPhotos[sender] || 'icon-152.png' });
    }
  } else {
    const notif = document.createElement('div');
    notif.textContent = `${sender} : ${message}`;
    notif.style.cssText = `
      position:fixed;
      bottom:20px;
      right:20px;
      background:#ffb6c1;
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      z-index:99999;
      font-size:12px;
    `;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 3000);
  }
}
if ('Notification' in window && Notification.permission !== 'granted') Notification.requestPermission();
// ====== CREATIONS ======

async function refreshCreations() {
  try {
    const { data, error } = await supabase
      .from('creations')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error(error);
      return;
    }

    creations = data.map(c => {
      let zoomGroup = [];

      if (Array.isArray(c.images) && c.images.length) {
        zoomGroup = c.images.map(p =>
          supabase.storage.from('images').getPublicUrl(p).data.publicUrl
        );
      } else if (c.image_path) {
        zoomGroup = [
          supabase.storage.from('images').getPublicUrl(c.image_path).data.publicUrl
        ];
      }

      return {
        id: c.id,
        name: c.name || '',
        legend: c.legend || '',
        imgUrl: zoomGroup[0] || '',
        zoomGroup,
        likes: Array.isArray(c.likes) ? c.likes : [],
        comments: Array.isArray(c.comments) ? c.comments : []
      };
    });

    renderCreations(creations);

  } catch (e) {
    console.error('refreshCreations crash', e);
  }
}

// ====== RENDER ======
function renderCreations(list) {
  const page = document.getElementById('page');
  page.innerHTML = '';

  list.forEach(c => {
    const d = document.createElement('div');
    d.className = 'creation';

    // CLICK SUR LA CARD
    d.onclick = () => openZoom(c);

    const img = document.createElement('img');
    img.src = c.imgUrl || '';
    d.appendChild(img);

    if (c.legend) {
      const p = document.createElement('p');
      p.textContent = c.legend;
      d.appendChild(p);
    }

    page.appendChild(d);
  });
}
// ====== ZOOM ======
function openZoom(c) {
  currentZoom = creations.find(x => x.id === c.id);
  mainZoom.src = currentZoom.imgUrl;
  document.getElementById('zoomLegend').textContent = currentZoom.legend || '';
  thumbs.innerHTML = '';
  (currentZoom.zoomGroup || []).forEach(u => {
    const t = document.createElement('img'); t.src = u;
    t.onclick = () => mainZoom.src = u;
    thumbs.appendChild(t);
  });
  updateActions();
  zoomModal.style.display = 'flex';
}
function updateActions() {
  if (!currentZoom) return;
  likeCount.textContent = (currentZoom.likes || []).length;
  commentCount.textContent = (currentZoom.comments || []).length;
}

// ====== LIKE / COMMENT MODAL ======
document.getElementById('likeBtn').onclick = () => {
  if (!currentZoom) { alert("S√©lectionnez d'abord une image !"); return; }
  likeNameInput.value = myPrenom || '';
  renderLikeList();
  likeModal.style.display = 'flex';
};
confirmLike.onclick = async () => {
  if (!currentZoom) return;
  const name = likeNameInput.value.trim();
  if (!name) return;
  currentZoom.likes = currentZoom.likes || [];
  if (!currentZoom.likes.some(l => l.name === name)) currentZoom.likes.push({ name, photo: ownerPhoto.src || '' });
  await supabase.from('creations').update({ likes: currentZoom.likes }).eq('id', currentZoom.id);
  renderLikeList();
  likeModal.style.display = 'none';
};

document.getElementById('commentBtn').onclick = () => {
  if (!currentZoom) return;
  commentNameInput.value = myPrenom || '';
  commentTextInput.value = '';
  renderCommentList();
  commentModal.style.display = 'flex';
};
confirmComment.onclick = async () => {
  if (!currentZoom) return;
  const name = commentNameInput.value.trim();
  const text = commentTextInput.value.trim();
  if (!name || !text) return;
  currentZoom.comments = currentZoom.comments || [];
  currentZoom.comments.push({ name, text, photo: ownerPhoto.src || '' });
  await supabase.from('creations').update({ comments: currentZoom.comments }).eq('id', currentZoom.id);
  renderCommentList();
  commentTextInput.value = '';
  commentCount.textContent = currentZoom.comments.length;
};

function renderLikeList() {
  if (!currentZoom) return;
  likeBubbles.innerHTML = '';
  (currentZoom.likes || []).forEach(l => {
    const div = document.createElement('div');
    div.className = 'like-item';
    div.innerHTML = `${l.photo ? `<img src="${l.photo}" style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;">` : ''}<strong>${l.name}</strong>`;
    likeBubbles.appendChild(div);
  });
  likeCount.textContent = (currentZoom.likes || []).length;
}

function renderCommentList() {
  if (!currentZoom) return;
  commentBubbles.innerHTML = '';
  (currentZoom.comments || []).forEach(c => {
    const div = document.createElement('div');
    div.className = 'comment-item';
    div.innerHTML = `${c.photo ? `<img src="${c.photo}" style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;">` : ''}<strong>${c.name}</strong>: ${c.text}`;
    commentBubbles.appendChild(div);
  });
  commentCount.textContent = (currentZoom.comments || []).length;
}

// ====== ADD CREATION ======
document.getElementById('addBtn').onclick = () => addModal.style.display = 'flex';

// Fermer modal en cliquant sur le fond
addModal.addEventListener('click', e => { 
  if (e.target === addModal) addModal.style.display = 'none'; 
});

document.getElementById('confirmAdd').onclick = async e => {
  e.stopPropagation();
  const name = document.getElementById('photoName').value.trim();
  const legend = document.getElementById('photoLegend').value.trim();
  const files = document.getElementById('multiPhoto').files;

  if (!name || !files.length) { 
    alert("Mettre un nom et choisir au moins une photo"); 
    return; 
  }

  const paths = [];
  const urls = [];

  for (let file of files) {
    const path = `${Date.now()}_${file.name}`;
    const { error: uploadError } = await supabase.storage.from('images').upload(path, file);
    if (uploadError) { 
      console.error(uploadError); 
      continue; 
    }

    const { data: pubData } = supabase.storage.from('images').getPublicUrl(path);
    if (!pubData?.publicUrl) continue;
    urls.push(pubData.publicUrl);
    paths.push(path);
  }

  if (!urls.length) return;

  await supabase.from('creations').insert([{
    name,
    legend,
    image_path: paths[0], // premi√®re image pour l'affichage principal
    images: paths,
    likes: [],
    comments: []
  }]);

  // Reset modal et refresh
  addModal.style.display = 'none';
  document.getElementById('photoName').value = '';
  document.getElementById('multiPhoto').value = '';
  document.getElementById('photoLegend').value = '';
  await refreshCreations();
};

// ====== DELETE CREATION ======

function openDeleteModal(c) {
  currentDelete = c;
  deleteModal.style.display = 'flex';
}

document.getElementById('cancelDelete').onclick = () => { 
  currentDelete = null; 
  deleteModal.style.display = 'none'; 
};

document.getElementById('confirmDelete').onclick = async () => {
  if (!currentDelete?.id) return;

  // Supprime du storage toutes les images de cette cr√©ation
  if (Array.isArray(currentDelete.zoomGroup)) {
    for (let url of currentDelete.zoomGroup) {
      const path = url.split('/').pop().split('?')[0]; // r√©cup√®re le nom du fichier
      await supabase.storage.from('images').remove([path]).catch(e => console.error(e));
    }
  }

  // Supprime de la base de donn√©es
  await supabase.from('creations').delete().eq('id', currentDelete.id);

  currentDelete = null;
  deleteModal.style.display = 'none';
  await refreshCreations();
};

// ====== SIDEBAR ======
document.getElementById('pelotesBtn').onclick = () => { document.body.style.opacity='0'; setTimeout(()=>window.location.href='pelotes.html',500); };
document.getElementById('videoBtn').onclick = () => { document.body.style.opacity='0'; setTimeout(()=>window.location.href='video.html',500); };
document.getElementById('notesBtn').onclick = () => { document.body.style.opacity='0'; setTimeout(()=>window.location.href='notes.html',500); };
document.getElementById('messagerieBtn').onclick = () => { chatModal.style.display='flex'; };
document.getElementById('toggleSidebar').onclick = () => sidebar.classList.toggle('sidebar-open');
// ====== FERMETURE MESSAGERIE AU CLIC DANS LE VIDE ======
chatModal.addEventListener('click', (e) => {
  // si on clique sur le fond (overlay)
  if (e.target === chatModal) {
    chatModal.style.display = 'none';
  }
});

// emp√™cher la fermeture quand on clique dans la fen√™tre
document.querySelector('.chat-window').addEventListener('click', (e) => {
  e.stopPropagation();
});
// ====== MODALS ======
[zoomModal, likeModal, commentModal, deleteModal, addModal].forEach(m => {
  m.onclick = e => { if (e.target === m) m.style.display = 'none'; }
});
document.querySelector('.closeZoom').onclick = () => zoomModal.style.display = 'none';

// ====== CHAT MODAL ======
toggleChatSize.onclick = () => {
  chatModal.classList.toggle('expanded');
  icon.innerHTML = chatModal.classList.contains('expanded')
    ? '<path d="M9 4H4v5M15 20h5v-5M20 9V4h-5M4 15v5h5"/>'
    : '<path d="M4 9V4h5M20 15v5h-5M15 4h5v5M9 20H4v-5"/>';
};

// Pinch zoom deux doigts
let initialDistance = null;
chatModal.addEventListener('touchstart', e => { if(e.touches.length===2) initialDistance=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY); });
chatModal.addEventListener('touchmove', e => {
  if (e.touches.length===2 && initialDistance) {
    const currentDistance=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    if(currentDistance-initialDistance>40) chatModal.classList.add('expanded');
    if(initialDistance-currentDistance>40) chatModal.classList.remove('expanded');
  }
});
chatModal.addEventListener('touchend',()=>{initialDistance=null;});

loadOwnerPhoto();
loadChatUsers();
refreshCreations();
  
</script>


</body>
</html>
