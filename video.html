<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes vid√©os</title>
<style>
html, body { margin:0; padding:0; height:100%; font-family:'Comic Sans MS', cursive; transition: opacity 0.5s; }

/* FOND IMAGE */
body::before {
  content:"";
  position:fixed;
  inset:0;
  background-image:url('Photoroom_20260106_224222.png');
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  z-index:-1;
}

/* SIDEBAR */
#sidebar{
  position:fixed; top:0; left:-220px; width:220px; height:100vh;
  background:rgba(255,230,240,0.2); border-right:2px solid #b67385; padding:20px;
  transition:left .3s; z-index:100;
}
#sidebar.sidebar-open{ left:0; }
#toggleSidebar{
  position:absolute; top:50%; right:-30px; width:30px; height:60px;
  background:#ffb6c1; border-radius:0 12px 12px 0; display:flex;
  align-items:center; justify-content:center; cursor:pointer; font-weight:bold; color:white;
}
#sidebar button{
  width:auto; padding:8px 16px; border-radius:16px; border:none;
  background:#ffb6c1; color:#fff; cursor:pointer; font-weight:bold; margin-top:10px;
}

/* LISTE VIDEOS */
#video-list { display:flex; flex-direction:column; gap:10px; max-width:360px; margin:auto; margin-top:60px; }
.video-item {
  background: rgba(255,182,193,0.4);
  padding:10px 16px; border-radius:12px;
  display:flex; justify-content:space-between; align-items:center;
  cursor:pointer; border:2px solid #b67385; color:#b84c6f; font-weight:bold;
}
.video-item span { flex:1; }
.video-item div { display:flex; gap:5px; }

/* BOUTONS OUVRIR & RENOMMER */
.video-item button {
  background:#ffb6c1;
  color:white;
  border:none;
  border-radius:12px;
  padding:4px 8px;
  cursor:pointer;
  font-weight:bold;
}

/* MODAL */
.modal { position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.5); z-index:1000; }
.modal-content{ background:#fff0f6; padding:20px; border-radius:12px; max-width:90%; width:500px; text-align:center; display:flex; flex-direction:column; gap:10px; max-height:90vh; overflow-y:auto; }
.modal-content input{ padding:6px 12px; border-radius:10px; border:2px solid #b67385; width:100%; font-family: inherit; box-sizing:border-box; }
.modal-content button{ padding:6px 12px; border:none; background:#ffb6c1; color:#fff; border-radius:12px; cursor:pointer; font-weight:bold; }

/* TRANSCRIPTION KARAOK√â */
#transcriptionContainer {
  background: rgba(255,255,255,0.95);
  border-radius: 12px;
  padding: 15px;
  margin-top: 10px;
  max-height: 150px;
  overflow-y: auto;
  text-align: left;
  display: none;
  box-shadow: 0 2px 10px rgba(182,115,133,0.3);
}

#transcriptionContainer.visible {
  display: block;
}

#transcriptionText {
  font-size: 16px;
  line-height: 1.8;
  color: #333;
}

.transcript-line {
  display: inline;
  transition: all 0.3s ease;
}

.transcript-line.active {
  color: #ff1493;
  font-weight: bold;
  font-size: 18px;
  text-shadow: 0 0 10px rgba(255,20,147,0.5);
  background: rgba(255,20,147,0.1);
  padding: 2px 4px;
  border-radius: 4px;
}

.transcript-line.passed {
  color: #999;
}

#toggleTranscript {
  background: #ff69b4 !important;
  margin-top: 10px;
}

#toggleTranscript:hover {
  background: #ff1493 !important;
}

#toggleTranscript:disabled {
  background: #ccc !important;
  cursor: not-allowed;
}

.transcript-info {
  font-size: 12px;
  color: #b84c6f;
  margin-top: 5px;
  font-style: italic;
}

/* Player container */
#playerContainer {
  width: 100%;
  height: 280px;
  border-radius: 8px;
  overflow: hidden;
}
</style>
</head>
<body>

<div id="sidebar">
  <div id="toggleSidebar">‚ò∞</div>
  <button id="addVideoBtn">Ajouter vid√©o</button>
  <button id="returnBtn">Retour</button>
</div>

<h2 style="text-align:center;">Mes vid√©os</h2>
<div id="video-list"></div>

<!-- MODAL AJOUT -->
<div class="modal" id="videoModalAdd">
  <div class="modal-content">
    <h3>Ajouter une vid√©o</h3>
    <input type="text" id="youtubeLink" placeholder="Lien YouTube">
    <button id="confirmAddVideo">Ajouter</button>
    <button id="cancelAddVideo">Annuler</button>
  </div>
</div>

<!-- MODAL LECTEUR -->
<div class="modal" id="videoModalPlay">
  <div class="modal-content" id="modalPlayContent">
    <button id="closePlayModal">Fermer</button>
  </div>
</div>

<!-- Charger l'API YouTube -->
<script src="https://www.youtube.com/iframe_api"></script>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://jyhbamdcxmpveujjqjla.supabase.co",
  "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa"
);

const videoList = document.getElementById('video-list');
const addVideoBtn = document.getElementById('addVideoBtn');
const videoModalAdd = document.getElementById('videoModalAdd');
const youtubeLink = document.getElementById('youtubeLink');
const confirmAddVideo = document.getElementById('confirmAddVideo');
const cancelAddVideo = document.getElementById('cancelAddVideo');

const videoModalPlay = document.getElementById('videoModalPlay');
const modalPlayContent = document.getElementById('modalPlayContent');
const closePlayModal = document.getElementById('closePlayModal');

const sidebar = document.getElementById('sidebar');
const toggleSidebar = document.getElementById('toggleSidebar');
const returnBtn = document.getElementById('returnBtn');

let currentPlayer = null;
let transcriptionInterval = null;
let transcriptionData = [];

// SIDEBAR
toggleSidebar.onclick = () => sidebar.classList.toggle('sidebar-open');

// RETOUR avec fondu
returnBtn.onclick = () => {
  document.body.style.opacity='0';
  setTimeout(()=>window.location.href='owner.html',500);
};

// MODAL AJOUT
addVideoBtn.onclick = ()=> videoModalAdd.style.display='flex';
cancelAddVideo.onclick = ()=> {
  videoModalAdd.style.display='none';
  youtubeLink.value='';
};
videoModalAdd.onclick = e => { if(e.target===videoModalAdd) videoModalAdd.style.display='none'; };

// AJOUT VIDEO
confirmAddVideo.onclick = async ()=>{
  const yt = youtubeLink.value.trim();
  if(!yt){ alert("Colle un lien YouTube"); return; }

  const { data, error } = await supabase.from('videos')
    .insert([{ name:"Vid√©o YouTube", youtubelink: yt }])
    .select();

  if(error){ alert(error.message); console.error(error); return; }

  youtubeLink.value=''; 
  videoModalAdd.style.display='none'; 
  loadVideos();
};

// CHARGER VIDEOS
async function loadVideos(){
  const { data, error } = await supabase.from('videos').select('*').order('created_at',{ascending:false});
  if(error){ console.error(error); return; }

  videoList.innerHTML='';
  data.forEach(v=>{
    const div=document.createElement('div');
    div.className='video-item';

    const span=document.createElement('span');
    span.textContent=v.name;
    div.appendChild(span);

    const btnDiv=document.createElement('div');

    // Ouvrir
    const openBtn=document.createElement('button');
    openBtn.textContent='Ouvrir';
    openBtn.onclick=e=>{ e.stopPropagation(); openVideo(v); };
    btnDiv.appendChild(openBtn);

    // Renommer
    const renameBtn=document.createElement('button');
    renameBtn.textContent='Renommer';
    renameBtn.onclick=async e=>{
      e.stopPropagation();
      const newName=prompt("Nouveau nom :", v.name);
      if(newName && newName.trim()!==''){
        const { error } = await supabase.from('videos').update({ name:newName }).eq('id', v.id);
        if(error){ alert(error.message); console.error(error); return; }
        loadVideos();
      }
    };
    btnDiv.appendChild(renameBtn);

    div.appendChild(btnDiv);
    videoList.appendChild(div);
  });
}

// R√âCUP√âRER LA TRANSCRIPTION VIA API PUBLIQUE (youtube-transcript)
async function fetchYouTubeTranscript(videoId) {
  console.log('R√©cup√©ration de la transcription pour:', videoId);
  
  try {
    // Utiliser l'API publique youtube-transcript via un service CORS-anywhere
    // Cette API gratuite r√©cup√®re les transcriptions YouTube
    const response = await fetch(`https://youtube-transcript-api.vercel.app/api/transcript?videoId=${videoId}`);
    
    if (!response.ok) {
      throw new Error(`Erreur HTTP: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Donn√©es re√ßues:', data);
    
    if (data && Array.isArray(data) && data.length > 0) {
      // Formater les donn√©es
      const transcription = data.map(item => ({
        time: item.offset / 1000, // Convertir millisecondes en secondes
        text: item.text.replace(/\n/g, ' ').trim()
      }));
      
      console.log(`‚úì ${transcription.length} segments charg√©s`);
      return transcription;
    }
    
    throw new Error('Pas de transcription disponible');
  } catch (error) {
    console.error('Erreur API principale:', error);
    
    // SOLUTION DE SECOURS: Essayer une API alternative
    try {
      console.log('Tentative avec API alternative...');
      const altResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://www.youtube.com/watch?v=${videoId}`)}`);
      const altData = await altResponse.json();
      
      if (altData && altData.contents) {
        // Extraire les donn√©es de transcription du HTML
        const html = altData.contents;
        const captionMatch = html.match(/"captionTracks":\[(.*?)\]/);
        
        if (captionMatch) {
          const captionData = JSON.parse(`[${captionMatch[1]}]`);
          if (captionData.length > 0) {
            const captionUrl = captionData[0].baseUrl;
            
            // R√©cup√©rer la transcription
            const transcriptResponse = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(captionUrl)}`);
            const transcriptData = await transcriptResponse.json();
            
            if (transcriptData && transcriptData.contents) {
              return parseYouTubeXML(transcriptData.contents);
            }
          }
        }
      }
    } catch (altError) {
      console.error('Erreur API alternative:', altError);
    }
    
    // DERNI√àRE SOLUTION: API youtube-transcript npm alternative
    try {
      console.log('Tentative avec API npm alternative...');
      const npmResponse = await fetch(`https://yt-transcript-api.herokuapp.com/transcript?videoId=${videoId}`);
      
      if (npmResponse.ok) {
        const npmData = await npmResponse.json();
        if (npmData && Array.isArray(npmData) && npmData.length > 0) {
          const transcription = npmData.map(item => ({
            time: item.start || item.offset / 1000,
            text: item.text.replace(/\n/g, ' ').trim()
          }));
          console.log(`‚úì ${transcription.length} segments charg√©s (API npm)`);
          return transcription;
        }
      }
    } catch (npmError) {
      console.error('Erreur API npm:', npmError);
    }
    
    return null;
  }
}

// PARSER LE XML DE YOUTUBE (solution de secours)
function parseYouTubeXML(xmlText) {
  try {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
    
    const parserError = xmlDoc.querySelector('parsererror');
    if (parserError) {
      console.error('Erreur de parsing XML');
      return null;
    }
    
    const texts = xmlDoc.getElementsByTagName('text');
    console.log(`Nombre de segments XML: ${texts.length}`);
    
    if (texts.length === 0) return null;
    
    const transcription = [];
    for (let i = 0; i < texts.length; i++) {
      const text = texts[i];
      const start = parseFloat(text.getAttribute('start') || text.getAttribute('t') || 0);
      let content = text.textContent
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&quot;/g, '"')
        .replace(/&#39;/g, "'")
        .replace(/\n/g, ' ')
        .trim();
      
      if (content) {
        transcription.push({
          time: start,
          text: content
        });
      }
    }
    
    console.log(`Transcription XML pars√©e: ${transcription.length} segments`);
    return transcription.length > 0 ? transcription : null;
  } catch (error) {
    console.error('Erreur lors du parsing XML:', error);
    return null;
  }
}

// METTRE √Ä JOUR LA TRANSCRIPTION KARAOK√â
function updateTranscription(currentTime) {
  const lines = document.querySelectorAll('.transcript-line');
  
  transcriptionData.forEach((item, index) => {
    const line = lines[index];
    if (!line) return;
    
    const nextTime = transcriptionData[index + 1]?.time || Infinity;
    
    if (currentTime >= item.time && currentTime < nextTime) {
      line.className = 'transcript-line active';
      const container = document.getElementById('transcriptionContainer');
      if (container && container.classList.contains('visible')) {
        line.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    } else if (currentTime >= nextTime) {
      line.className = 'transcript-line passed';
    } else {
      line.className = 'transcript-line';
    }
  });
}

// LECTEUR
async function openVideo(v){
  modalPlayContent.innerHTML='';
  
  // Bouton fermer
  const closeBtn=document.createElement('button');
  closeBtn.textContent='Fermer';
  closeBtn.style.marginBottom='10px';
  closeBtn.onclick=()=> {
    if (transcriptionInterval) {
      clearInterval(transcriptionInterval);
      transcriptionInterval = null;
    }
    if (currentPlayer) {
      currentPlayer.destroy();
      currentPlayer = null;
    }
    transcriptionData = [];
    videoModalPlay.style.display='none';
  };
  modalPlayContent.appendChild(closeBtn);

  if(v.youtubelink){
    let ytId=null;
    const matchWatch=v.youtubelink.match(/watch\?v=([^&]+)/);
    if(matchWatch) ytId=matchWatch[1];
    const matchShort=v.youtubelink.match(/youtu\.be\/([^?&]+)/);
    if(matchShort) ytId=matchShort[1];
    
    if(ytId){
      // Cr√©er le container pour le player
      const playerContainer = document.createElement('div');
      playerContainer.id = 'playerContainer';
      modalPlayContent.appendChild(playerContainer);
      
      // Bouton pour charger la transcription
      const toggleBtn = document.createElement('button');
      toggleBtn.id = 'toggleTranscript';
      toggleBtn.textContent = 'üìù Charger la transcription';
      
      // Info
      const infoDiv = document.createElement('div');
      infoDiv.className = 'transcript-info';
      infoDiv.textContent = 'Cliquez pour charger les sous-titres automatiques';
      
      toggleBtn.onclick = async () => {
        toggleBtn.disabled = true;
        toggleBtn.textContent = '‚è≥ Chargement...';
        infoDiv.textContent = 'Recherche de la transcription...';
        
        // R√©cup√©rer la transcription
        const transcript = await fetchYouTubeTranscript(ytId);
        
        if (transcript && transcript.length > 0) {
          transcriptionData = transcript;
          infoDiv.textContent = `‚úì ${transcript.length} segments charg√©s avec succ√®s`;
          
          // Cr√©er le container de transcription
          let transcriptionContainer = document.getElementById('transcriptionContainer');
          if (!transcriptionContainer) {
            transcriptionContainer = document.createElement('div');
            transcriptionContainer.id = 'transcriptionContainer';
            
            const transcriptionText = document.createElement('div');
            transcriptionText.id = 'transcriptionText';
            
            transcriptionData.forEach((item, index) => {
              const span = document.createElement('span');
              span.className = 'transcript-line';
              span.textContent = item.text;
              transcriptionText.appendChild(span);
              
              if (index < transcriptionData.length - 1) {
                transcriptionText.appendChild(document.createTextNode(' '));
              }
            });
            
            transcriptionContainer.appendChild(transcriptionText);
            modalPlayContent.appendChild(transcriptionContainer);
          }
          
          transcriptionContainer.classList.add('visible');
          toggleBtn.textContent = 'üôà Masquer la transcription';
          toggleBtn.disabled = false;
          
          // Modifier le comportement du bouton
          toggleBtn.onclick = () => {
            transcriptionContainer.classList.toggle('visible');
            toggleBtn.textContent = transcriptionContainer.classList.contains('visible') 
              ? 'üôà Masquer la transcription' 
              : 'üìù Afficher la transcription';
          };
          
          // D√©marrer la synchronisation
          if (!transcriptionInterval) {
            transcriptionInterval = setInterval(() => {
              if (currentPlayer && currentPlayer.getCurrentTime) {
                const currentTime = currentPlayer.getCurrentTime();
                updateTranscription(currentTime);
              }
            }, 100);
          }
        } else {
          infoDiv.textContent = '‚ùå Cette vid√©o n\'a pas de sous-titres disponibles';
          toggleBtn.textContent = '‚ùå Transcription non disponible';
          toggleBtn.style.background = '#ff6b6b';
          setTimeout(() => {
            toggleBtn.textContent = 'üìù R√©essayer';
            toggleBtn.style.background = '#ff69b4';
            toggleBtn.disabled = false;
            infoDiv.textContent = 'Certaines vid√©os n\'ont pas de sous-titres';
          }, 3000);
        }
      };
      
      modalPlayContent.appendChild(toggleBtn);
      modalPlayContent.appendChild(infoDiv);
      
      // Initialiser le player YouTube
      if (typeof YT !== 'undefined' && YT.Player) {
        currentPlayer = new YT.Player('playerContainer', {
          height: '280',
          width: '100%',
          videoId: ytId,
          playerVars: {
            'playsinline': 1
          },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }
    } else {
      const p=document.createElement('p'); 
      p.textContent="Lien YouTube invalide";
      modalPlayContent.appendChild(p);
    }
  }
  videoModalPlay.style.display='flex';
}

// Callback quand le player est pr√™t
function onPlayerReady(event) {
  console.log('Player YouTube pr√™t');
}

// Callback quand l'√©tat du player change
function onPlayerStateChange(event) {
  if (event.data === 0 || event.data === 2) {
    if (transcriptionInterval) {
      clearInterval(transcriptionInterval);
      transcriptionInterval = null;
    }
  } else if (event.data === 1) {
    if (transcriptionData.length > 0 && !transcriptionInterval) {
      transcriptionInterval = setInterval(() => {
        if (currentPlayer && currentPlayer.getCurrentTime) {
          const currentTime = currentPlayer.getCurrentTime();
          updateTranscription(currentTime);
        }
      }, 100);
    }
  }
}

// FERMER MODAL
closePlayModal.onclick=()=> {
  if (transcriptionInterval) {
    clearInterval(transcriptionInterval);
    transcriptionInterval = null;
  }
  if (currentPlayer) {
    currentPlayer.destroy();
    currentPlayer = null;
  }
  transcriptionData = [];
  videoModalPlay.style.display='none';
};

videoModalPlay.onclick=e=>{ 
  if(e.target===videoModalPlay) {
    if (transcriptionInterval) {
      clearInterval(transcriptionInterval);
      transcriptionInterval = null;
    }
    if (currentPlayer) {
      currentPlayer.destroy();
      currentPlayer = null;
    }
    transcriptionData = [];
    videoModalPlay.style.display='none';
  }
};

// S'assurer que l'API YouTube est charg√©e
window.onYouTubeIframeAPIReady = function() {
  console.log('YouTube API pr√™te');
};

loadVideos();
</script>
</body>
</html>
