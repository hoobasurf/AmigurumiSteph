<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mes vidéos</title>
<style>
html, body { margin:0; padding:0; height:100%; font-family:'Comic Sans MS', cursive; transition: opacity 0.5s; }

/* FOND IMAGE */
body::before {
  content:"";
  position:fixed;
  inset:0;
  background-image:url('Photoroom_20260106_224222.png');
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  z-index:-1;
}

/* SIDEBAR */
#sidebar{
  position:fixed; top:0; left:-220px; width:220px; height:100vh;
  background:rgba(255,230,240,0.2); border-right:2px solid #b67385; padding:20px;
  transition:left .3s; z-index:100;
}
#sidebar.sidebar-open{ left:0; }
#toggleSidebar{
  position:absolute; top:50%; right:-30px; width:30px; height:60px;
  background:#ffb6c1; border-radius:0 12px 12px 0; display:flex;
  align-items:center; justify-content:center; cursor:pointer; font-weight:bold; color:white;
}
#sidebar button{
  width:auto; padding:8px 16px; border-radius:16px; border:none;
  background:#ffb6c1; color:#fff; cursor:pointer; font-weight:bold; margin-top:10px;
}

/* LISTE VIDEOS */
#video-list { display:flex; flex-direction:column; gap:10px; max-width:360px; /* réduit 2cm */ margin:auto; margin-top:60px; }
.video-item {
  background: rgba(255,182,193,0.4);
  padding:10px 16px; border-radius:12px;
  display:flex; justify-content:space-between; align-items:center;
  cursor:pointer; border:2px solid #b67385; color:#b84c6f; font-weight:bold;
}
.video-item span { flex:1; }
.video-item div { display:flex; gap:5px; }

/* MODAL */
.modal { position:fixed; inset:0; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.5); z-index:1000; }
.modal-content{ background:#fff0f6; padding:20px; border-radius:12px; max-width:90%; width:400px; text-align:center; display:flex; flex-direction:column; gap:10px; }
.modal-content input{ padding:6px 12px; border-radius:10px; border:2px solid #b67385; width:100%; }
.modal-content button{ padding:6px 12px; border:none; background:#ffb6c1; color:#fff; border-radius:12px; cursor:pointer; font-weight:bold; }
.modal-content iframe, .modal-content video{ width:100%; height:220px; border-radius:8px; }
</style>
</head>
<body>

<div id="sidebar">
  <div id="toggleSidebar">☰</div>
  <button id="addVideoBtn">Ajouter vidéo</button>
  <button id="returnBtn">Retour</button>
</div>

<h2 style="text-align:center;">Mes vidéos</h2>
<div id="video-list"></div>

<!-- MODAL AJOUT -->
<div class="modal" id="videoModalAdd">
  <div class="modal-content">
    <h3>Ajouter une vidéo</h3>
    <input type="text" id="youtubeLink" placeholder="Lien YouTube">
    <button id="confirmAddVideo">Ajouter</button>
    <button id="cancelAddVideo">Annuler</button>
  </div>
</div>

<!-- MODAL LECTEUR -->
<div class="modal" id="videoModalPlay">
  <div class="modal-content" id="modalPlayContent">
    <button id="closePlayModal">Fermer</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://jyhbamdcxmpveujjqjla.supabase.co",
  "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa"
);

const videoList = document.getElementById('video-list');
const addVideoBtn = document.getElementById('addVideoBtn');
const videoModalAdd = document.getElementById('videoModalAdd');
const youtubeLink = document.getElementById('youtubeLink');
const confirmAddVideo = document.getElementById('confirmAddVideo');
const cancelAddVideo = document.getElementById('cancelAddVideo');

const videoModalPlay = document.getElementById('videoModalPlay');
const modalPlayContent = document.getElementById('modalPlayContent');
const closePlayModal = document.getElementById('closePlayModal');

const sidebar = document.getElementById('sidebar');
const toggleSidebar = document.getElementById('toggleSidebar');
const returnBtn = document.getElementById('returnBtn');

// SIDEBAR
toggleSidebar.onclick = () => sidebar.classList.toggle('sidebar-open');

// RETOUR avec fondu
returnBtn.onclick = () => {
  document.body.style.opacity = '0';
  setTimeout(()=>window.location.href='owner.html',500);
};

// MODAL AJOUT
addVideoBtn.onclick = ()=> videoModalAdd.style.display='flex';
cancelAddVideo.onclick = ()=> videoModalAdd.style.display='none';
videoModalAdd.onclick = e => { if(e.target===videoModalAdd) videoModalAdd.style.display='none'; };

// AJOUT VIDEO
confirmAddVideo.onclick = async ()=>{
  const yt = youtubeLink.value.trim();
  if(!yt){ alert("Colle un lien YouTube"); return; }

  const { data, error } = await supabase.from('videos')
    .insert([{ name:"Vidéo YouTube", youtubelink: yt }])
    .select();

  if(error){ alert(error.message); console.error(error); return; }

  youtubeLink.value=''; videoModalAdd.style.display='none'; loadVideos();
};

// CHARGER VIDEOS
async function loadVideos(){
  const { data, error } = await supabase.from('videos').select('*').order('created_at',{ascending:false});
  if(error){ console.error(error); return; }

  videoList.innerHTML='';
  data.forEach(v=>{
    // Encadré vidéo
    const div = document.createElement('div');
    div.className='video-item';

    const span = document.createElement('span');
    span.textContent = v.name;
    div.appendChild(span);

    const btnDiv = document.createElement('div');

    // Ouvrir
    const openBtn = document.createElement('button');
    openBtn.textContent='Ouvrir';
    openBtn.onclick = e => { e.stopPropagation(); openVideo(v); };
    btnDiv.appendChild(openBtn);

    // Renommer
    const renameBtn = document.createElement('button');
    renameBtn.textContent='Renommer';
    renameBtn.onclick = async e=>{
      e.stopPropagation();
      const newName = prompt("Nouveau nom :", v.name);
      if(newName && newName.trim()!==''){
        const { error } = await supabase.from('videos').update({ name:newName }).eq('id', v.id);
        if(error){ alert(error.message); console.error(error); return; }
        loadVideos();
      }
    };
    btnDiv.appendChild(renameBtn);

    div.appendChild(btnDiv);
    videoList.appendChild(div);
  });
}

// LECTEUR
function openVideo(v){
  modalPlayContent.innerHTML='';
  const closeBtn=document.createElement('button');
  closeBtn.textContent='Fermer';
  closeBtn.style.marginBottom='10px';
  closeBtn.onclick=()=> videoModalPlay.style.display='none';
  modalPlayContent.appendChild(closeBtn);

  if(v.youtubelink){
    let ytId=null;
    const matchWatch=v.youtubelink.match(/watch\?v=([^&]+)/);
    if(matchWatch) ytId=matchWatch[1];
    const matchShort=v.youtubelink.match(/youtu\.be\/([^?&]+)/);
    if(matchShort) ytId=matchShort[1];
    if(ytId){
      const iframe=document.createElement('iframe');
      iframe.src=`https://www.youtube.com/embed/${ytId}`;
      iframe.frameBorder="0";
      iframe.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
      iframe.allowFullscreen=true;
      iframe.style.width='100%'; iframe.style.height='220px'; iframe.style.borderRadius='8px';
      modalPlayContent.appendChild(iframe);
    } else {
      const p=document.createElement('p'); p.textContent="Lien YouTube invalide";
      modalPlayContent.appendChild(p);
    }
  }
  videoModalPlay.style.display='flex';
}

// FERMER MODAL
closePlayModal.onclick=()=> videoModalPlay.style.display='none';
videoModalPlay.onclick=e=>{ if(e.target===videoModalPlay) videoModalPlay.style.display='none'; };

loadVideos();
</script>
</body>
</html>
