<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VidÃ©os</title>

<style>
body{
  margin:0;
  font-family:'Comic Sans MS',cursive;
  background:#fff0f5;
}

/* SIDEBAR */
#sidebar{
  position:fixed;
  top:0;
  left:-220px;
  width:220px;
  height:100vh;
  background:rgba(255,230,240,0.2);
  border-right:2px solid #b67385;
  padding:20px;
  transition:left .3s;
  z-index:10;
}
#sidebar.sidebar-open{left:0}
#toggleSidebar{
  position:absolute;
  top:50%;
  right:-30px;
  width:30px;
  height:60px;
  background:#ffb6c1;
  border-radius:0 12px 12px 0;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-weight:bold;
}
  
#sidebar button{
  width:100%;
  margin:8px 0;
  padding:8px;
  border:none;
  border-radius:12px;
  background:#ffb6c1;
  color:white;
  cursor:pointer;
}

/* HEADER */
header{padding:16px}
header button{
  padding:8px 16px;
  border:none;
  border-radius:16px;
  background:#ffb6c1;
  color:white;
  cursor:pointer;
}

/* VIDEO */
#playerBox{
  display:none;
  justify-content:center;
}
iframe{
  width:90%; height:45vh;
  border-radius:16px;
  border:3px solid #b67385;
}

/* LISTE */
#list{margin:16px}
.item{
  background:white;
  padding:8px;
  border-radius:12px;
  margin-bottom:6px;
  display:flex;
  justify-content:space-between;
}
.item span{cursor:pointer}
.item button{
  border:none;
  background:#ffb6c1;
  color:white;
  border-radius:8px;
}

/* TRANSCRIPTION */
#transcript{
  margin:16px;
  background:white;
  border-radius:16px;
  padding:12px;
}
.line{margin:6px 0}
.active{background:#ffb6c1;border-radius:8px;padding:2px 6px}

/* MODAL */
#modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
}
#modalBox{
  background:#ffe6f0;
  padding:16px;
  border-radius:16px;
  width:90%;
}
#modalBox input{
  width:100%;
  padding:8px;
  border-radius:12px;
  border:2px solid #b67385;
}
</style>
</head>

<body>

<div id="sidebar">
  <div id="toggle">â˜°</div>
  <button onclick="location.href='owner.html'">Retour</button>
</div>

<header>
  <button onclick="openModal()">Ajouter une vidÃ©o</button>
</header>

<div id="playerBox">
  <iframe id="player" allowfullscreen></iframe>
</div>

<div id="list"></div>

<div id="transcript"></div>

<!-- MODAL -->
<div id="modal">
  <div id="modalBox">
    <input id="urlInput" placeholder="Colle un lien YouTube">
    <button onclick="saveVideo()">Enregistrer</button>
  </div>
</div>

<script>
const sidebar=document.getElementById('sidebar');
document.getElementById('toggle').onclick=()=>sidebar.classList.toggle('open');

const modal=document.getElementById('modal');
const list=document.getElementById('list');
const player=document.getElementById('player');
const transcriptBox=document.getElementById('transcript');

let videos=JSON.parse(localStorage.getItem('videos')||'[]');
let transcript=[];

function openModal(){modal.style.display='flex'}
modal.onclick=e=>{if(e.target===modal)modal.style.display='none'}

function saveVideo(){
  const url=document.getElementById('urlInput').value;
  const id=(url.match(/v=([^&]+)/)||url.match(/youtu\.be\/([^?]+)/))?.[1];
  if(!id)return alert("Lien invalide");
  videos.push({id});
  localStorage.setItem('videos',JSON.stringify(videos));
  modal.style.display='none';
  renderList();
}

function renderList(){
  list.innerHTML='';
  videos.forEach((v,i)=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`<span onclick="loadVideo('${v.id}')">ðŸŽ¬ ${v.id}</span>
                   <button onclick="remove(${i})">âœ–</button>`;
    list.appendChild(div);
  });
}
function remove(i){
  videos.splice(i,1);
  localStorage.setItem('videos',JSON.stringify(videos));
  renderList();
}

async function loadVideo(id){
  player.src=`https://www.youtube.com/embed/${id}?enablejsapi=1`;
  document.getElementById('playerBox').style.display='flex';

  const res=await fetch(`/transcript/${id}`);
  transcript=await res.json();
  renderTranscript();
  sync();
}

function renderTranscript(){
  transcriptBox.innerHTML='';
  transcript.forEach(t=>{
    const d=document.createElement('div');
    d.className='line';
    d.dataset.time=t.start;
    d.textContent=t.text;
    transcriptBox.appendChild(d);
  });
}

function sync(){
  setInterval(()=>{
    const time=player.contentWindow?.postMessage;
    const lines=document.querySelectorAll('.line');
    let current=null;
    lines.forEach(l=>{
      if(player.getCurrentTime && player.getCurrentTime()>=l.dataset.time){
        current=l;
      }
      l.classList.remove('active');
    });
    if(current)current.classList.add('active');
  },500);
}

renderList();
</script>

</body>
</html>
