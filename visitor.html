<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Visitor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;font-family:sans-serif;}

/* ================= ACCUEIL ================= */
#intro-container{
  position:fixed;
  inset:0;
  background:url('Photoroom_20251213_123235.png') center/cover no-repeat;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
  flex-direction:column;
}

/* vid√©o plein √©cran SANS ZOOM */
#intro-video{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover; /* VIDEO couvre tout l'√©cran */
  z-index:1;
}

/* bouton bienvenue */
#welcome-btn{
  position:relative;
  z-index:2;
  padding:12px 24px; /* r√©duit le bouton */
  font-size:18px;    /* plus petit texte */
  border-radius:12px;
  border:none;
  background:#ffb6c1;
  color:#8b3a3a;
  font-weight:bold;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.25);
}
#welcome-btn:hover{
  background:#ff9fc1;
}

/* ================= APPLI ================= */
#app{
  display:none;
  width:100%;
  height:100%;
  overflow:auto;
  background:#fff0f5;
  padding:20px;
}

/* Header */
h1{
  text-align:center;
  margin:20px 0;
  color:#b84c6f;
}

/* Boutons vues */
#viewSelector{
  display:flex;
  justify-content:center;
  gap:12px;
  margin-bottom:14px;
}
#viewSelector button{
  background:#fff0f7;
  border:2px solid #b84c6f;
  color:#b84c6f;
  padding:8px 16px;
  border-radius:24px;
  cursor:pointer;
  font-size:15px;
  transition: all 0.18s ease;
}
#viewSelector button.active{background:linear-gradient(90deg,#ffeaf2,#fff5f8);color:#7a2b45;transform:translateY(-2px);}
#viewSelector button:hover{transform:translateY(-2px);}

/* Liste des cr√©ations */
#visitor-list{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:16px;
}
.visitor-item{
  text-align:center;
  cursor:pointer;
}
.visitor-item img{
  width:220px;
  height:220px;
  object-fit:cover;
  border-radius:12px;
  border:3px solid #b67385;
  transition: transform 0.2s, box-shadow 0.2s;
}
.visitor-item img:hover{
  transform:scale(1.03);
  box-shadow:0 6px 15px rgba(184,76,111,0.3);
}
.visitor-item p{
  margin-top:6px;
  font-weight:bold;
  color:#b84c6f;
}

/* Modal */
#modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
  z-index:2000;
}
.modal-box{
  background:#fff5f8;
  padding:18px;
  border-radius:16px;
  max-width:800px;
  width:90%;
  max-height:90vh;
  overflow:auto;
  text-align:center;
  position:relative;
}
.close-modal{
  position:absolute;
  top:10px;
  right:12px;
  font-size:28px;
  cursor:pointer;
  color:#b84c6f;
  font-weight:bold;
}
.modal-box img{
  width:100%;
  max-height:500px;
  object-fit:contain;
  border:4px solid #b67385;
}

/* Likes / commentaires */
.icon-bar{
  display:flex;
  justify-content:center;
  gap:24px;
  margin-top:12px;
}
.icon-btn{display:flex;gap:6px;align-items:center;cursor:pointer;color:#b84c6f;font-size:18px;}
.heart{font-size:26px;transition:color .18s;}
.heart.liked{color:#ff4b82;}
.like-info,.comment-info{font-size:14px;color:#7a2b45;}
.comment-section{margin-top:12px;text-align:left;}
.comment{background:#fff0f7;border:1px solid rgba(184,76,111,0.12);padding:10px;border-radius:10px;margin-bottom:8px;}
.add-comment-btn{margin-top:10px;padding:8px 18px;background:#b84c6f;color:white;border:none;border-radius:26px;font-size:14px;cursor:pointer;}
.comment-form-bg{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:3000;}
.comment-form{background:white;padding:16px;border-radius:12px;width:320px;box-shadow:0 8px 20px rgba(0,0,0,0.25);text-align:center;}
.comment-form input,.comment-form textarea{width:100%;padding:8px;border-radius:8px;border:2px solid rgba(184,76,111,0.12);margin-bottom:8px;font-size:14px;}
</style>
</head>

<body>

<!-- INTRO -->
<div id="intro-container">
  <video id="intro-video" playsinline preload="auto">
    <source src="chat.mp4" type="video/mp4">
  </video>
  <button id="welcome-btn">Bienvenue</button>
</div>

<!-- APPLI -->
<div id="app">
  <h1>‚ú® Projets r√©alis√©s</h1>

  <div id="viewSelector">
    <button id="btnCarousel">Carrousel</button>
    <button id="btnGrid">Grille</button>
    <button id="btnList">Liste</button>
  </div>

  <div id="visitor-list"></div>
</div>

<!-- Modal -->
<div id="modal">
  <div class="modal-box">
    <div class="close-modal" onclick="closeModal()">√ó</div>
    <img id="modalMain" src="">
    <div class="icon-bar">
      <div class="icon-btn" onclick="toggleLike()">
        <span id="heart" class="heart">‚ô°</span>
        <span id="likeCount" class="like-info">0</span>
      </div>
      <div class="icon-btn" onclick="scrollToComments()">
        üí¨ <span id="commentCount" class="comment-info">0</span>
      </div>
    </div>
    <button class="add-comment-btn" onclick="openCommentForm()">Ajouter un commentaire</button>
    <div id="commentsList" class="comment-section"></div>
  </div>
</div>

<!-- Comment form -->
<div class="comment-form-bg" id="commentFormBg" onclick="if(event.target===this) closeCommentForm()">
  <div class="comment-form">
    <h3 style="color:#b84c6f;">Laisser un commentaire</h3>
    <input id="commentName" placeholder="Pr√©nom">
    <textarea id="commentText" rows="4" placeholder="Votre commentaire..."></textarea>
    <button onclick="submitComment()">Envoyer</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
const SUPABASE_URL = "https://iubbxvipgofxasatmvzg.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_GDoZmwIdoP28XOdrfYYVNw_E_HiCQB1";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const list = document.getElementById('visitor-list');
const btnCarousel = document.getElementById('btnCarousel');
const btnGrid = document.getElementById('btnGrid');
const btnList = document.getElementById('btnList');
const modal = document.getElementById('modal');
const modalMain = document.getElementById('modalMain');
const heart = document.getElementById('heart');
const likeCount = document.getElementById('likeCount');
const commentCountSpan = document.getElementById('commentCount');
const commentsList = document.getElementById('commentsList');
const commentFormBg = document.getElementById('commentFormBg');
const commentName = document.getElementById('commentName');
const commentText = document.getElementById('commentText');

let creations = [];
let currentIndex = null;
let currentView = 'carousel';

async function loadCreations() {
  const { data, error } = await supabase.storage.from('owners').list();
  if(error){ console.error(error); return; }

  creations = data.map(item => ({
    name: item.name,
    imgUrl: supabase.storage.from('owners').getPublicUrl(item.name).publicURL
  }));

  renderVisitor();
}

function renderVisitor() {
  list.innerHTML = '';
  list.className = currentView + '-view';
  creations.forEach((item,i)=>{
    const div = document.createElement('div');
    div.className = 'visitor-item';
    div.setAttribute('data-index', i);
    div.innerHTML = `<img src="${item.imgUrl}" alt="${item.name}"><p>${item.name}</p>`;
    div.addEventListener('click', ()=>openModal(i));
    list.appendChild(div);
  });
}

function setView(mode){
  currentView = mode;
  btnCarousel.classList.toggle('active', mode==='carousel');
  btnGrid.classList.toggle('active', mode==='grid');
  btnList.classList.toggle('active', mode==='list');
  renderVisitor();
}

btnCarousel.addEventListener('click',()=>setView('carousel'));
btnGrid.addEventListener('click',()=>setView('grid'));
btnList.addEventListener('click',()=>setView('list'));

/* Modal functions */
function openModal(i){
  currentIndex = i;
  const proj = creations[i];
  modalMain.src = proj.imgUrl;
  loadLikes();
  loadComments();
  modal.style.display='flex';
}

function closeModal(){ modal.style.display='none'; }

function toggleLike(){
  if(currentIndex===null) return;
  const name = prompt("Ton pr√©nom pour liker cette image:") || "Anonyme";
  const key = `likes_${currentIndex}`;
  let likes = JSON.parse(localStorage.getItem(key)||'[]');
  if(likes.includes(name)) likes = likes.filter(n=>n!==name);
  else likes.push(name);
  localStorage.setItem(key, JSON.stringify(likes));
  loadLikes();
}

function loadLikes(){
  if(currentIndex===null) return;
  const key = `likes_${currentIndex}`;
  const likes = JSON.parse(localStorage.getItem(key)||'[]');
  heart.textContent = likes.length>0?'‚ù§Ô∏è':'‚ô°';
  heart.classList.toggle('liked', likes.length>0);
  likeCount.textContent = likes.length>0 ? ` ${likes.join(', ')}` : '';
}

function openCommentForm(){ commentFormBg.style.display='flex'; }
function closeCommentForm(){ commentFormBg.style.display='none'; }
function submitComment(){
  const name = commentName.value.trim();
  const text = commentText.value.trim();
  if(!name || !text) return;
  const key = `comments_${currentIndex}`;
  let comments = JSON.parse(localStorage.getItem(key)||'[]');
  comments.push({name,text,at:Date.now()});
  localStorage.setItem(key, JSON.stringify(comments));
  commentName.value=''; commentText.value=''; closeCommentForm();
  loadComments();
}

function loadComments(){
  if(currentIndex===null) return;
  const key = `comments_${currentIndex}`;
  const comments = JSON.parse(localStorage.getItem(key)||'[]');
  commentsList.innerHTML = comments.map(c=>`<div class="comment"><strong>${c.name}</strong><br>${c.text}</div>`).join('');
  commentCountSpan.textContent = comments.length;
}

function scrollToComments(){ commentsList.scrollIntoView({behavior:'smooth', block:'start'}); }

/* ---------------------------- */
/* NE PAS TOUCHER AU BOUTON BIENVENUE / VIDEO */
const intro = document.getElementById('intro-container');
const video = document.getElementById('intro-video');
const btn = document.getElementById('welcome-btn');
const app = document.getElementById('app');

btn.addEventListener('click', () => {
  btn.style.transition = 'opacity 0.5s';
  btn.style.opacity = 0;
  video.play();
  video.onended = () => {
    intro.style.transition = 'opacity 1s';
    intro.style.opacity = 0;
    setTimeout(() => {
      intro.remove();
      app.style.display = 'block';
      document.body.style.overflow = 'auto';
      // On charge les cr√©ations seulement apr√®s que l'app est visible
      loadCreations();
    }, 1000);
  };
});
</script>

</body>
</html>
