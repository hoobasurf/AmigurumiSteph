<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visitor</title>
<style>
* { <style>
html,body{height:100%;overflow-x:hidden;}
body::before{
  content:"";position:fixed;top:0;left:0;width:100vw;height:100vh;
  background-image:url('Photoroom_20251223_114401.jpeg');
  background-size:cover;background-position:center center;background-repeat:no-repeat;z-index:-1;
}
.center-zone{display:flex;justify-content:center;align-items:flex-start;padding-top:3.5cm;overflow:hidden;height:auto;}
#visitor-list-container{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling: touch;justify-content:center;padding-left:1cm;}
.page{display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(3,1fr);column-gap:3mm;row-gap:4mm;flex:0 0 auto;width:calc(2*200px+3mm);height:calc(3*200px+8mm);scroll-snap-align:center;padding:4mm;justify-content:center;margin-top:0;}
.visitor-item{position:relative;width:200px;height:200px;border-radius:12px;overflow:hidden;border:3px solid #fff;box-shadow:0 0 0 3px #f6c2d1,0 6px 14px rgba(0,0,0,0.25),inset 0 0 0 1px rgba(255,255,255,0.4);background:#ffe6f0;}
.visitor-item .placeholder{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;font-size:24px;color:#b84c6f;font-weight:bold;}
.visitor-item img{width:100%;height:100%;object-fit:cover;border-radius:12px;cursor:pointer;display:block;filter:brightness(1.05) contrast(1.05) saturate(0.95);transition:filter 0.3s, transform 0.3s;position:relative;z-index:2;}
.visitor-item img:hover{transform:scale(1.03);}
.visitor-item::after{content:"";position:absolute;inset:0;background:rgba(255,230,240,0.12);pointer-events:none;z-index:1;}
.visitor-item p{position:absolute;bottom:2px;width:100%;font-size:14px;color:#b84c6f;font-weight:bold;text-align:center;text-shadow:1px 1px 2px rgba(255,255,255,0.8);z-index:3;}
.delete-btn{position:absolute;top:2px;right:2px;width:20px;height:20px;background:#ffb6c1;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;cursor:pointer;z-index:5;font-size:14px;transition: background 0.2s;}
.delete-btn:hover{background:#e94f9a;}

#sidebar{position:fixed;top:0;left:-220px;width:220px;height:100vh;background:rgba(255,230,240,0.2);border-right:2px solid #b67385;padding:20px;transition:left .3s;z-index:10;}
#sidebar.sidebar-open{left:0;}
#toggleSidebar{position:absolute;top:50%;right:-30px;width:30px;height:60px;background:#ffb6c1;border-radius:0 12px 12px 0;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;}
#sidebar button{width:auto;padding:8px 16px;border-radius:16px;border:none;background:#ffb6c1;color:#fff;cursor:pointer;font-weight:bold;display:block;margin-top:10px;}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:10001;}
.modal .modal-box{background:#ffe6f0;padding:16px 24px;border-radius:20px;border:3px solid #b67385;display:flex;flex-direction:column;gap:10px;align-items:center;min-width:200px;font-family:'Comic Sans MS',cursive;}
.modal input{padding:6px 12px;border-radius:10px;border:2px solid #b67385;width:100%;}
.modal button{padding:6px 14px;border:none;background:#ffb6c1;color:#fff;border-radius:12px;cursor:pointer;font-weight:bold;width:100%;}

#zoomModal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:10000;}
#zoomModal img{max-width:80%;max-height:60vh;border:4px solid #b67385;border-radius:24px;margin-bottom:10px;filter:none;}
#zoomModal .thumbs{display:flex;gap:8px;max-width:80%;overflow-x:auto;}
#zoomModal .thumbs img{width:50px;height:50px;object-fit:cover;border-radius:12px;border:2px solid #b67385;cursor:pointer;}
.closeZoom{position:absolute;top:12px;right:12px;width:28px;height:28px;background:#ffb6c1;color:#fff;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;}

#ownerPhoto{width:32px;height:32px;border-radius:50%;position:fixed;top:10px;right:10px;z-index:10000;background:#ffe6f0;border:2px solid #b84c6f;}
@media(max-width:480px){.page{grid-template-columns:repeat(2,120px);grid-template-rows:repeat(3,120px);}.visitor-item{width:120px;height:120px;}.modal .modal-box{min-width:180px;}}

.icon-btn svg {
  cursor: pointer;
  transition: transform 0.2s;
}
.icon-btn:hover svg {
  transform: scale(1.2);
}
.icon-btn span {
  font-weight: bold;
  color: #b84c6f;
  font-size: 14px;
}

  /* Bouton toujours visible */
.chat-icon-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 4px;
  display: flex;
  align-items: center;
}

/* OWNER PHOTO & MESSAGERIE */
#ownerPhoto {
  width:32px; height:32px; border-radius:50%; position:fixed; top:10px; right:50px;
  border:2px solid #b84c6f; background:#ffe6f0; display:none; z-index:1000;
}

#messagerieBtn {
  position:fixed; top:10px; right:10px;
  width:36px; height:36px; border-radius:50%; border:none; background:#ffb6c1;
  display:none; justify-content:center; align-items:center; cursor:pointer; z-index:1000;
}
#messagerieBtn svg { stroke:#fff; stroke-width:2; }

/* MESSAGERIE MODAL */
.chat-overlay {
  position: fixed; inset:0; background: rgba(0,0,0,0.4);
  display:none; justify-content:center; align-items:center; z-index:2000;
}
.chat-window {
  width:360px; height:230px;
  background:#ffe6f0; border-radius:20px; border:2px solid #b67385;
  display:flex; flex-direction:column; overflow:hidden; box-shadow:0 12px 24px rgba(0,0,0,0.25);
  transition: width 0.3s, height 0.3s;
}
.chat-header { height:40px; background:linear-gradient(#ffd6e6,#ffb6c1);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; font-weight:bold; color:#b84c6f; flex-shrink:0; font-size:14px;
}
.chat-body { flex:1; display:flex; min-height:0; }
.chat-sidebar { width:120px; background:#fff5fa; border-right:2px solid #f3b3c8; overflow-y:auto; }
.chat-user { display:flex; align-items:center; gap:6px; padding:4px; cursor:pointer; font-size:12px; }
.chat-user.active { background:#ffd6e6; }
.chat-user img { border-radius:50%; width:28px; height:28px; object-fit:cover; }
.chat-content { flex:1; display:flex; flex-direction:column; min-height:0; }
.chat-messages { flex:1; padding:6px; overflow-y:auto; background:#fffafa; font-size:12px; }
.msg { max-width:70%; padding:4px 8px; margin-bottom:4px; border-radius:12px; }
.msg-me { background:#ffb6c1; align-self:flex-end; }
.msg-them { background:#ffffff; border:1px solid #f3b3c8; }
.chat-input { display:flex; padding:4px; gap:4px; }
.chat-input input { flex:1; border-radius:10px; border:2px solid #b67385; padding:4px 6px; font-size:12px; }
.chat-icon-btn { background:transparent; border:none; cursor:pointer; padding:2px; display:flex; align-items:center; }
.expanded .chat-window { width:720px; height:460px; border-radius:24px; }
</style>
</head>
<body>

<!-- Mini cercle profil -->
<img id="ownerPhoto" alt="Owner">

<!-- Bouton Messagerie -->
<button id="messagerieBtn" aria-label="Messagerie">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
</svg>
</button>

<!-- Messagerie modal -->
<div id="chatModal" class="chat-overlay">
  <div class="chat-window">
    <div class="chat-header">
      <span class="chat-title">Messagerie</span>
      <button id="toggleChatSize" class="chat-icon-btn">
        <svg id="chatResizeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#b84c6f" stroke-width="2" stroke-linecap="round">
          <path d="M4 9V4h5M20 15v5h-5M15 4h5v5M9 20H4v-5"/>
        </svg>
      </button>
    </div>
    <div class="chat-body">
      <div class="chat-sidebar" id="chatUserList"></div>
      <div class="chat-content">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Écrire un message…">
          <button id="sendMsgBtn">➤</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient("https://jyhbamdcxmpveujjqjla.supabase.co", "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa");

const ownerPhoto = document.getElementById('ownerPhoto');
const messagerieBtn = document.getElementById('messagerieBtn');
const chatModal = document.getElementById('chatModal');
const toggleChatSize = document.getElementById('toggleChatSize');
const icon = document.getElementById('chatResizeIcon');

// Afficher bouton Messagerie et mini cercle uniquement si connecté
const prenom = localStorage.getItem('prenom');
if(prenom){
  ownerPhoto.style.display='block';
  messagerieBtn.style.display='flex';
}

// Ouvrir modal
messagerieBtn.onclick = () => chatModal.style.display='flex';
chatModal.addEventListener('click', e => { if(e.target===chatModal) chatModal.style.display='none'; });

// Toggle petite/grande taille
toggleChatSize.onclick = () => {
  chatModal.classList.toggle('expanded');
  icon.innerHTML = chatModal.classList.contains('expanded')
    ? '<path d="M9 4H4v5M15 20h5v-5M20 9V4h-5M4 15v5h5"/>'
    : '<path d="M4 9V4h5M20 15v5h-5M15 4h5v5M9 20H4v-5"/>';
};

// Pinch pour mobile
let initialDistance=null;
chatModal.addEventListener('touchstart', e=>{ if(e.touches.length===2) initialDistance=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY); });
chatModal.addEventListener('touchmove', e=>{
  if(e.touches.length===2 && initialDistance){
    const currentDistance=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    if(currentDistance-initialDistance>30) chatModal.classList.add('expanded');
    if(initialDistance-currentDistance>30) chatModal.classList.remove('expanded');
  }
});
chatModal.addEventListener('touchend',()=>{ initialDistance=null; });

</script>

</body>
</html>
