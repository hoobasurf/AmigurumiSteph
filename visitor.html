<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Owner</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="icon-152.png">
<meta name="theme-color" content="#f2b7c9">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
* { box-sizing:border-box;margin:0;padding:0;font-family:'Comic Sans MS',cursive; }
html,body{height:100%;overflow-x:hidden;}
body::before{
  content:"";position:fixed;top:0;left:0;width:100vw;height:100vh;
  background-image:url('Photoroom_20251223_114401.jpeg');
  background-size:cover;background-position:center center;background-repeat:no-repeat;z-index:-1;
}
.center-zone{display:flex;justify-content:center;align-items:flex-start;padding-top:3.5cm;overflow:hidden;height:auto;}
#visitor-list-container{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling: touch;justify-content:center;padding-left:1cm;}
.page{display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(3,1fr);column-gap:3mm;row-gap:4mm;flex:0 0 auto;width:calc(2*200px+3mm);height:calc(3*200px+8mm);scroll-snap-align:center;padding:4mm;justify-content:center;margin-top:0;}
.visitor-item{position:relative;width:200px;height:200px;border-radius:12px;overflow:hidden;border:3px solid #fff;box-shadow:0 0 0 3px #f6c2d1,0 6px 14px rgba(0,0,0,0.25),inset 0 0 0 1px rgba(255,255,255,0.4);background:#ffe6f0;}
.visitor-item .placeholder{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;font-size:24px;color:#b84c6f;font-weight:bold;}
.visitor-item img{width:100%;height:100%;object-fit:cover;border-radius:12px;cursor:pointer;display:block;filter:brightness(1.05) contrast(1.05) saturate(0.95);transition:filter 0.3s, transform 0.3s;position:relative;z-index:2;}
.visitor-item img:hover{transform:scale(1.03);}
.visitor-item::after{content:"";position:absolute;inset:0;background:rgba(255,230,240,0.12);pointer-events:none;z-index:1;}
.visitor-item p{position:absolute;bottom:2px;width:100%;font-size:14px;color:#b84c6f;font-weight:bold;text-align:center;text-shadow:1px 1px 2px rgba(255,255,255,0.8);z-index:3;}

.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:10001;}
.modal .modal-box{background:#ffe6f0;padding:16px 24px;border-radius:20px;border:3px solid #b67385;display:flex;flex-direction:column;gap:10px;align-items:center;min-width:200px;font-family:'Comic Sans MS',cursive;}
.modal input{padding:6px 12px;border-radius:10px;border:2px solid #b67385;width:100%;}
.modal button{padding:6px 14px;border:none;background:#ffb6c1;color:#fff;border-radius:12px;cursor:pointer;font-weight:bold;width:100%;}

#zoomModal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;justify-content:center;align-items:center;flex-direction:column;z-index:10000;}
#zoomModal img{max-width:80%;max-height:60vh;border:4px solid #b67385;border-radius:24px;margin-bottom:10px;filter:none;}
#zoomModal .thumbs{display:flex;gap:8px;max-width:80%;overflow-x:auto;}
#zoomModal .thumbs img{width:50px;height:50px;object-fit:cover;border-radius:12px;border:2px solid #b67385;cursor:pointer;}
.closeZoom{position:absolute;top:12px;right:12px;width:28px;height:28px;background:#ffb6c1;color:#fff;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;}

#ownerPhoto{width:32px;height:32px;border-radius:50%;position:fixed;top:10px;right:10px;z-index:10000;background:#ffe6f0;border:2px solid #b84c6f;}
@media(max-width:480px){.page{grid-template-columns:repeat(2,120px);grid-template-rows:repeat(3,120px);}.visitor-item{width:120px;height:120px;}.modal .modal-box{min-width:180px;}}

.icon-btn svg {
  cursor: pointer;
  transition: transform 0.2s;
}
.icon-btn:hover svg {
  transform: scale(1.2);
}
.icon-btn span {
  font-weight: bold;
  color: #b84c6f;
  font-size: 14px;
}

  /* Bouton toujours visible */
.chat-icon-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 4px;
  display: flex;
  align-items: center;
}


/* ====== SURCOUCHE ====== */
.chat-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none; /* cach√© par d√©faut */
  justify-content: center;
  align-items: center;
  z-index: 20000;
}

/* ====== FEN√äTRE CHAT ====== */
.chat-window {
  width: 360px;  /* Petite modal */
  height: 230px;
  background: #ffe6f0;
  border-radius: 20px;
  border: 2px solid #b67385;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 12px 24px rgba(0,0,0,0.25);
  position: relative;
  transition: width 0.3s, height 0.3s;
}

/* ====== HEADER ====== */
.chat-header {
  height: 40px;
  background: linear-gradient(#ffd6e6, #ffb6c1);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 10px;
  font-weight: bold;
  color: #b84c6f;
  flex-shrink: 0;
  position: sticky;
  top: 0;
  z-index: 10;
  font-size: 14px;
}

/* ====== BODY ====== */
.chat-body {
  flex: 1;
  display: flex;
  min-height: 0;
}

/* ====== CONTACTS ====== */
.chat-sidebar {
  width: 120px;  /* r√©duit pour petite modal */
  background: #fff5fa;
  border-right: 2px solid #f3b3c8;
  overflow-y: auto;
}

.chat-user {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px;
  cursor: pointer;
  transition: background 0.2s;
  font-size: 12px;
}
.chat-user.active {
  background: #ffd6e6;
}
.chat-user img {
  border-radius: 50%;
  width: 28px;
  height: 28px;
  object-fit: cover;
}

/* ====== CONVERSATION ====== */
.chat-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.chat-messages {
  flex: 1;
  padding: 6px;
  overflow-y: auto;
  background: #fffafa;
  font-size: 12px;
}

.msg {
  max-width: 70%;
  padding: 4px 8px;
  margin-bottom: 4px;
  border-radius: 12px;
}

.msg-me {
  background: #ffb6c1;
  align-self: flex-end;
}
.msg-them {
  background: #ffffff;
  border: 1px solid #f3b3c8;
}

/* ====== INPUT ====== */
.chat-input {
  display: flex;
  padding: 4px;
  gap: 4px;
}
.chat-input input {
  flex: 1;
  border-radius: 10px;
  border: 2px solid #b67385;
  padding: 4px 6px;
  font-size: 12px;
}

/* ====== BOUTON ICON ====== */
.chat-icon-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 2px;
  display: flex;
  align-items: center;
}

/* ====== MODE AGRANDI ====== */
.expanded .chat-window {
  width: 720px;  /* double taille de la petite modal */
  height: 460px;
  border-radius: 24px;
}

#messagerieBtn{
  position: fixed;
  top: 10px;
  right: 50px; /* juste √† gauche de la photo profil */
  z-index: 10001;
}
  
</style>
</head>
<body>

<img id="ownerPhoto" alt="Owner">

<button id="messagerieBtn" class="chat-icon-btn" aria-label="Messagerie">
  <svg width="26" height="26" viewBox="0 0 24 24"
    fill="none" stroke="#b84c6f" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5
             a2 2 0 0 1 2-2h14
             a2 2 0 0 1 2 2z"/>
  </svg>
</button>
  
<div class="center-zone">
  <div id="visitor-list-container"></div>
</div>


<!-- Modals -->
<div id="addModal" class="modal">
  <div class="modal-box">
    <h2>Ajouter des photos</h2>
    <input id="photoName" placeholder="Nom du projet">
    <input type="file" id="multiPhoto" multiple>
    <button id="confirmAdd">Valider</button>
  </div>
</div>


<!-- ====== LIKE MODAL ====== -->
<div id="likeModal" class="modal">
  <div class="modal-box">
    <h3>Like ‚ù§Ô∏è</h3>
    <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
      <input type="text" id="likeName" readonly style="flex:1; padding:4px 8px; border:2px solid #b67385; border-radius:8px; background:#ffe6f0;">
    </div>
    <button id="confirmLike">Valider</button>
    <div class="bubble-container" id="likeBubbles" style="margin-top:12px; max-height:120px; overflow-y:auto;"></div>
  </div>
</div>

<!-- ====== COMMENT MODAL ====== -->
<div id="commentModal" class="modal">
  <div class="modal-box comment-box">
    <div class="expand-btn" id="expandComment">‚§¢</div>
    <h3>Commentaire üí¨</h3>
    <div class="comment-list" id="commentBubbles" style="max-height:160px; overflow-y:auto; margin-bottom:8px;"></div>
    <div style="display:flex; flex-direction:column; gap:6px;">
      <input type="text" id="commentName" readonly style="flex:1; padding:4px 8px; border:2px solid #b67385; border-radius:8px; background:#ffe6f0; margin-bottom:8px;">
      <input type="text" id="commentText" placeholder="Votre commentaire" style="padding:4px 8px; border:2px solid #b67385; border-radius:8px;">
      <button id="confirmComment">Envoyer</button>
    </div>
  </div>
</div>

<div id="zoomModal">
  <div class="closeZoom">√ó</div>
  <img id="mainZoom">
  <div class="thumbs" id="thumbs"></div>
  <div class="actions">
    <div class="actions" style="display:flex; gap:12px; align-items:center; margin-top:8px;">
  <div class="icon-btn" id="likeBtn" style="display:flex; align-items:center; cursor:pointer; gap:4px;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#b84c6f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 21C12 21 4 13.5 4 8.5C4 5.5 6.5 3 9.5 3C11 3 12 4 12 4C12 4 13 3 14.5 3C17.5 3 20 5.5 20 8.5C20 13.5 12 21 12 21Z"></path>
    </svg>
    <span id="likeCount">0</span>
  </div>

  <div class="icon-btn" id="commentBtn" style="display:flex; align-items:center; cursor:pointer; gap:4px;">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#b84c6f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span id="commentCount">0</span>
  </div>
</div>
  </div>
</div>

  
<!-- Modal Likes -->
<div id="likesModal" class="modal">
  <div class="modal-box" style="max-height:80vh; overflow-y:auto;">
    <h2>Likes</h2>
    <button id="chooseLikeBtn">Choisir individuellement</button>
    <button id="clearLikesBtn">Tout effacer</button>
    <div id="likesList"></div>
  </div>
</div>

<!-- Modal Commentaires -->
<div id="commentsModal" class="modal">
  <div class="modal-box" style="max-height:80vh; overflow-y:auto;">
    <h2>Commentaires</h2>
    <button id="chooseCommentBtn">Choisir individuellement</button>
    <button id="clearCommentsBtn">Tout effacer</button>
    <div id="commentsList"></div>
  </div>
</div>


<!-- Modal S√©lection Cr√©ations -->
<div id="selectCreationModal" class="modal">
  <div class="modal-box">
    <h3>S√©lectionner les cr√©ations</h3>
    <div id="selectCreationList" style="max-height:60vh;overflow-y:auto;display:flex;flex-direction:column;gap:6px;"></div>
    <button id="clearSelectedBtn">Tout effacer</button>
  </div>
</div>

<!-- ====== MESSAGERIE ====== -->
<div id="chatModal" class="chat-overlay">
  <div class="chat-window">

    <!-- HEADER -->
    <div class="chat-header">
      <span class="chat-title">Messagerie</span>

      <button id="toggleChatSize" class="chat-icon-btn" aria-label="Agrandir / R√©duire">
        <svg id="chatResizeIcon" width="20" height="20" viewBox="0 0 24 24"
          fill="none" stroke="#b84c6f" stroke-width="2" stroke-linecap="round">
          <path d="M4 9V4h5M20 15v5h-5M15 4h5v5M9 20H4v-5"/>
        </svg>
      </button>
    </div>

    <!-- BODY -->
    <div class="chat-body">

      <!-- CONTACTS -->
      <div class="chat-sidebar" id="chatUserList">
        <!-- Liste vide par d√©faut -->
      </div>

      <!-- CONVERSATION -->
      <div class="chat-content">
        <div class="chat-messages" id="chatMessages">
          <!-- Messages dynamiques -->
        </div>

        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="√âcrire un message‚Ä¶">
          <button id="sendMsgBtn">‚û§</button>
        </div>
      </div>

    </div>
  </div>
</div>
  <script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient(
  "https://jyhbamdcxmpveujjqjla.supabase.co",
  "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa"
);

// ====== OWNER AVATAR ======
const ownerPhoto = document.getElementById('ownerPhoto');
const prenom = localStorage.getItem('prenom');

async function loadOwnerPhoto(){
  if(!prenom) return;
  const {data,error} = await supabase.from('profiles').select('photo_url').eq('prenom',prenom).single();
  if(!error && data?.photo_url){ownerPhoto.src=data.photo_url;ownerPhoto.style.opacity='1';} 
  else{ownerPhoto.style.opacity='0.3';}
}
document.addEventListener('DOMContentLoaded', loadOwnerPhoto);
window.addEventListener('pageshow', loadOwnerPhoto);

// ====== VARIABLES ======
let creations=[];
let currentZoom=null;
let currentDelete=null;

const container=document.getElementById('visitor-list-container');
const addModal=document.getElementById('addModal');
const deleteModal=document.getElementById('deleteModal');
const zoomModal=document.getElementById('zoomModal');
const sidebar=document.getElementById('sidebar');
const mainZoom=document.getElementById('mainZoom');
const thumbs=document.getElementById('thumbs');
const likeCount=document.getElementById('likeCount');
const commentCount=document.getElementById('commentCount');
const likeModal=document.getElementById('likeModal');
const likeBubbles=document.getElementById('likeBubbles');
const confirmLike=document.getElementById('confirmLike');
const likeNameInput=document.getElementById('likeName');
const commentModal=document.getElementById('commentModal');
const confirmComment=document.getElementById('confirmComment');
const commentBubbles=document.getElementById('commentBubbles');
const commentNameInput=document.getElementById('commentName');
const commentTextInput=document.getElementById('commentText');

// ====== RENDER ======
function render(){
  container.innerHTML='';
  let page=null;
  creations.forEach((c,i)=>{
    if(i%6===0){page=document.createElement('div');page.className='page';container.appendChild(page);}
    const d=document.createElement('div');d.className='visitor-item';
    d.innerHTML=`<div class="placeholder">?</div><div class="delete-btn">√ó</div><p>${c.name}</p><img src="${c.imgUrl||''}">`;
    const img=d.querySelector('img');
    img.onload=()=>d.querySelector('.placeholder').style.display='none';
    img.onerror=()=>{img.remove();d.querySelector('.placeholder').textContent='';};
    img.onclick=()=>openZoom(c);
    d.querySelector('.delete-btn').onclick=()=>openDeleteModal(c);
    page.appendChild(d);
  });
}

// ====== ZOOM ======
function openZoom(c){
  currentZoom = creations.find(x => x.id === c.id);
  mainZoom.src = currentZoom.imgUrl;
  thumbs.innerHTML = '';
  (currentZoom.zoomGroup || []).forEach(u=>{
    const t=document.createElement('img'); t.src=u;
    t.onclick=()=>mainZoom.src=u;
    thumbs.appendChild(t);
  });
  updateActions();
  zoomModal.style.display='flex';
}

function updateActions(){
  if(!currentZoom) return;
  likeCount.textContent = (currentZoom.likes || []).length;
  commentCount.textContent = (currentZoom.comments || []).length;
}

// ====== LIKE MODAL ======
document.getElementById('likeBtn').onclick=()=>{
  if(!currentZoom){alert("S√©lectionnez d'abord une image !"); return;}
  likeNameInput.value = localStorage.getItem('prenom')||'';
  renderLikeList();
  likeModal.style.display='flex';
};

confirmLike.onclick=async()=>{
  if(!currentZoom) return;
  const name = likeNameInput.value.trim();
  if(!name) return;
  currentZoom.likes = currentZoom.likes||[];
  if(currentZoom.likes.some(l=>l.name===name)){likeModal.style.display='none'; return;}
  currentZoom.likes.push({name, photo: ownerPhoto.src||''});
  await supabase.from('creations').update({likes:currentZoom.likes}).eq('id',currentZoom.id);
  renderLikeList();
  likeCount.textContent = currentZoom.likes.length;
  likeModal.style.display='none';
};

// ====== COMMENT MODAL ======
document.getElementById('commentBtn').onclick=()=>{
  if(!currentZoom) return;
  commentNameInput.value = localStorage.getItem('prenom')||'';
  commentTextInput.value = '';
  renderCommentList();
  commentModal.style.display='flex';
};

confirmComment.onclick=async()=>{
  if(!currentZoom) return;
  const name = commentNameInput.value.trim();
  const text = commentTextInput.value.trim();
  if(!name||!text) return;
  currentZoom.comments = currentZoom.comments||[];
  currentZoom.comments.push({name, text, photo: ownerPhoto.src||''});
  await supabase.from('creations').update({comments:currentZoom.comments}).eq('id',currentZoom.id);
  renderCommentList();
  commentTextInput.value='';
  commentCount.textContent = currentZoom.comments.length;
};

// ====== RENDER LISTS ======
function renderLikeList(){
  if(!currentZoom) return;
  likeBubbles.innerHTML='';
  (currentZoom.likes||[]).forEach(l=>{
    const div=document.createElement('div');
    div.className='like-item';
    div.innerHTML=`${l.photo?`<img src="${l.photo}" style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;">`:''}<strong>${l.name}</strong>`;
    likeBubbles.appendChild(div);
  });
  likeCount.textContent = (currentZoom.likes||[]).length;
}

function renderCommentList(){
  if(!currentZoom) return;
  commentBubbles.innerHTML='';
  (currentZoom.comments||[]).forEach(c=>{
    const div=document.createElement('div');
    div.className='comment-item';
    div.innerHTML=`${c.photo?`<img src="${c.photo}" style="width:20px;height:20px;border-radius:50%;margin-right:4px;vertical-align:middle;">`:''}<strong>${c.name}</strong>: ${c.text}`;
    commentBubbles.appendChild(div);
  });
  commentCount.textContent = (currentZoom.comments||[]).length;
}


// ====== MODAL CLICS ======
[zoomModal, likeModal, commentModal, deleteModal].forEach(m=>{
  m.onclick=e=>{if(e.target===m)m.style.display='none';}
});
document.querySelector('.closeZoom').onclick=()=>zoomModal.style.display='none';

// ====== REFRESH CREATIONS (version tol√©rante pour likes) ======
async function refreshCreations() {
  try {
    const { data, error } = await supabase
      .from('creations')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error(error);
      return;
    }

    creations = data.map(c => {
      let zoomGroup = [];
      if (c.images?.length) {
        zoomGroup = c.images.map(p => {
          const { data } = supabase.storage.from('images').getPublicUrl(p);
          return data?.publicUrl || '';
        });
      } else if (c.image_path) {
        const { data } = supabase.storage.from('images').getPublicUrl(c.image_path);
        zoomGroup = [data?.publicUrl || ''];
      }

      // ‚úÖ Likes et commentaires s√©curis√©s
      let likesArray = [];
      if (Array.isArray(c.likes)) {
        likesArray = c.likes;
      } else if (typeof c.likes === 'string') {
        try {
          likesArray = JSON.parse(c.likes);
          if (!Array.isArray(likesArray)) likesArray = [];
        } catch (e) {
          likesArray = [];
        }
      }

      let commentsArray = [];
      if (Array.isArray(c.comments)) {
        commentsArray = c.comments;
      } else if (typeof c.comments === 'string') {
        try {
          commentsArray = JSON.parse(c.comments);
          if (!Array.isArray(commentsArray)) commentsArray = [];
        } catch (e) {
          commentsArray = [];
        }
      }

      return {
        id: c.id,
        name: c.name,
        imgUrl: zoomGroup[0] || '',
        zoomGroup,
        likes: likesArray.map(like => ({
          name: like.name || '',
          photo: like.photo || ''
        })),
        comments: commentsArray.map(cmt => ({
          name: cmt.name || '',
          text: cmt.text || '',
          photo: cmt.photo || ''
        }))
      };
    });

    render();
  } catch (err) {
    console.error('Erreur refreshCreations:', err);
  }
}

    const chatModal = document.getElementById('chatModal');
const toggleChatSize = document.getElementById('toggleChatSize');

// Ouvrir la modal
document.getElementById('messagerieBtn').onclick = () => {
  chatModal.style.display = 'flex';
};

// Fermer si clic hors fen√™tre
chatModal.addEventListener('click', e => {
  if (e.target === chatModal) chatModal.style.display = 'none';
});

// Bouton agrandir / r√©duire
toggleChatSize.onclick = () => {
  chatModal.classList.toggle('fullscreen');
};

// PINCH 2 doigts
let initialDistance = null;
chatModal.addEventListener('touchstart', e => {
  if (e.touches.length === 2) {
    initialDistance = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
  }
});

chatModal.addEventListener('touchmove', e => {
  if (e.touches.length === 2 && initialDistance) {
    const currentDistance = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    if (currentDistance - initialDistance > 40) {
  chatModal.classList.add('expanded');
}
if (initialDistance - currentDistance > 40) {
  chatModal.classList.remove('expanded');
}
  }
});

chatModal.addEventListener('touchend', () => {
  initialDistance = null;
});
    // ====== MESSAGERIE : AGRANDIR / R√âDUIRE ======
const icon = document.getElementById('chatResizeIcon');

toggleChatSize.onclick = () => {
  // bascule expanded
  chatModal.classList.toggle('expanded');

  // change l'ic√¥ne selon l'√©tat
  icon.innerHTML = chatModal.classList.contains('expanded')
    ? '<path d="M9 4H4v5M15 20h5v-5M20 9V4h-5M4 15v5h5"/>'
    : '<path d="M4 9V4h5M20 15v5h-5M15 4h5v5M9 20H4v-5"/>';
};
// ====== INITIAL ======
refreshCreations();
</script>


</body>
</html>
