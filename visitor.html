<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visitor</title>
<style>
* { box-sizing:border-box; margin:0; padding:0; font-family:'Comic Sans MS',cursive; }
html, body { height:100%; background:#fff0f5; }

/* OWNER PHOTO & MESSAGERIE */
#ownerPhoto {
  width:32px; height:32px; border-radius:50%; position:fixed; top:10px; right:50px;
  border:2px solid #b84c6f; background:#ffe6f0; display:none; z-index:1000;
}

#messagerieBtn {
  position:fixed; top:10px; right:10px;
  width:36px; height:36px; border-radius:50%; border:none; background:#ffb6c1;
  display:none; justify-content:center; align-items:center; cursor:pointer; z-index:1000;
}
#messagerieBtn svg { stroke:#fff; stroke-width:2; }

/* MESSAGERIE MODAL */
.chat-overlay {
  position: fixed; inset:0; background: rgba(0,0,0,0.4);
  display:none; justify-content:center; align-items:center; z-index:2000;
}
.chat-window {
  width:360px; height:230px;
  background:#ffe6f0; border-radius:20px; border:2px solid #b67385;
  display:flex; flex-direction:column; overflow:hidden; box-shadow:0 12px 24px rgba(0,0,0,0.25);
  transition: width 0.3s, height 0.3s;
}
.chat-header { height:40px; background:linear-gradient(#ffd6e6,#ffb6c1);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 10px; font-weight:bold; color:#b84c6f; flex-shrink:0; font-size:14px;
}
.chat-body { flex:1; display:flex; min-height:0; }
.chat-sidebar { width:120px; background:#fff5fa; border-right:2px solid #f3b3c8; overflow-y:auto; }
.chat-user { display:flex; align-items:center; gap:6px; padding:4px; cursor:pointer; font-size:12px; }
.chat-user.active { background:#ffd6e6; }
.chat-user img { border-radius:50%; width:28px; height:28px; object-fit:cover; }
.chat-content { flex:1; display:flex; flex-direction:column; min-height:0; }
.chat-messages { flex:1; padding:6px; overflow-y:auto; background:#fffafa; font-size:12px; }
.msg { max-width:70%; padding:4px 8px; margin-bottom:4px; border-radius:12px; }
.msg-me { background:#ffb6c1; align-self:flex-end; }
.msg-them { background:#ffffff; border:1px solid #f3b3c8; }
.chat-input { display:flex; padding:4px; gap:4px; }
.chat-input input { flex:1; border-radius:10px; border:2px solid #b67385; padding:4px 6px; font-size:12px; }
.chat-icon-btn { background:transparent; border:none; cursor:pointer; padding:2px; display:flex; align-items:center; }
.expanded .chat-window { width:720px; height:460px; border-radius:24px; }
</style>
</head>
<body>

<!-- Mini cercle profil -->
<img id="ownerPhoto" alt="Owner">

<!-- Bouton Messagerie -->
<button id="messagerieBtn" aria-label="Messagerie">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
</svg>
</button>

<!-- Messagerie modal -->
<div id="chatModal" class="chat-overlay">
  <div class="chat-window">
    <div class="chat-header">
      <span class="chat-title">Messagerie</span>
      <button id="toggleChatSize" class="chat-icon-btn">
        <svg id="chatResizeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#b84c6f" stroke-width="2" stroke-linecap="round">
          <path d="M4 9V4h5M20 15v5h-5M15 4h5v5M9 20H4v-5"/>
        </svg>
      </button>
    </div>
    <div class="chat-body">
      <div class="chat-sidebar" id="chatUserList"></div>
      <div class="chat-content">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Écrire un message…">
          <button id="sendMsgBtn">➤</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient("https://jyhbamdcxmpveujjqjla.supabase.co", "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa");

const ownerPhoto = document.getElementById('ownerPhoto');
const messagerieBtn = document.getElementById('messagerieBtn');
const chatModal = document.getElementById('chatModal');
const toggleChatSize = document.getElementById('toggleChatSize');
const icon = document.getElementById('chatResizeIcon');

// Afficher bouton Messagerie et mini cercle uniquement si connecté
const prenom = localStorage.getItem('prenom');
if(prenom){
  ownerPhoto.style.display='block';
  messagerieBtn.style.display='flex';
}

// Ouvrir modal
messagerieBtn.onclick = () => chatModal.style.display='flex';
chatModal.addEventListener('click', e => { if(e.target===chatModal) chatModal.style.display='none'; });

// Toggle petite/grande taille
toggleChatSize.onclick = () => {
  chatModal.classList.toggle('expanded');
  icon.innerHTML = chatModal.classList.contains('expanded')
    ? '<path d="M9 4H4v5M15 20h5v-5M20 9V4h-5M4 15v5h5"/>'
    : '<path d="M4 9V4h5M20 15v5h-5M15 4h5v5M9 20H4v-5"/>';
};

// Pinch pour mobile
let initialDistance=null;
chatModal.addEventListener('touchstart', e=>{ if(e.touches.length===2) initialDistance=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY); });
chatModal.addEventListener('touchmove', e=>{
  if(e.touches.length===2 && initialDistance){
    const currentDistance=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    if(currentDistance-initialDistance>30) chatModal.classList.add('expanded');
    if(initialDistance-currentDistance>30) chatModal.classList.remove('expanded');
  }
});
chatModal.addEventListener('touchend',()=>{ initialDistance=null; });

</script>

</body>
</html>
