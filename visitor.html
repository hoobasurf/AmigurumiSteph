<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visitor</title>

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Comic Sans MS',cursive;}
html,body{height:100%;overflow-x:hidden;}
body::before{
  content:"";position:fixed;inset:0;
  background:url('Photoroom_20251223_114401.jpeg') center/cover no-repeat;
  z-index:-1;
}

/* ===== CARDS ===== */
.center-zone{display:flex;justify-content:center;padding-top:3.5cm;}
#visitor-list-container{display:flex;overflow-x:auto;scroll-snap-type:x mandatory;padding-left:1cm;}
.page{display:grid;grid-template-columns:repeat(2,200px);grid-template-rows:repeat(3,200px);gap:4mm;scroll-snap-align:center;padding:4mm;}
.visitor-item{
  position:relative;width:200px;height:200px;border-radius:12px;overflow:hidden;
  border:3px solid #fff;
  box-shadow:0 0 0 3px #f6c2d1,0 6px 14px rgba(0,0,0,.25);
  background:#ffe6f0;
}
.visitor-item img{width:100%;height:100%;object-fit:cover;cursor:pointer;}
.visitor-item p{
  position:absolute;bottom:2px;width:100%;text-align:center;
  color:#b84c6f;font-weight:bold;
}
.placeholder{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  font-size:24px;color:#b84c6f;
}

/* ===== PROFIL + CHAT ===== */
#ownerPhoto{
  width:32px;height:32px;border-radius:50%;
  position:fixed;top:10px;right:10px;
  border:2px solid #b84c6f;z-index:10000;
}
#messagerieBtn{
  position:fixed;top:10px;right:50px;
  background:none;border:none;cursor:pointer;z-index:10001;
}

/* ===== ZOOM ===== */
#zoomModal{
  position:fixed;inset:0;background:rgba(0,0,0,.7);
  display:none;flex-direction:column;align-items:center;justify-content:center;
  z-index:10000;
}
#zoomModal img{max-width:80%;max-height:60vh;border-radius:24px;border:4px solid #b67385;}
.thumbs{display:flex;gap:8px;margin-top:8px;}
.thumbs img{width:50px;height:50px;border-radius:12px;border:2px solid #b67385;cursor:pointer;}
.closeZoom{
  position:absolute;top:12px;right:12px;
  width:28px;height:28px;border-radius:50%;
  background:#ffb6c1;color:#fff;display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}
.actions{display:flex;gap:12px;margin-top:8px;}
.icon-btn{display:flex;align-items:center;gap:4px;cursor:pointer;}
.icon-btn span{color:#b84c6f;font-weight:bold;}

/* ===== MODALS ===== */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:10001;
}
.modal-box{
  background:#ffe6f0;padding:16px 24px;border-radius:20px;
  border:3px solid #b67385;display:flex;flex-direction:column;gap:10px;
}
.modal input{
  padding:6px 10px;border-radius:10px;border:2px solid #b67385;
}
.modal button{
  padding:6px 14px;border:none;border-radius:12px;
  background:#ffb6c1;color:#fff;font-weight:bold;cursor:pointer;
}

/* ===== CHAT ===== */
.chat-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;justify-content:center;align-items:center;z-index:20000;}
.chat-window{width:360px;height:230px;background:#ffe6f0;border-radius:20px;border:2px solid #b67385;display:flex;flex-direction:column;}
.chat-header{height:40px;background:linear-gradient(#ffd6e6,#ffb6c1);display:flex;justify-content:space-between;align-items:center;padding:0 10px;color:#b84c6f;}
.chat-body{flex:1;display:flex;}
.chat-content{flex:1;display:flex;flex-direction:column;}
.chat-messages{flex:1;padding:6px;background:#fffafa;overflow-y:auto;}
.chat-input{display:flex;gap:4px;padding:4px;}
.chat-input input{flex:1;border-radius:10px;border:2px solid #b67385;padding:4px;}
.expanded .chat-window{width:720px;height:460px;}
</style>
</head>

<body>

<img id="ownerPhoto">
<button id="messagerieBtn">
<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#b84c6f" stroke-width="2">
<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
</svg>
</button>

<div class="center-zone">
  <div id="visitor-list-container"></div>
</div>

<!-- ZOOM -->
<div id="zoomModal">
  <div class="closeZoom">√ó</div>
  <img id="mainZoom">
  <div class="thumbs" id="thumbs"></div>
  <div class="actions">
    <div class="icon-btn" id="likeBtn">
      ‚ù§Ô∏è <span id="likeCount">0</span>
    </div>
    <div class="icon-btn" id="commentBtn">
      üí¨ <span id="commentCount">0</span>
    </div>
  </div>
</div>

<!-- LIKE -->
<div id="likeModal" class="modal">
  <div class="modal-box">
    <h3>Like ‚ù§Ô∏è</h3>
    <input id="likeName" readonly>
    <button id="confirmLike">Valider</button>
    <div id="likeBubbles"></div>
  </div>
</div>

<!-- COMMENT -->
<div id="commentModal" class="modal">
  <div class="modal-box">
    <h3>Commentaire üí¨</h3>
    <div id="commentBubbles"></div>
    <input id="commentName" readonly>
    <input id="commentText" placeholder="Votre commentaire">
    <button id="confirmComment">Envoyer</button>
  </div>
</div>

<!-- CHAT -->
<div id="chatModal" class="chat-overlay">
  <div class="chat-window">
    <div class="chat-header">
      Messagerie
      <button id="toggleChatSize">‚§¢</button>
    </div>
    <div class="chat-body">
      <div class="chat-content">
        <div class="chat-messages"></div>
        <div class="chat-input">
          <input placeholder="√âcrire‚Ä¶"><button>‚û§</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase=createClient("https://jyhbamdcxmpveujjqjla.supabase.co","sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa");

let creations=[],currentZoom=null;
const container=document.getElementById('visitor-list-container');
const zoomModal=document.getElementById('zoomModal');
const mainZoom=document.getElementById('mainZoom');
const thumbs=document.getElementById('thumbs');
const likeCount=document.getElementById('likeCount');
const commentCount=document.getElementById('commentCount');

function render(){
 container.innerHTML='';
 let page;
 creations.forEach((c,i)=>{
  if(i%6===0){page=document.createElement('div');page.className='page';container.appendChild(page);}
  const d=document.createElement('div');d.className='visitor-item';
  d.innerHTML=`<div class="placeholder">?</div><p>${c.name}</p><img src="${c.imgUrl}">`;
  d.querySelector('img').onclick=()=>openZoom(c);
  page.appendChild(d);
 });
}

function openZoom(c){
 currentZoom=c;
 mainZoom.src=c.imgUrl;
 thumbs.innerHTML='';
 c.zoomGroup.forEach(u=>{
  const t=document.createElement('img');t.src=u;t.onclick=()=>mainZoom.src=u;
  thumbs.appendChild(t);
 });
 likeCount.textContent=c.likes.length;
 commentCount.textContent=c.comments.length;
 zoomModal.style.display='flex';
}

document.querySelector('.closeZoom').onclick=()=>zoomModal.style.display='none';

async function refreshCreations(){
 const {data}=await supabase.from('creations').select('*').order('created_at',{ascending:false});
 creations=data.map(c=>{
  const urls=(c.images||[]).map(p=>supabase.storage.from('images').getPublicUrl(p).data.publicUrl);
  return {id:c.id,name:c.name,imgUrl:urls[0],zoomGroup:urls,likes:c.likes||[],comments:c.comments||[]};
 });
 render();
}
refreshCreations();

/* fermeture modals par clic vide */
['likeModal','commentModal'].forEach(id=>{
 const m=document.getElementById(id);
 m.onclick=e=>{if(e.target===m)m.style.display='none';};
});
</script>

</body>
</html>
