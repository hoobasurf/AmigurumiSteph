<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Actualit√©</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<style>
/* ====== RESET ====== */
* { box-sizing:border-box; margin:0; padding:0; font-family:'Comic Sans MS',cursive; }
html, body { height:100%; background:#ffe6f0; overflow-y:auto; }

/* ====== HEADER ====== */
header {
  position: sticky;
  top:0;
  background: linear-gradient(#ffd6e6,#ffb6c1);
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  color:#b84c6f;
  font-size:22px;
  border-bottom:2px solid #b67385;
  z-index:100;
}

/* ====== NEW POST BOX ====== */
#newPostBox {
  margin:16px auto;
  width:90%;
  background:rgba(255,245,250,0.8);
  backdrop-filter: blur(6px);
  border:2px solid #b67385;
  border-radius:16px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
#newPostBox textarea {
  width:100%;
  border-radius:12px;
  border:2px solid #b67385;
  padding:6px 10px;
  font-size:14px;
  resize:none;
  height:80px;
  background:#fff;
}
#newPostBox button {
  align-self:flex-end;
  background:#ffb6c1;
  border:none;
  color:#fff;
  font-weight:bold;
  border-radius:12px;
  padding:6px 12px;
  cursor:pointer;
  transition:transform 0.15s;
}
#newPostBox button:hover { transform: scale(1.05); }

/* ====== FEED ====== */
#feed {
  margin:16px auto;
  width:90%;
  display:flex;
  flex-direction:column;
  gap:16px;
}

/* ====== POST ====== */
.post {
  background:rgba(255,245,250,0.85);
  backdrop-filter: blur(6px);
  border:2px solid #b67385;
  border-radius:16px;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.post-header {
  display:flex;
  align-items:center;
  gap:8px;
}
.post-header img {
  width:32px;
  height:32px;
  border-radius:50%;
}
.post-header .name { font-weight:bold; color:#b84c6f; }

.post-content { font-size:14px; color:#b84c6f; }

.post-actions {
  display:flex;
  align-items:center;
  gap:16px;
}
.post-actions button {
  background:transparent;
  border:none;
  cursor:pointer;
  color:#b84c6f;
  font-weight:bold;
  display:flex;
  align-items:center;
  gap:4px;
  font-size:14px;
}
.post-actions button:hover { transform: scale(1.1); }

.comments {
  margin-top:8px;
  display:flex;
  flex-direction:column;
  gap:4px;
}
.comment {
  display:flex;
  align-items:center;
  gap:6px;
  font-size:13px;
  color:#b84c6f;
}
.comment img {
  width:24px;
  height:24px;
  border-radius:50%;
}

/* ====== MODALS ====== */
.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:1000;
}
.modal .modal-box {
  background:rgba(255,245,250,0.9);
  backdrop-filter: blur(8px);
  border:2px solid #b67385;
  border-radius:16px;
  padding:16px;
  width:90%;
  max-width:400px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

/* MODAL CLOSE */
.modal .closeModal {
  position:absolute;
  top:12px;
  right:12px;
  background:#ffb6c1;
  color:#fff;
  width:28px;
  height:28px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-weight:bold;
  font-size:18px;
}
</style>
</head>
<body>

<header>Actualit√©</header>

<!-- ====== NOUVEAU POST ====== -->
<div id="newPostBox">
  <textarea id="postInput" placeholder="Quoi de neuf ?"></textarea>
  <button id="postBtn">Publier</button>
</div>

<!-- ====== FEED ====== -->
<div id="feed"></div>

<!-- ====== MODAL LIKE / COMMENT ====== -->
<div id="likeCommentModal" class="modal">
  <div class="modal-box">
    <div class="closeModal">√ó</div>
    <h3 id="modalTitle">Likes / Commentaires</h3>
    <div id="modalContent" style="max-height:300px; overflow-y:auto;"></div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://jyhbamdcxmpveujjqjla.supabase.co",
  "sb_publishable_sqsxb-3Kl5o3-JQYv9kGFw_-g0EgwMa"
);

const myPrenom = localStorage.getItem('prenom') || 'Moi';
const ownerPhoto = localStorage.getItem('ownerPhoto') || 'icon-152.png';

const feed = document.getElementById('feed');
const postBtn = document.getElementById('postBtn');
const postInput = document.getElementById('postInput');
const modal = document.getElementById('likeCommentModal');
const modalContent = document.getElementById('modalContent');
const modalTitle = document.getElementById('modalTitle');
const closeModal = document.querySelector('.closeModal');

// ====== CHARGER POSTS ======
async function loadPosts() {
  const { data, error } = await supabase.from('posts').select('*').order('created_at',{ascending:false});
  if(error) return console.error(error);

  feed.innerHTML = '';
  data.forEach(post => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `
      <div class="post-header">
        <img src="${post.photo || ownerPhoto}">
        <span class="name">${post.name}</span>
      </div>
      <div class="post-content">${post.content}</div>
      <div class="post-actions">
        <button class="likeBtn">‚ù§Ô∏è <span>${post.likes?.length||0}</span></button>
        <button class="commentBtn">üí¨ <span>${post.comments?.length||0}</span></button>
      </div>
      <div class="comments"></div>
    `;

    // LIKE
    div.querySelector('.likeBtn').onclick = async () => {
      post.likes = post.likes||[];
      if(!post.likes.includes(myPrenom)) post.likes.push(myPrenom);
      await supabase.from('posts').update({likes:post.likes}).eq('id',post.id);
      loadPosts();
    };

    // COMMENT
    const commentBtn = div.querySelector('.commentBtn');
    const commentsDiv = div.querySelector('.comments');
    commentBtn.onclick = () => {
      modalTitle.textContent = "Commentaires";
      modalContent.innerHTML = '';
      (post.comments||[]).forEach(c=>{
        const cm = document.createElement('div');
        cm.className='comment';
        cm.innerHTML=`<img src="${c.photo||ownerPhoto}"> <strong>${c.name}</strong>: ${c.text}`;
        modalContent.appendChild(cm);
      });
      modal.style.display='flex';
    };

    // Afficher les commentaires en bas du post
    if(post.comments?.length){
      post.comments.forEach(c=>{
        const cm = document.createElement('div');
        cm.className='comment';
        cm.innerHTML=`<img src="${c.photo||ownerPhoto}"> <strong>${c.name}</strong>: ${c.text}`;
        commentsDiv.appendChild(cm);
      });
    }

    feed.appendChild(div);
  });
}

// ====== NOUVEAU POST ======
postBtn.onclick = async () => {
  const content = postInput.value.trim();
  if(!content) return;
  await supabase.from('posts').insert([{name:myPrenom,content,photo:ownerPhoto,likes:[],comments:[]}]);
  postInput.value='';
  loadPosts();
};

// ====== FERMER MODAL ======
closeModal.onclick=()=> modal.style.display='none';
modal.onclick=e=>{if(e.target===modal) modal.style.display='none';}

// ====== INIT ======
loadPosts();
</script>

</body>
</html>
